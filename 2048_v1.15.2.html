<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://pic3.zhimg.com/v2-7ccb1fc2625f8f8d2927a0371f3af244_720w.jpg?source=172ae18b">
    <title>2048 | æ ‡å‡†æ¨¡å¼ | ä¸­ç­‰ | 4Ã—4 | åˆ†æ•°: 0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet" crossorigin="anonymous">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#faa31b',
                        secondary: '#8f7a66',
                        bg: '#faf8ef',
                        grid: '#bbada0',
                        cellEmpty: '#cdc1b4',
                        easy: '#4CAF50',
                        medium: '#FFC107',
                        hard: '#F44336',
                        dark: {
                            bg: '#121212',
                            surface: '#1e1e1e',
                            primary: '#ffb74d',
                            secondary: '#a1887f',
                            grid: '#37474f',
                            cellEmpty: '#546e7a',
                            text: '#e0e0e0',
                            muted: '#9e9e9e',
                        }
                    },
                    fontFamily: {
                        game: ['"Clear Sans"', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <script>
        const themeToggle = document.getElementById('theme-toggle');
        if (themeToggle) {
            const isDarkMode = document.documentElement.classList.contains('dark');
            themeToggle.value = isDarkMode ? 'dark' : 'light';
        }
    </script>
    <style type="text/tailwindcss">
        .hidden { opacity: 0; visibility: hidden; transition: all 0.3s ease; } .modal-enter { opacity: 0; transform: scale(0.95); } .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.3s ease, transform 0.3s ease; } .modal-exit { opacity: 1; transform: scale(1); } .modal-exit-active { opacity: 0; transform: scale(0.95); transition: opacity 0.3s ease, transform 0.3s ease; } :host, html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .tile-2 { background-color: #eee4da; color: #776e65; }
            .tile-4 { background-color: #ede0c8; color: #776e65; }
            .tile-8 { background-color: #f2b179; color: #f9f6f2; }
            .tile-16 { background-color: #f59563; color: #f9f6f2; }
            .tile-32 { background-color: #f67c5f; color: #f9f6f2; }
            .tile-64 { background-color: #f65e3b; color: #f9f6f2; }
            .tile-128 { background-color: #edcf72; color: #f9f6f2; }
            .tile-256 { background-color: #edcc61; color: #f9f6f2; }
            .tile-512 { background-color: #edc850; color: #f9f6f2; }
            .tile-1024 { background-color: #edc53f; color: #f9f6f2; }
            .tile-2048 { background-color: #edc22e; color: #f9f6f2; }
            .tile-4096 { background-color: #e65100; color: #ffffff; }
            .tile-8192 { background-color: #bf360c; color: #ffffff; }
            .tile-16384 { background-color: #880e4f; color: #ffffff; }
            .tile-32768 { background-color: #4a148c; color: #ffffff; }
            .tile-super { background-color: #311b92; color: #ffffff; }
            .tile.gpu-accelerated { transform: translateZ(0); will-change: transform; }
            .dark .tile-2 { background-color: #424242; color: #e0e0e0; }
            .dark .tile-4 { background-color: #546e7a; color: #e0e0e0; }
            .dark .tile-8 { background-color: #ff8a65; color: #212121; }
            .dark .tile-16 { background-color: #ff7043; color: #212121; }
            .dark .tile-32 { background-color: #ff5722; color: #212121; }
            .dark .tile-64 { background-color: #f4511e; color: #212121; }
            .dark .tile-128 { background-color: #ffca28; color: #212121; }
            .dark .tile-256 { background-color: #ffc107; color: #212121; }
            .dark .tile-512 { background-color: #ffb300; color: #212121; }
            .dark .tile-1024 { background-color: #ffa000; color: #212121; }
            .dark .tile-2048 { background-color: #ff8f00; color: #212121; }
            .dark .tile-4096 { background-color: #e65100; color: #ffffff; }
            .dark .tile-8192 { background-color: #c62828; color: #ffffff; }
            .dark .tile-16384 { background-color: #ad1457; color: #ffffff; }
            .dark .tile-32768 { background-color: #6a1b9a; color: #ffffff; }
            .dark .tile-super { background-color: #4527a0; color: #ffffff; }
            .tile-appear {
                animation: appear 200ms ease-in-out;
            }
            .tile-merge {
                animation: merge 200ms ease-in-out;
            }
            @keyframes appear {
                0% { transform: scale(0.8); opacity: 0.8; }
                100% { transform: scale(1); opacity: 1; }
            }
            @keyframes merge {
                0% { transform: scale(1); }
                50% { transform: scale(1.2); }
                100% { transform: scale(1); }
            }
            .game-container {
                position: relative;
                padding: 16px;
                cursor: default;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                background: #bbada0;
                border-radius: 12px;
                width: 90vw;
                height: 90vw;
                max-width: 500px;
                max-height: 500px;
                -webkit-box-sizing: border-box;
                -moz-box-sizing: border-box;
                box-sizing: border-box;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
                margin: 0 auto;
                transition: background-color 0.3s ease;
            }
            .dark .game-container {
                background: #37474f;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            }
            .grid-container {
                position: absolute;
                z-index: 1;
                width: calc(100% - 32px);
                height: calc(100% - 32px);
            }
            .grid-row {
                display: flex;
                margin-bottom: 16px;
            }
            .grid-cell {
                margin-right: 16px;
                border-radius: 6px;
                background: rgba(238, 228, 218, 0.35);
                transition: background-color 0.3s ease;
            }
            .dark .grid-cell {
                background: rgba(84, 110, 122, 0.35);
            }
            .grid-cell:last-child {
                margin-right: 0;
            }
            .tile-container {
                position: absolute;
                z-index: 2;
                width: calc(100% - 32px);
                height: calc(100% - 32px);
            }
            .tile {
                position: absolute;
                border-radius: 6px;
                font-weight: bold;
                text-align: center;
                transition: 100ms ease-in-out;
                transition-property: transform, left, top;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                display: flex;
                align-items: center;
                justify-content: center;
                will-change: transform, left, top;
                transition: all 0.3s ease;
                font-size: clamp(1rem, 5vw, 2.5rem);
            }
            #theme-toggle, #theme-toggle option {
                font-family: 'Font Awesome 6 Free', sans-serif !important;
                font-weight: 900 !important;
                background-color: theme('colors.bg');
                color: theme('colors.secondary');
                border: 2px solid theme('colors.grid');
                padding: 0.5rem 2.5rem 0.5rem 1rem;
                border-radius: 8px;
                appearance: none;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' class='h-5 w-5' viewBox='0 0 20 20' fill='%238f7a66'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 0.7rem center;
                background-size: 1.2em;
                transition: all 0.2s ease;
            }
            #theme-toggle:hover {
                border-color: theme('colors.primary');
                box-shadow: 0 0 0 2px rgba(250, 163, 27, 0.2);
            }
            #theme-toggle:focus {
                outline: none;
                ring: 2px ring theme('colors.primary/50');
            }
            .dark #theme-toggle, .dark #theme-toggle option {
                background-color: theme('colors.dark.surface');
                color: theme('colors.dark.text');
                border-color: theme('colors.dark.grid');
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' class='h-5 w-5' viewBox='0 0 20 20' fill='%23e0e0e0'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            }
            .dark #theme-toggle:hover {
                border-color: theme('colors.dark.primary');
            }
            .grid-3x3 .grid-row {
                height: calc((100% - 32px) / 3);
            }
            .grid-3x3 .grid-cell {
                width: calc((100% - 32px) / 3);
            }
            .grid-3x3 .tile {
                width: calc((100% - 32px) / 3);
                height: calc((100% - 32px) / 3);
            }
            .grid-4x4 .grid-row {
                height: calc((100% - 48px) / 4);
            }
            .grid-4x4 .grid-cell {
                width: calc((100% - 48px) / 4);
            }
            .grid-4x4 .tile {
                width: calc((100% - 48px) / 4);
                height: calc((100% - 48px) / 4);
            }
            .grid-5x5 .grid-row {
                height: calc((100% - 64px) / 5);
            }
            .grid-5x5 .grid-cell {
                width: calc((100% - 64px) / 5);
            }
            .grid-5x5 .tile {
                width: calc((100% - 64px) / 5);
                height: calc((100% - 64px) / 5);
                font-size: clamp(0.8rem, 3vw, 2rem);
            }
            .grid-5x5 .tile-5digit {
                font-size: clamp(0.8rem, 2.2vw, 1.6rem);
            }
            .grid-4x4 .tile-5digit {
                font-size: clamp(1rem, 3vw, 2rem);
            }
            .grid-3x3 .tile[data-pos="0-0"] { left: 0%; top: 0%; }
            .grid-3x3 .tile[data-pos="1-0"] { left: calc(33.333% + 5.333px); top: 0%; }
            .grid-3x3 .tile[data-pos="2-0"] { left: calc(66.666% + 10.666px); top: 0%; }
            .grid-3x3 .tile[data-pos="0-1"] { left: 0%; top: calc(33.333% + 5.333px); }
            .grid-3x3 .tile[data-pos="1-1"] { left: calc(33.333% + 5.333px); top: calc(33.333% + 5.333px); }
            .grid-3x3 .tile[data-pos="2-1"] { left: calc(66.666% + 10.666px); top: calc(33.333% + 5.333px); }
            .grid-3x3 .tile[data-pos="0-2"] { left: 0%; top: calc(66.666% + 10.666px); }
            .grid-3x3 .tile[data-pos="1-2"] { left: calc(33.333% + 5.333px); top: calc(66.666% + 10.666px); }
            .grid-3x3 .tile[data-pos="2-2"] { left: calc(66.666% + 10.666px); top: calc(66.666% + 10.666px); }
            .grid-4x4 .tile[data-pos="0-0"] { left: 0%; top: 0%; }
            .grid-4x4 .tile[data-pos="1-0"] { left: calc(25% + 4px); top: 0%; }
            .grid-4x4 .tile[data-pos="2-0"] { left: calc(50% + 8px); top: 0%; }
            .grid-4x4 .tile[data-pos="3-0"] { left: calc(75% + 12px); top: 0%; }
            .grid-4x4 .tile[data-pos="0-1"] { left: 0%; top: calc(25% + 4px); }
            .grid-4x4 .tile[data-pos="1-1"] { left: calc(25% + 4px); top: calc(25% + 4px); }
            .grid-4x4 .tile[data-pos="2-1"] { left: calc(50% + 8px); top: calc(25% + 4px); }
            .grid-4x4 .tile[data-pos="3-1"] { left: calc(75% + 12px); top: calc(25% + 4px); }
            .grid-4x4 .tile[data-pos="0-2"] { left: 0%; top: calc(50% + 8px); }
            .grid-4x4 .tile[data-pos="1-2"] { left: calc(25% + 4px); top: calc(50% + 8px); }
            .grid-4x4 .tile[data-pos="2-2"] { left: calc(50% + 8px); top: calc(50% + 8px); }
            .grid-4x4 .tile[data-pos="3-2"] { left: calc(75% + 12px); top: calc(50% + 8px); }
            .grid-4x4 .tile[data-pos="0-3"] { left: 0%; top: calc(75% + 12px); }
            .grid-4x4 .tile[data-pos="1-3"] { left: calc(25% + 4px); top: calc(75% + 12px); }
            .grid-4x4 .tile[data-pos="2-3"] { left: calc(50% + 8px); top: calc(75% + 12px); }
            .grid-4x4 .tile[data-pos="3-3"] { left: calc(75% + 12px); top: calc(75% + 12px); }
            .grid-5x5 .tile[data-pos="0-0"] { left: 0%; top: 0%; }
            .grid-5x5 .tile[data-pos="1-0"] { left: calc(20% + 3.2px); top: 0%; }
            .grid-5x5 .tile[data-pos="2-0"] { left: calc(40% + 6.4px); top: 0%; }
            .grid-5x5 .tile[data-pos="3-0"] { left: calc(60% + 9.6px); top: 0%; }
            .grid-5x5 .tile[data-pos="4-0"] { left: calc(80% + 12.8px); top: 0%; }
            .grid-5x5 .tile[data-pos="0-1"] { left: 0%; top: calc(20% + 3.2px); }
            .grid-5x5 .tile[data-pos="1-1"] { left: calc(20% + 3.2px); top: calc(20% + 3.2px); }
            .grid-5x5 .tile[data-pos="2-1"] { left: calc(40% + 6.4px); top: calc(20% + 3.2px); }
            .grid-5x5 .tile[data-pos="3-1"] { left: calc(60% + 9.6px); top: calc(20% + 3.2px); }
            .grid-5x5 .tile[data-pos="4-1"] { left: calc(80% + 12.8px); top: calc(20% + 3.2px); }
            .grid-5x5 .tile[data-pos="0-2"] { left: 0%; top: calc(40% + 6.4px); }
            .grid-5x5 .tile[data-pos="1-2"] { left: calc(20% + 3.2px); top: calc(40% + 6.4px); }
            .grid-5x5 .tile[data-pos="2-2"] { left: calc(40% + 6.4px); top: calc(40% + 6.4px); }
            .grid-5x5 .tile[data-pos="3-2"] { left: calc(60% + 9.6px); top: calc(40% + 6.4px); }
            .grid-5x5 .tile[data-pos="4-2"] { left: calc(80% + 12.8px); top: calc(40% + 6.4px); }
            .grid-5x5 .tile[data-pos="0-3"] { left: 0%; top: calc(60% + 9.6px); }
            .grid-5x5 .tile[data-pos="1-3"] { left: calc(20% + 3.2px); top: calc(60% + 9.6px); }
            .grid-5x5 .tile[data-pos="2-3"] { left: calc(40% + 6.4px); top: calc(60% + 9.6px); }
            .grid-5x5 .tile[data-pos="3-3"] { left: calc(60% + 9.6px); top: calc(60% + 9.6px); }
            .grid-5x5 .tile[data-pos="4-3"] { left: calc(80% + 12.8px); top: calc(60% + 9.6px); }
            .grid-5x5 .tile[data-pos="0-4"] { left: 0%; top: calc(80% + 12.8px); }
            .grid-5x5 .tile[data-pos="1-4"] { left: calc(20% + 3.2px); top: calc(80% + 12.8px); }
            .grid-5x5 .tile[data-pos="2-4"] { left: calc(40% + 6.4px); top: calc(80% + 12.8px); }
            .grid-5x5 .tile[data-pos="3-4"] { left: calc(60% + 9.6px); top: calc(80% + 12.8px); }
            .grid-5x5 .tile[data-pos="4-4"] { left: calc(80% + 12.8px); top: calc(80% + 12.8px); }
            .btn-hover {
                transition: all 0.2s ease;
            }
            .btn-hover:hover {
                transform: translateY(-2px);
            }
            .btn-hover:active {
                transform: translateY(0);
            }
            .modal-enter {
                opacity: 0;
                transform: scale(0.95);
            }
            .modal-enter-active {
                opacity: 1;
                transform: scale(1);
                transition: opacity 200ms, transform 200ms;
            }
            .modal-exit {
                opacity: 1;
            }
            .modal-exit-active {
                opacity: 0;
                transition: opacity 200ms;
            }
            .dark .bg-bg {
                background-color: theme('colors.dark.bg');
            }
            .dark .text-secondary {
                color: theme('colors.dark.text');
            }
            .dark .text-secondary\/80 {
                color: theme('colors.dark.muted');
            }
            .dark .bg-grid {
                background-color: theme('colors.dark.grid');
            }
            .dark .bg-primary {
                background-color: #ff8f00;
            }
            .dark #resume-button { background-color: #ff8f00; }
            .dark #resume-button:hover { background-color: #e65100; }
            .dark .bg-secondary {
                background-color: #4527a0;
            }
            .dark #new-game { background-color: #ff8f00; }
            .dark #endless-mode { background-color: #4527a0; }
            .dark #new-game:hover { background-color: #e65100; }
            .dark #endless-mode:hover { background-color: #311b92; }
            .dark .bg-easy {
                background-color: theme('colors.easy');
            }
            .dark .bg-medium {
                background-color: theme('colors.medium');
            }
            .dark .bg-hard {
                background-color: theme('colors.hard');
            }
            .dark #grid-3x3 { background-color: #2e7d32; }
            .dark #grid-4x4 { background-color: #1565c0; }
            .dark #grid-5x5 { background-color: #6a1b9a; }
            .dark #grid-3x3:hover { background-color: #1b5e20; }
            .dark #grid-4x4:hover { background-color: #0d47a1; }
            .dark #grid-5x5:hover { background-color: #4a148c; }
            .dark .bg-easy { background-color: #2e7d32; }
            .dark .bg-medium { background-color: #ff8f00; }
            .dark .bg-hard { background-color: #c62828; }
            .dark .bg-easy:hover { background-color: #1b5e20; }
            .dark .bg-medium:hover { background-color: #e65100; }
            .dark .bg-hard:hover { background-color: #b71c1c; }
            .dark .ring-easy {
                --tw-ring-color: theme('colors.easy');
            }
            .dark .ring-medium {
                --tw-ring-color: theme('colors.medium');
            }
            .dark .ring-hard {
                --tw-ring-color: theme('colors.hard');
            }
            .dark .bg-white {
                background-color: theme('colors.dark.surface');
            }
            .dark .text-white {
                color: theme('colors.dark.text');
            }
            .dark .text-white\/70 {
                color: theme('colors.dark.muted');
            }
            .dark .focus:ring-primary\/50 {
                --tw-ring-color: theme('colors.dark.primary');
            }
            .dark .focus:ring-easy\/50 {
                --tw-ring-color: theme('colors.easy');
            }
            .dark .focus:ring-medium\/50 {
                --tw-ring-color: theme('colors.medium');
            }
            .dark .focus:ring-hard\/50 {
                --tw-ring-color: theme('colors.hard');
            }
            .dark .btn-hover {
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            }
            .dark .game-message {
                background-color: rgba(0, 0, 0, 0.7);
            }
            .compact-header {
                flex-direction: column !important;
                align-items: flex-start !important;
            }
            .compact-title, .compact-description, .compact-buttons {
                text-align: left !important;
                justify-content: flex-start !important;
            }
            .compact-title {
                font-size: clamp(2rem, 8vw, 3rem) !important;
            }
            .compact-stats {
                flex-direction: column !important;
                gap: 0.5rem !important;
                margin-top: 1rem !important;
                width: 100% !important;
            }
            .compact-stats .bg-grid {
                padding: 0.5rem !important;
            }
            .compact-stats .text-xs {
                font-size: 0.65rem !important;
            }
            .compact-stats .text-xl {
                font-size: 1.25rem !important;
            }
            .compact-buttons {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            .compact-buttons button {
                padding: 0.75rem !important;
                font-size: 0.9rem !important;
            }
            .compact-difficulty {
                gap: 0.5rem !important;
            }
            .compact-difficulty button {
                padding: 0.5rem !important;
                font-size: 0.85rem !important;
            }
            .compact-description {
                font-size: 0.8rem !important;
            }
            .compact-message .bg-white {
                padding: 1.5rem !important;
                max-width: 85% !important;
            }
            .compact-message h2 {
                font-size: 1.5rem !important;
            }
            .compact-message button {
                padding: 0.75rem !important;
                font-size: 0.9rem !important;
            }
            .markdown-content h1 {
                font-size: 1.75rem;
                font-weight: bold;
                margin-bottom: 1rem;
                color: theme('colors.primary');
            }
            .markdown-content h2 {
                font-size: 1.5rem;
                font-weight: bold;
                margin-top: 1.5rem;
                margin-bottom: 0.75rem;
                color: theme('colors.secondary');
            }
            .markdown-content h3 {
                font-size: 1.25rem;
                font-weight: bold;
                margin-top: 1rem;
                margin-bottom: 0.5rem;
            }
            .markdown-content p {
                margin-bottom: 1rem;
                line-height: 1.5;
            }
            .markdown-content ul {
                list-style-type: disc;
                padding-left: 1.5rem;
                margin-bottom: 1rem;
            }
            .markdown-content ol {
                list-style-type: decimal;
                padding-left: 1.5rem;
                margin-bottom: 1rem;
            }
            .markdown-content li {
                margin-bottom: 0.5rem;
            }
            .markdown-content a {
                color: theme('colors.primary');
                text-decoration: underline;
            }
            .markdown-content a:hover {
                text-decoration: none;
            }
            .markdown-content strong {
                font-weight: bold;
            }
            .markdown-content em {
                font-style: italic;
            }
            .markdown-content code {
                background-color: rgba(0, 0, 0, 0.05);
                padding: 0.2rem 0.4rem;
                border-radius: 4px;
                font-family: monospace;
            }
            .dark .markdown-content code {
                background-color: rgba(255, 255, 255, 0.1);
            }
            .markdown-content blockquote {
                border-left: 4px solid theme('colors.primary');
                padding-left: 1rem;
                margin-left: 0;
                margin-bottom: 1rem;
                color: theme('colors.secondary/80');
            }
            .dark .markdown-content blockquote {
                color: theme('colors.dark.text');
            }
            .dark .markdown-content {
                color: theme('colors.dark.text');
            }
            .markdown-content hr {
                border: 0;
                border-top: 1px solid theme('colors.secondary/20');
                margin: 1.5rem 0;
            }
            .dark .markdown-content hr {
                border-top: 1px solid theme('colors.dark.muted/20');
            }
            .markdown-content .emoji {
                font-family: 'Apple Color Emoji', 'Segoe UI Emoji', 'NotoColorEmoji', 'Segoe UI Symbol', 'Android Emoji', 'EmojiSymbols';
            }
            .options-container {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                margin-bottom: 1rem;
            }
            .options-row {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                align-items: center;
            }
            .option-label {
                font-size: 0.85rem;
                color: theme('colors.secondary/80');
                white-space: nowrap;
                flex-shrink: 0;
            }
            .dark .option-label {
                color: theme('colors.dark.muted');
            }
            .option-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                flex: 1;
            }
            @media (max-width: 400px) {
                .options-row {
                    flex-direction: column;
                    align-items: flex-start;
                }
                .option-label {
                    margin-bottom: 0.25rem;
                }
                .option-buttons {
                    width: 100%;
                }
            }
            @media (max-width: 770px) {
                #game-header {
                    @apply compact-header;
                }
                #game-title {
                    @apply compact-title;
                }
                #game-header p {
                    @apply compact-description;
                }
            }
        }
        @media (max-width: 180px) {
            .button-text {
                display: none;
            }
            #undo-button .mr-1, #pause-button .mr-1 {
                margin-right: 0 !important;
            }
        }
        @media (max-width: 120px) {
            .prefix-text, .mode-text { display: none; }
            .icon-margin { margin-right: 0; }
        }
        @media (max-width: 140px) {
            .mode-text {
                display: none;
            }
            #new-game .mr-2, #endless-mode .mr-2 {
                margin-right: 0.5rem !important;
            }
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #bbb;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #999;
        }
        .dark ::-webkit-scrollbar-track {
            background: #333;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #666;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        .dark .setting-label {
            color: #e0e0e0;
        }
        @media (max-width: 200px){
            .hide-small{
                display:none;
            }
        }
        @media (max-width: 170px){
            .settings-text{
                display:none;
            }
            #close-settings-button{
                right: 15px;
            }
        }
        @media (max-width: 160px){
            .text-content{
                display:none;
            }
        }
    </style>
</head>
<body class="bg-bg font-game min-h-screen flex flex-col items-center justify-center p-4 transition-colors duration-300">
    <div class="max-w-md w-full mx-auto">
        <header id="game-header" class="flex flex-col md:flex-row justify-between items-center mb-6">
            <div>
                <h1 id="game-title" class="text-[clamp(2.5rem,5vw,3.5rem)] font-bold text-secondary dark:text-dark-text mb-1 tracking-tight">2048</h1>
                <p class="text-[clamp(1rem,2vw,1.2rem)] text-secondary/80 dark:text-dark-muted">æ»‘åŠ¨åˆå¹¶æ–¹å—ï¼Œåˆ›å»º<span class="font-bold">2048</span>ï¼</p>
            </div>
            <div class="flex gap-2 mt-4 md:mt-0">
                <button id="undo-button" class="bg-grid hover:bg-grid/80 text-white p-2 rounded-md shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none dark:bg-dark-grid" title="æ’¤é”€ä¸Šä¸€æ­¥">
                    <i class="fa-solid fa-undo mr-1"></i><span class="button-text">æ’¤é”€</span>
                </button>
                <button id="pause-button" class="bg-grid hover:bg-grid/80 text-white p-2 rounded-md shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none dark:bg-dark-grid" title="æš‚åœæ¸¸æˆ">
                    <i class="fa-solid fa-pause mr-1"></i><span class="button-text">æš‚åœ</span>
                </button>
            </div>
        </header>
        <div id="game-buttons" class="flex flex-wrap gap-2 mb-4">
            <button id="new-game" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-6 rounded-md shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary/50 flex-1 btn-hover dark:bg-dark-primary">
                <i class="fa-solid fa-gamepad mr-2"></i><span class="prefix-text">æ ‡å‡†</span><span class="mode-text">æ¨¡å¼</span>
            </button>
            <button id="endless-mode" class="bg-secondary hover:bg-secondary/90 text-white font-bold py-3 px-6 rounded-md shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-secondary/50 flex-1 btn-hover dark:bg-dark-secondary">
                <i class="fa-solid fa-infinity mr-2"></i><span class="prefix-text">æ— å°½</span><span class="mode-text">æ¨¡å¼</span>
            </button>
        </div>
        <div class="options-container mb-4">
            <div class="options-row">
                <span class="option-label">ç½‘æ ¼å¤§å°:</span>
                <div class="option-buttons">
                    <button id="grid-3x3" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-300 btn-hover">
                        <i class="fa-solid fa-square-three"></i>3Ã—3
                    </button>
                    <button id="grid-4x4" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-300 btn-hover active">
                        <i class="fa-solid fa-square-four"></i>4Ã—4
                    </button>
                    <button id="grid-5x5" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-300 btn-hover">
                        <i class="fa-solid fa-square-five"></i>5Ã—5
                    </button>
                </div>
            </div>
            <div class="options-row">
                <span class="option-label">éš¾åº¦é€‰æ‹©:</span>
                <div class="option-buttons">
                    <button id="easy-mode" class="bg-easy hover:bg-easy/90 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-easy/50 flex-1 btn-hover">
                        <i class="fa-solid fa-shield-check mr-2"></i>ç®€å•
                    </button>
                    <button id="medium-mode" class="bg-medium hover:bg-medium/90 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-medium/50 flex-1 btn-hover active">
                        <i class="fa-solid fa-shield-half mr-2"></i>ä¸­ç­‰
                    </button>
                    <button id="hard-mode" class="bg-hard hover:bg-hard/90 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-hard/50 flex-1 btn-hover">
                        <i class="fa-solid fa-shield-exclamation mr-2"></i>å›°éš¾
                    </button>
                </div>
            </div>
        </div>
        <div class="stats-container flex justify-between mb-4">
            <div class="bg-grid dark:bg-dark-grid text-center rounded-md p-3 flex-1 mr-2">
                <div class="text-xs uppercase text-white/70 dark:text-dark-muted">åˆ†æ•°</div>
                <div id="score" class="text-xl font-bold text-white dark:text-dark-text">0</div>
            </div>
            <div class="bg-grid dark:bg-dark-grid text-center rounded-md p-3 flex-1">
                <div class="text-xs uppercase text-white/70 dark:text-dark-muted">æœ€é«˜åˆ†</div>
                <div id="best-score" class="text-xl font-bold text-white dark:text-dark-text">0</div>
            </div>
        </div>
        <div class="text-secondary/80 dark:text-dark-muted mb-2" id="mode-description">
            å½“å‰æ¨¡å¼ï¼šæ ‡å‡†æ¨¡å¼ - è¾¾åˆ°2048è·èƒœ
        </div>
        <div id="difficulty-description" class="text-secondary/80 dark:text-dark-muted mb-4">
            å½“å‰éš¾åº¦ï¼šä¸­ç­‰ - 4x4ç½‘æ ¼
        </div>
        <div class="game-container grid-4x4" id="game-container">
            <div class="grid-container" id="grid-container"></div>
            <div class="tile-container" id="tile-container"></div>
        </div>
        <div id="game-touch-area" class="mt-4 h-5 bg-transparent"></div>
        <div id="game-message" class="fixed inset-0 flex items-center justify-center bg-black/50 z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-md w-full text-center shadow-xl transform transition-all duration-300 scale-95 opacity-0">
                <h2 id="game-message-title" class="text-2xl font-bold text-secondary mb-4">æ­å–œä½ è·èƒœï¼</h2>
                <p id="game-message-text" class="text-secondary/80 mb-6">ä½ è¾¾åˆ°äº†2048åˆ†ï¼Œå¯ä»¥ç»§ç»­æ¸¸æˆæŒ‘æˆ˜æ›´é«˜åˆ†æ•°ï¼Œæˆ–è€…é‡æ–°å¼€å§‹ã€‚</p>
                <button id="game-message-button" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-6 rounded-md shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary/50">
                    <i class="fa-solid fa-refresh mr-2"></i>å†ç©ä¸€æ¬¡
                </button>
            </div>
        </div>
        <div id="pause-menu" class="fixed inset-0 flex items-center justify-center bg-black/50 z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-md w-full text-center shadow-xl transform transition-all duration-300 scale-95 opacity-0">
                <h2 class="text-2xl font-bold text-secondary mb-4">æ¸¸æˆæš‚åœ</h2>
                <div class="flex flex-col gap-3">
                    <button id="resume-button" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-6 rounded-md shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary/50">
                        <i class="fa-solid fa-play mr-2"></i><span class="text-content">ç»§ç»­<span class="hide-small">æ¸¸æˆ</span></span>
                    </button>
                    <button id="restart-button" class="bg-secondary hover:bg-secondary/90 text-white font-bold py-3 px-6 rounded-md shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-secondary/50">
                        <i class="fa-solid fa-refresh mr-2"></i><span class="text-content">é‡<span class="hide-small">æ–°</span>å¼€<span class="hide-small">å§‹</span></span>
                    </button>
                    <div class="flex justify-center gap-4 mt-2">
                        <button id="settings-button" class="text-primary hover:text-primary/80 focus:outline-none text-sm">
                            <i class="fa-solid fa-cog mr-1"></i><span class="text-content">è®¾ç½®</span>
                        </button>
                        <button id="help-button" class="text-primary hover:text-primary/80 focus:outline-none text-sm">
                            <i class="fa-solid fa-question mr-1"></i><span class="text-content">å¸®åŠ©</span>
                        </button>
                     </div>
                </div>
            </div>
        </div>
        <div id="settings-modal" class="fixed inset-0 flex items-center justify-center bg-black/50 z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-md w-full text-center shadow-xl transform transition-all duration-300 scale-95 opacity-0">
                <h2 class="text-2xl font-bold text-secondary mb-4">è®¾ç½®</h2>
                <div class="flex flex-col gap-3">
                    <button id="data-transfer-button" class="bg-secondary hover:bg-secondary/90 text-white font-bold py-3 px-6 rounded-md shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-secondary/50">
                        <i class="fa-solid fa-exchange-alt mr-2"></i><span class="settings-text">å¯¼å…¥/å¯¼å‡ºæ•°æ®</span>
                    </button>
                    <button id="reset-settings-button" class="bg-secondary hover:bg-secondary/90 text-white font-bold py-3 px-6 rounded-md shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-secondary/50">
                        <i class="fa-solid fa-rotate-right mr-2"></i><span class="settings-text">é‡ç½®æ‰€æœ‰è®¾ç½®</span>
                    </button>
                    <div class="flex items-center justify-between mt-2 mb-2 px-2">
                        <span class="text-gray-700 dark:text-dark-muted">GPUåŠ é€Ÿ</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="gpu-acceleration" class="sr-only peer" checked title="GPUåŠ é€Ÿ">
                            <div class="w-11 h-6 bg-gray-300 dark:bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <div class="flex items-center justify-between mt-2 mb-2 px-2">
                        <label for="theme-toggle" class="text-gray-700 dark:text-dark-muted">å¤–è§‚</label>
                        <select id="theme-toggle" class="bg-grid text-gray-800 dark:text-white p-2 rounded-md shadow-md transition-all duration-200 focus:outline-none dark:bg-dark-grid" title="é€‰æ‹©å¤–è§‚">
                            <option value="light">&#xf185; æµ…è‰²</option>
                            <option value="dark">&#xf186; æ·±è‰²</option>
                        </select>
                    </div>
                    <div class="text-sm text-secondary/70 mt-4"><i>2048 v1.15.2 | by <a href="https://github.com/FurinaY" class="text-primary hover:underline" target="_blank">FurinaY</a></i></div>
                    <button id="close-settings-button" class="text-secondary/60 hover:text-secondary focus:outline-none absolute top-5 right-8 text-xl" title="å…³é—­è®¾ç½®">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
        <div id="help-modal" class="fixed inset-0 flex items-center justify-center bg-black/50 z-50 hidden modal-enter">
            <div class="bg-white rounded-lg p-6 max-w-md w-full max-h-[90vh] overflow-y-auto shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-secondary">æ¸¸æˆä»‹ç»</h2>
                    <button id="close-help" class="text-secondary/60 hover:text-secondary focus:outline-none" title="å…³é—­å¸®åŠ©">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <div class="markdown-content">
                    <p>2048 æ˜¯ä¸€æ¬¾æµè¡Œçš„æ•°å­—æ‹¼å›¾æ¸¸æˆï¼Œç©å®¶é€šè¿‡æ»‘åŠ¨æ•°å­—æ–¹å—æ¥åˆå¹¶ç›¸åŒçš„æ•°å­—ï¼Œæœ€ç»ˆåˆ›å»ºå‡º 2048 è¿™ä¸ªæ•°å­—ã€‚</p>
                    <h2>æ¸¸æˆè§„åˆ™</h2>
                    <ul>
                        <li>ä½¿ç”¨é”®ç›˜æ–¹å‘é”®æˆ–åœ¨è§¦æ‘¸å±ä¸Šæ»‘åŠ¨ï¼Œå³å¯ç§»åŠ¨æ–¹å—</li>
                        <li>ç›¸åŒæ•°å­—çš„æ–¹å—åœ¨ç§»åŠ¨åç›¸é‡ä¼šåˆå¹¶æˆå®ƒä»¬çš„å’Œ</li>
                        <li>æ¯æ¬¡ç§»åŠ¨åä¼šéšæœºç”Ÿæˆä¸€ä¸ªæ–°çš„ 2 æˆ– 4</li>
                        <li>å½“æ— æ³•è¿›è¡Œä»»ä½•ç§»åŠ¨æ—¶æ¸¸æˆç»“æŸ</li>
                        <li>åˆ›å»ºå‡º 2048 æ–¹å—å³å¯è·èƒœï¼ˆæ ‡å‡†æ¨¡å¼ï¼‰</li>
                    </ul>
                    <h2>æ¸¸æˆæ¨¡å¼</h2>
                    <ul>
                        <li><strong>æ ‡å‡†æ¨¡å¼</strong>: ç›®æ ‡æ˜¯åˆ›å»ºå‡º 2048 æ–¹å—</li>
                        <li><strong>æ— å°½æ¨¡å¼</strong>: æ²¡æœ‰ç›®æ ‡åˆ†æ•°ï¼Œå¯ä»¥ç»§ç»­æ¸¸æˆæŒ‘æˆ˜æ›´é«˜åˆ†æ•°</li>
                    </ul>
                    <h2>éš¾åº¦è®¾ç½®</h2>
                    <ul>
                        <li><strong>ç®€å•</strong>: æ›´å®¹æ˜“ç”Ÿæˆ 4ï¼ˆçº¦ 40% çš„æ¦‚ç‡ï¼‰</li>
                        <li><strong>ä¸­ç­‰</strong>: æ ‡å‡†éš¾åº¦ï¼Œç”Ÿæˆ 4 çš„æ¦‚ç‡ä¸º 10%</li>
                        <li><strong>å›°éš¾</strong>: æ›´éš¾ç”Ÿæˆ 4ï¼ˆçº¦ 5% çš„æ¦‚ç‡ï¼‰ï¼Œä½†åˆå¹¶å¾—åˆ†æ›´é«˜</li>
                    </ul>
                    <h2>æ“ä½œæç¤º</h2>
                    <ul>
                        <li>æŒ‰ <kbd>P</kbd> æˆ– <kbd>ESC</kbd> é”®æš‚åœæ¸¸æˆ</li>
                        <li>ç‚¹å‡» <i class="fa-solid fa-undo"></i> æŒ‰é’®æˆ–æŒ‰ <code><kbd>Ctrl + Z</kbd></code> æ’¤é”€ä¸Šä¸€æ­¥æ“ä½œï¼ˆæœ€å¤šå¯æ’¤é”€ 10 æ­¥ï¼‰</li>
                        <li>æ”¯æŒé”®ç›˜å’Œè§¦æ‘¸å±æ“ä½œ</li>
                        <li>æ¸¸æˆè¿›åº¦ä¼šè‡ªåŠ¨ä¿å­˜</li>
                        <li>æ”¯æŒå¯¼å…¥/å¯¼å‡ºæ¸¸æˆæ•°æ®</li>
                    </ul>
                    <h2>æŠ€å·§ä¸ç­–ç•¥</h2>
                    <ul>
                        <li>å°½é‡ä¿æŒä¸€ä¸ªè§’è½ä½œä¸ºé«˜æ•°å­—çš„å­˜æ”¾ç‚¹</li>
                        <li>å°è¯•åˆ›å»ºä¸€ä¸ªé€’å¢çš„æ•°å­—åºåˆ—</li>
                        <li>é¿å…åœ¨ä¸­é—´ä½ç½®åˆå¹¶æ•°å­—</li>
                        <li>ä¼˜å…ˆä½¿ç”¨ä¸¤ä¸ªæ–¹å‘è¿›è¡Œç§»åŠ¨ï¼ˆä¾‹å¦‚ä¸Šä¸‹æˆ–å·¦å³ï¼‰</li>
                    </ul>
                    <p>ç¥ä½ æ¸¸æˆæ„‰å¿«ï¼ ğŸ®</p>
                    <i><strong>P.S.</strong> åœ¨2048æ¸¸æˆä¸­ï¼Œç†è®ºæœ€é«˜å€¼åˆ†åˆ«ä¸ºï¼š3Ã—3æ£‹ç›˜ <strong>4096</strong>ï¼Œ4Ã—4æ£‹ç›˜ <strong>131072</strong>ï¼Œ5Ã—5æ£‹ç›˜ <strong>2097152</strong>ã€‚åˆç†è§„åˆ’åˆå¹¶è·¯å¾„ï¼Œä¼˜å…ˆå‘è§’è½ç´¯ç§¯å¤§æ•°ï¼Œå¯æé«˜è¾¾æˆé«˜åˆ†çš„æ¦‚ç‡ï¼</i>
                </div>
            </div>
        </div>
        <div id="data-transfer-modal" class="fixed inset-0 flex items-center justify-center bg-black/50 z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-md w-full text-center shadow-xl transform transition-all duration-300 scale-95 opacity-0">
                <h2 class="text-2xl font-bold text-secondary mb-4">æ•°æ®ç®¡ç†</h2>
                <div class="flex flex-col gap-3 mb-4">
                    <button id="export-data-button" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-6 rounded-md shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary/50">
                        <i class="fa-solid fa-download mr-2"></i>å¯¼å‡ºæ•°æ®
                    </button>
                    <button id="import-data-button" class="bg-secondary hover:bg-secondary/90 text-white font-bold py-3 px-6 rounded-md shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-secondary/50">
                        <i class="fa-solid fa-upload mr-2"></i>å¯¼å…¥æ•°æ®
                    </button>
                </div>
                <textarea id="data-textarea" class="w-full p-3 border border-gray-300 rounded-md mb-4 h-32 text-sm dark:bg-dark-surface dark:border-dark-muted dark:text-dark-text" placeholder="åœ¨æ­¤ç²˜è´´å¯¼å‡ºçš„æ•°æ®æˆ–è¾“å…¥è¦å¯¼å…¥çš„æ•°æ®..."></textarea>
                <button id="close-data-modal" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray/50">
                    <i class="fa-solid fa-times mr-2"></i>å…³é—­
                </button>
            </div>
        </div>
        <footer class="mt-6 py-3 text-center text-secondary/50 dark:text-dark-muted/50 text-base">
            <p><i class="fa-solid fa-cube mr-2"></i>æ»‘åŠ¨ä¹‹é—´ æ•°å­—æ–°ç”Ÿ</p>
        </footer>
    </div>
    <script>
        const config = { // æ¸¸æˆé…ç½®
            initialTiles: 2, // åˆå§‹ç”Ÿæˆçš„æ–¹å—æ•°é‡
            winningValue: 2048, // è·èƒœç›®æ ‡å€¼
            touchThreshold: 10, // è§¦æ‘¸æ»‘åŠ¨çš„æœ€å°è·ç¦»
            maxUndoSteps: 10, // æœ€å¤§æ’¤é”€æ­¥æ•°
            difficultySettings: {
                easy: { // ç®€å•
                    fourProbability: 0.4, // 4å‡ºç°çš„æ¦‚ç‡ä¸º40%
                    scoreMultiplier: 1 // å¾—åˆ†ä¹˜æ•°
                },
                medium: { // ä¸­ç­‰
                    fourProbability: 0.1, // 4å‡ºç°çš„æ¦‚ç‡ä¸º10%
                    scoreMultiplier: 1 // å¾—åˆ†ä¹˜æ•°
                },
                hard: { // å›°éš¾
                    fourProbability: 0.05, // 4å‡ºç°çš„æ¦‚ç‡ä¸º5%
                    scoreMultiplier: 1.5 // å¾—åˆ†ä¹˜æ•°
                }
            }
        };
        const gameState = {
            gpuAccelerationEnabled: localStorage.getItem('2048-gpu-acceleration') !== 'false',
            grid: [],
            gridSize: 4,
            score: 0,
            bestScore: 0,
            gameOver: false,
            gameWon: false,
            isEndlessMode: false,
            isPaused: false,
            difficulty: 'medium',
            history: [],
            touchStartX: 0,
            touchStartY: 0,
            touchEndX: 0,
            touchEndY: 0
        };
        function showModal(modalId) { const modal = document.getElementById(modalId); if (modal) { modal.classList.remove('hidden'); setTimeout(() => { modal.querySelector('div').classList.remove('scale-95', 'opacity-0'); modal.querySelector('div').classList.add('scale-100', 'opacity-100'); }, 10); } }
        function hideModal(modalId) { const modal = document.getElementById(modalId); if (modal) { modal.querySelector('div').classList.remove('scale-100', 'opacity-100'); modal.querySelector('div').classList.add('scale-95', 'opacity-0'); setTimeout(() => { modal.classList.add('hidden'); }, 300); } }
        function exportGameData() { const data = { grid: gameState.grid, score: gameState.score, bestScore: gameState.bestScore, gridSize: gameState.gridSize, difficulty: gameState.difficulty, isEndlessMode: gameState.isEndlessMode, timestamp: new Date().toISOString() }; const dataStr = btoa(JSON.stringify(data)); document.getElementById('data-textarea').value = dataStr; }
        function checkGameState() { if (gameState.gameOver) { console.log('æ¸¸æˆå·²ç»“æŸ'); } if (gameState.gameWon) { console.log('æ¸¸æˆå·²è·èƒœ'); } } function importGameData(dataStr) { try { if (!dataStr) throw new Error('æ•°æ®ä¸èƒ½ä¸ºç©º'); let decodedData; try { decodedData = atob(dataStr); } catch (e) { throw new Error('æ— æ•ˆçš„Base64æ ¼å¼'); } let data; try { data = JSON.parse(decodedData); } catch (e) { throw new Error('JSONè§£æå¤±è´¥ï¼š' + e.message); } if (!data || typeof data !== 'object') throw new Error('æ•°æ®å¿…é¡»æ˜¯æœ‰æ•ˆçš„JSONå¯¹è±¡'); const requiredFields = ['grid', 'score', 'bestScore', 'gridSize', 'difficulty', 'isEndlessMode']; const missingFields = requiredFields.filter(field => !(field in data)); if (missingFields.length > 0) throw new Error('ç¼ºå°‘å¿…è¦å­—æ®µï¼š' + missingFields.join(', ')); if (!Array.isArray(data.grid) || data.grid.length === 0) throw new Error('æ— æ•ˆçš„æ¸¸æˆç½‘æ ¼æ•°æ®');
        console.log('å¯¼å…¥æ•°æ®çš„ grid é•¿åº¦:', data.grid.length, 'gridSize:', data.gridSize);
        if (data.grid.length !== data.gridSize || data.grid.some(row => row.length !== data.gridSize)) { console.log('ç½‘æ ¼å¤§å°æ£€æŸ¥å¤±è´¥ï¼Œgrid é•¿åº¦:', data.grid.length, 'grid è¡Œé•¿åº¦:', data.grid.map(row => row.length), 'gridSize:', data.gridSize);
            throw new Error('å¯¼å…¥çš„æ»‘å—æ•°å­—æŒ‡ç¤ºçš„ç½‘æ ¼å¤§å°ä¸å¯¼å…¥æ•°æ®æŒ‡ç¤ºçš„ç½‘æ ¼å¤§å°ä¸ä¸€è‡´');
        }
        console.log('å¼€å§‹æ£€æŸ¥æ»‘å—æ•°å­—æ˜¯å¦ä¸º2çš„æ¬¡å¹‚');
        const invalidTiles = data.grid.flatMap(row => row.filter(tile => tile && (tile.value <= 0 || (tile.value & (tile.value - 1)) !== 0)));
        console.log('æ— æ•ˆçš„æ»‘å—æ•°å­—:', invalidTiles.map(tile => tile.value));
        if (invalidTiles.length > 0) {
            console.log('æ£€æµ‹åˆ°æ— æ•ˆçš„æ»‘å—æ•°å­—');
            throw new Error('å¯¼å…¥çš„æ»‘å—æ•°å­—å¿…é¡»æ˜¯2çš„æ¬¡å¹‚');
        }
        gameState.grid = data.grid; gameState.score = data.score; gameState.bestScore = data.bestScore; gameState.gridSize = data.gridSize; gameState.difficulty = data.difficulty; gameState.isEndlessMode = data.isEndlessMode; document.querySelector('.game-container').classList.remove('grid-3x3', 'grid-4x4', 'grid-5x5'); document.querySelector('.game-container').classList.add(`grid-${data.gridSize}x${data.gridSize}`); initGridContainer(); updateDocumentTitle(); renderAllTiles(); elements.scoreDisplay.textContent = gameState.score; elements.bestScoreDisplay.textContent = gameState.bestScore; elements.modeDescription.textContent = gameState.isEndlessMode ? "å½“å‰æ¨¡å¼ï¼šæ— å°½æ¨¡å¼ - å°½å¯èƒ½è·å¾—é«˜åˆ†" : "å½“å‰æ¨¡å¼ï¼šæ ‡å‡†æ¨¡å¼ - è¾¾åˆ°2048è·èƒœ"; elements.difficultyDescription.textContent = `å½“å‰éš¾åº¦ï¼š${getDifficultyName()} - ${gameState.gridSize}Ã—${gameState.gridSize}ç½‘æ ¼`; checkGameState(); saveGameState(); gameState.history = []; updateUndoButtonState(); alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼'); } catch (e) { alert('å¯¼å…¥å¤±è´¥ï¼š' + e.message); } }
        const elements = {
            gridContainer: document.getElementById('grid-container'),
            tileContainer: document.getElementById('tile-container'),
            scoreDisplay: document.getElementById('score'),
            bestScoreDisplay: document.getElementById('best-score'),
            newGameButton: document.getElementById('new-game'),
            endlessModeButton: document.getElementById('endless-mode'),
            retryGameButton: document.getElementById('retry-game'),
            pauseButton: document.getElementById('pause-button'),
            resumeButton: document.getElementById('resume-button'),
            restartButton: document.getElementById('restart-button'),
            undoButton: document.getElementById('undo-button'),
            themeToggle: document.getElementById('theme-toggle'),
            gameMessage: document.getElementById('game-message'),
            gameMessageTitle: document.getElementById('game-message-title'),
            gameMessageText: document.getElementById('game-message-text'),
            gameMessageButton: document.getElementById('game-message-button'),
            pauseMenu: document.getElementById('pause-menu'),
            settingsModal: document.getElementById('settings-modal'),
            settingsButton: document.getElementById('settings-button'),
            closeSettingsButton: document.getElementById('close-settings-button'),
            easyModeButton: document.getElementById('easy-mode'),
            mediumModeButton: document.getElementById('medium-mode'),
            hardModeButton: document.getElementById('hard-mode'),
            grid3x3Button: document.getElementById('grid-3x3'),
            grid4x4Button: document.getElementById('grid-4x4'),
            grid5x5Button: document.getElementById('grid-5x5'),
            modeDescription: document.getElementById('mode-description'),
            difficultyDescription: document.getElementById('difficulty-description'),
            helpButton: document.getElementById('help-button'),
            helpModal: document.getElementById('help-modal'),
            closeHelp: document.getElementById('close-help'),
            resetSettingsButton: document.getElementById('reset-settings-button'),
            gameHeader: document.getElementById('game-header'),
            gameTitle: document.getElementById('game-title'),
            statsContainer: document.getElementById('stats-container'),
            gameButtons: document.getElementById('game-buttons'),
            difficultyButtons: document.getElementById('difficulty-buttons'),
            gameDescription: document.querySelector('.text-secondary\\/80.dark\\:text-dark-muted.mb-2'),
            gameTouchArea: document.getElementById('game-touch-area'),
            gameContainer: document.querySelector('.game-container')
        };
        function updateDocumentTitle() {
            const mode = gameState.isEndlessMode ? 'æ— å°½æ¨¡å¼' : 'æ ‡å‡†æ¨¡å¼';
            const difficulty = getDifficultyName();
            document.title = `2048 | ${mode} | ${difficulty} | ${gameState.gridSize}Ã—${gameState.gridSize} | åˆ†æ•°: ${gameState.score}`;
        }
        function createEmptyGrid() {
            const grid = [];
            for (let y = 0; y < gameState.gridSize; y++) {
                grid[y] = [];
                for (let x = 0; x < gameState.gridSize; x++) {
                    grid[y][x] = null;
                }
            }
            return grid;
        }
        function initGridContainer() {
            elements.gridContainer.innerHTML = '';
            for (let y = 0; y < gameState.gridSize; y++) {
                const gridRow = document.createElement('div');
                gridRow.className = 'grid-row';
                for (let x = 0; x < gameState.gridSize; x++) {
                    const gridCell = document.createElement('div');
                    gridCell.className = 'grid-cell';
                    gridRow.appendChild(gridCell);
                }
                elements.gridContainer.appendChild(gridRow);
            }
        }
        function generateRandomTile() {
            const availableCells = [];
            for (let y = 0; y < gameState.gridSize; y++) {
                for (let x = 0; x < gameState.gridSize; x++) {
                    if (gameState.grid[y][x] === null) {
                        availableCells.push({ x, y });
                    }
                }
            }
            if (availableCells.length > 0) {
                const cell = availableCells[Math.floor(Math.random() * availableCells.length)];
                const difficulty = config.difficultySettings[gameState.difficulty] || { fourProbability: 0.1 };
                const value = Math.random() < difficulty.fourProbability ? 4 : 2;
                gameState.grid[cell.y][cell.x] = {
                    value,
                    merged: false,
                    new: true
                };
                renderTile(cell.x, cell.y);
                return true;
            }
            return false;
        }
        function renderTile(x, y) {
            const tile = gameState.grid[y][x];
            if (!tile) return;
            const tileElement = document.createElement('div');
            tileElement.className = `tile tile-${tile.value} ${tile.new ? 'tile-appear' : ''} ${tile.value > 32768 ? 'tile-super' : ''} ${tile.value >= 10000 ? 'tile-5digit' : ''} ${gameState.gpuAccelerationEnabled ? 'gpu-accelerated' : ''}`;
            tileElement.textContent = tile.value;
            tileElement.dataset.pos = `${x}-${y}`;
            elements.tileContainer.appendChild(tileElement);
            if (tile.new) {
                setTimeout(() => {
                    tile.new = false;
                }, 200);
            }
        }
        function renderAllTiles() {
            elements.tileContainer.innerHTML = '';
            for (let y = 0; y < gameState.gridSize; y++) {
                for (let x = 0; x < gameState.gridSize; x++) {
                    if (gameState.grid[y][x]) {
                        renderTile(x, y);
                    }
                }
            }
        }
        function move(direction) {
            if (gameState.isPaused || gameState.gameOver || !elements.gameMessage.classList.contains('hidden')) return false;
            saveHistory();
            let moved = false;
            for (let y = 0; y < gameState.gridSize; y++) {
                for (let x = 0; x < gameState.gridSize; x++) {
                    if (gameState.grid[y][x]) {
                        gameState.grid[y][x].merged = false;
                    }
                }
            }
            switch(direction) {
                case 'up':
                    for (let x = 0; x < gameState.gridSize; x++) {
                        for (let y = 1; y < gameState.gridSize; y++) {
                            if (gameState.grid[y][x]) {
                                let newY = y;
                                while (newY > 0 && gameState.grid[newY - 1][x] === null) {
                                    newY--;
                                }
                                if (newY > 0 && gameState.grid[newY - 1][x] && 
                                    gameState.grid[newY - 1][x].value === gameState.grid[y][x].value &&
                                    !gameState.grid[newY - 1][x].merged) {
                                    gameState.grid[newY - 1][x].value *= 2;
                                    gameState.grid[newY - 1][x].merged = true;
                                    const mergedTile = gameState.grid[newY - 1][x];
                                    mergedTile.mergedAnimation = true;
                                    gameState.grid[y][x] = null;
                                    const difficulty = config.difficultySettings[gameState.difficulty] || { scoreMultiplier: 1 };
                                    gameState.score += gameState.grid[newY - 1][x].value * difficulty.scoreMultiplier;
                                    if (gameState.score > gameState.bestScore) {
                                        gameState.bestScore = gameState.score;
                                        elements.bestScoreDisplay.textContent = gameState.bestScore;
                                    }
                                    elements.scoreDisplay.textContent = gameState.score;
                                    updateDocumentTitle();
                                    moved = true;
                                } else if (newY !== y) {
                                    gameState.grid[newY][x] = gameState.grid[y][x];
                                    gameState.grid[y][x] = null;
                                    moved = true;
                                }
                            }
                        }
                    }
                    break;
                case 'down':
                    for (let x = 0; x < gameState.gridSize; x++) {
                        for (let y = gameState.gridSize - 2; y >= 0; y--) {
                            if (gameState.grid[y][x]) {
                                let newY = y;
                                while (newY < gameState.gridSize - 1 && gameState.grid[newY + 1][x] === null) {
                                    newY++;
                                }
                                if (newY < gameState.gridSize - 1 && gameState.grid[newY + 1][x] && 
                                    gameState.grid[newY + 1][x].value === gameState.grid[y][x].value &&
                                    !gameState.grid[newY + 1][x].merged) {
                                    gameState.grid[newY + 1][x].value *= 2;
                                    gameState.grid[newY + 1][x].merged = true;
                                    const mergedTile = gameState.grid[newY + 1][x];
                                    mergedTile.mergedAnimation = true;
                                    gameState.grid[y][x] = null;
                                    const difficulty = config.difficultySettings[gameState.difficulty] || { scoreMultiplier: 1 };
                                    gameState.score += gameState.grid[newY + 1][x].value * difficulty.scoreMultiplier;
                                    if (gameState.score > gameState.bestScore) {
                                        gameState.bestScore = gameState.score;
                                        elements.bestScoreDisplay.textContent = gameState.bestScore;
                                    }
                                    elements.scoreDisplay.textContent = gameState.score;
                                    updateDocumentTitle();
                                    moved = true;
                                } else if (newY !== y) {
                                    gameState.grid[newY][x] = gameState.grid[y][x];
                                    gameState.grid[y][x] = null;
                                    moved = true;
                                }
                            }
                        }
                    }
                    break;
                case 'left':
                    for (let y = 0; y < gameState.gridSize; y++) {
                        for (let x = 1; x < gameState.gridSize; x++) {
                            if (gameState.grid[y][x]) {
                                let newX = x;
                                while (newX > 0 && gameState.grid[y][newX - 1] === null) {
                                    newX--;
                                }
                                if (newX > 0 && gameState.grid[y][newX - 1] && 
                                    gameState.grid[y][newX - 1].value === gameState.grid[y][x].value &&
                                    !gameState.grid[y][newX - 1].merged) {
                                    gameState.grid[y][newX - 1].value *= 2;
                                    gameState.grid[y][newX - 1].merged = true;
                                    const mergedTile = gameState.grid[y][newX - 1];
                                    mergedTile.mergedAnimation = true;
                                    gameState.grid[y][x] = null;
                                    const difficulty = config.difficultySettings[gameState.difficulty] || { scoreMultiplier: 1 };
                                    gameState.score += gameState.grid[y][newX - 1].value * difficulty.scoreMultiplier;
                                    if (gameState.score > gameState.bestScore) {
                                        gameState.bestScore = gameState.score;
                                        elements.bestScoreDisplay.textContent = gameState.bestScore;
                                    }
                                    elements.scoreDisplay.textContent = gameState.score;
                                    updateDocumentTitle();
                                    moved = true;
                                } else if (newX !== x) {
                                    gameState.grid[y][newX] = gameState.grid[y][x];
                                    gameState.grid[y][x] = null;
                                    moved = true;
                                }
                            }
                        }
                    }
                    break;
                case 'right':
                    for (let y = 0; y < gameState.gridSize; y++) {
                        for (let x = gameState.gridSize - 2; x >= 0; x--) {
                            if (gameState.grid[y][x]) {
                                let newX = x;
                                while (newX < gameState.gridSize - 1 && gameState.grid[y][newX + 1] === null) {
                                    newX++;
                                }
                                if (newX < gameState.gridSize - 1 && gameState.grid[y][newX + 1] && 
                                    gameState.grid[y][newX + 1].value === gameState.grid[y][x].value &&
                                    !gameState.grid[y][newX + 1].merged) {
                                    gameState.grid[y][newX + 1].value *= 2;
                                    gameState.grid[y][newX + 1].merged = true;
                                    const mergedTile = gameState.grid[y][newX + 1];
                                    mergedTile.mergedAnimation = true;
                                    gameState.grid[y][x] = null;
                                    const difficulty = config.difficultySettings[gameState.difficulty] || { scoreMultiplier: 1 };
                                    gameState.score += gameState.grid[y][newX + 1].value * difficulty.scoreMultiplier;
                                    if (gameState.score > gameState.bestScore) {
                                        gameState.bestScore = gameState.score;
                                        elements.bestScoreDisplay.textContent = gameState.bestScore;
                                    }
                                    elements.scoreDisplay.textContent = gameState.score;
                                    updateDocumentTitle();
                                    moved = true;
                                } else if (newX !== x) {
                                    gameState.grid[y][newX] = gameState.grid[y][x];
                                    gameState.grid[y][x] = null;
                                    moved = true;
                                }
                            }
                        }
                    }
                    break;
            }
            if (moved) {
                elements.tileContainer.innerHTML = '';
                renderAllTiles();
                setTimeout(() => {
                    for (let y = 0; y < gameState.gridSize; y++) {
                        for (let x = 0; x < gameState.gridSize; x++) {
                            if (gameState.grid[y][x] && gameState.grid[y][x].mergedAnimation) {
                                const tileElement = elements.tileContainer.querySelector(`.tile[data-pos="${x}-${y}"]`);
                                if (tileElement) {
                                    tileElement.classList.add('tile-merge');
                                    setTimeout(() => {
                                        if (gameState.grid[y][x]) {
                                            gameState.grid[y][x].mergedAnimation = false;
                                        }
                                    }, 200);
                                }
                            }
                        }
                    }
                }, 10);
                setTimeout(() => {
                    generateRandomTile();
                    if (!gameState.gameWon) {
                        checkWin();
                    }
                    checkGameOver();
                    saveGameState();
                }, 200);
            }
            updateUndoButtonState();
            return moved;
        }
        function checkWin() {
            for (let y = 0; y < gameState.gridSize; y++) {
                for (let x = 0; x < gameState.gridSize; x++) {
                    if (gameState.grid[y][x] && gameState.grid[y][x].value >= config.winningValue) {
                        gameState.gameWon = true;
                        if (!gameState.isEndlessMode) {
                            showGameMessage("æ­å–œä½ è·èƒœï¼", "ä½ è¾¾åˆ°äº†2048åˆ†ï¼Œå¯ä»¥ç»§ç»­æ¸¸æˆæŒ‘æˆ˜æ›´é«˜åˆ†æ•°ï¼Œæˆ–è€…é‡æ–°å¼€å§‹ã€‚");
                        }
                        return true;
                    }
                }
            }
            return false;
        }
        function checkGameOver() {
            for (let y = 0; y < gameState.gridSize; y++) {
                for (let x = 0; x < gameState.gridSize; x++) {
                    if (gameState.grid[y][x] === null) {
                        return false;
                    }
                }
            }
            for (let y = 0; y < gameState.gridSize; y++) {
                for (let x = 0; x < gameState.gridSize; x++) {
                    const value = gameState.grid[y][x].value;
                    if (x < gameState.gridSize - 1 && gameState.grid[y][x + 1] && gameState.grid[y][x + 1].value === value) {
                        return false;
                    }
                    if (y < gameState.gridSize - 1 && gameState.grid[y + 1][x] && gameState.grid[y + 1][x].value === value) {
                        return false;
                    }
                }
            }
            gameState.gameOver = true;
            showGameMessage("æ¸¸æˆç»“æŸï¼", "æ— æ³•è¿›è¡Œä»»ä½•ç§»åŠ¨ã€‚");
            return true;
        }
        function showGameMessage(title, text) {
            elements.gameMessageTitle.textContent = title;
            elements.gameMessageText.textContent = text;
            elements.gameMessage.classList.remove('hidden');
            setTimeout(() => {
                const messageBox = elements.gameMessage.querySelector('.bg-white');
                messageBox.classList.add('scale-100');
                messageBox.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }
        function hideGameMessage() {
            const messageBox = elements.gameMessage.querySelector('.bg-white');
            messageBox.classList.remove('scale-100');
            messageBox.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                elements.gameMessage.classList.add('hidden');
            }, 200);
        }
        function togglePause() {
            gameState.isPaused = !gameState.isPaused;
            if (gameState.isPaused) {
                elements.pauseMenu.classList.remove('hidden');
                setTimeout(() => {
                    const pauseBox = elements.pauseMenu.querySelector('.bg-white');
                    pauseBox.classList.add('scale-100');
                    pauseBox.classList.remove('scale-95', 'opacity-0');
                }, 10);
            } else {
                const pauseBox = elements.pauseMenu.querySelector('.bg-white');
                pauseBox.classList.remove('scale-100');
                pauseBox.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    elements.pauseMenu.classList.add('hidden');
                }, 200);
            }
        }
        function saveHistory() {
            const gridCopy = JSON.parse(JSON.stringify(gameState.grid));
            gameState.history.push({
                grid: gridCopy,
                score: gameState.score
            });
            if (gameState.history.length > config.maxUndoSteps) {
                gameState.history.shift();
            }
            updateUndoButtonState();
        }
        function undoMove() {
            if (gameState.history.length === 0) return;
            const lastState = gameState.history.pop();
            gameState.grid = lastState.grid;
            gameState.score = lastState.score;
            elements.scoreDisplay.textContent = gameState.score;
            renderAllTiles();
            gameState.gameOver = false;
            gameState.gameWon = false;
            hideGameMessage();
            updateDocumentTitle();
            saveGameState();
            updateUndoButtonState();
        }
        function updateUndoButtonState() {
            if (gameState.history.length === 0) {
                elements.undoButton.disabled = true;
                elements.undoButton.classList.add('opacity-50', 'cursor-not-allowed');
                elements.undoButton.title = 'æ— æ³•æ’¤é”€ï¼ˆæ²¡æœ‰å†å²è®°å½•ï¼‰';
            } else {
                elements.undoButton.disabled = false;
                elements.undoButton.classList.remove('opacity-50', 'cursor-not-allowed');
                elements.undoButton.title = `æ’¤é”€ä¸Šä¸€æ­¥ï¼ˆå¯æ’¤é”€ ${gameState.history.length} æ­¥ï¼‰`;
            }
        }
        function updateDifficultyButtons() {
            elements.easyModeButton.classList.remove('ring-2', 'ring-easy/50');
            elements.mediumModeButton.classList.remove('ring-2', 'ring-medium/50');
            elements.hardModeButton.classList.remove('ring-2', 'ring-hard/50');
            switch(gameState.difficulty) {
                case 'easy':
                    elements.easyModeButton.classList.add('ring-2', 'ring-easy/50');
                    break;
                case 'medium':
                    elements.mediumModeButton.classList.add('ring-2', 'ring-medium/50');
                    break;
                case 'hard':
                    elements.hardModeButton.classList.add('ring-2', 'ring-hard/50');
                    break;
            }
        }
        function updateGridButtonState(gridSize) {
            elements.grid3x3Button.classList.remove('ring-2', 'ring-green-300');
            elements.grid4x4Button.classList.remove('ring-2', 'ring-blue-300');
            elements.grid5x5Button.classList.remove('ring-2', 'ring-purple-300');
            switch(gridSize) {
                case 3:
                    elements.grid3x3Button.classList.add('ring-2', 'ring-green-300');
                    break;
                case 4:
                    elements.grid4x4Button.classList.add('ring-2', 'ring-blue-300');
                    break;
                case 5:
                    elements.grid5x5Button.classList.add('ring-2', 'ring-purple-300');
                    break;
            }
        }
        function getDifficultyName() {
            switch(gameState.difficulty) {
                case 'easy': return 'ç®€å•';
                case 'medium': return 'ä¸­ç­‰';
                case 'hard': return 'å›°éš¾';
                default: return 'ä¸­ç­‰';
            }
        }
        elements.dataTransferButton = document.getElementById('data-transfer-button');
        elements.dataTransferModal = document.getElementById('data-transfer-modal');
        elements.exportDataButton = document.getElementById('export-data-button');
        elements.importDataButton = document.getElementById('import-data-button');
        elements.dataTextarea = document.getElementById('data-textarea');
        elements.closeDataModal = document.getElementById('close-data-modal');
        function setupDataTransfer() { function handleImportClick() { const data = elements.dataTextarea.value.trim(); if (data && confirm('ç¡®å®šè¦å¯¼å…¥æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ¸¸æˆçŠ¶æ€ã€‚')) importGameData(data); } elements.dataTransferButton.addEventListener('click', () => { const modal = document.getElementById('data-transfer-modal'); modal.classList.remove('hidden'); modal.classList.add('modal-enter'); setTimeout(() => { modal.classList.add('modal-enter-active'); }, 10); }); elements.exportDataButton.addEventListener('click', () => { exportGameData(); }); elements.importDataButton.removeEventListener('click', handleImportClick); elements.importDataButton.addEventListener('click', handleImportClick); elements.closeDataModal.addEventListener('click', () => { const modal = document.getElementById('data-transfer-modal'); modal.classList.add('modal-exit-active'); setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('modal-exit-active'); }, 300); }) } window.addEventListener('load', setupDataTransfer);
        function saveGameState() {
            localStorage.setItem('2048-game-state', JSON.stringify({
                grid: gameState.grid,
                gridSize: gameState.gridSize,
                score: gameState.score,
                bestScore: gameState.bestScore,
                gameOver: gameState.gameOver,
                gameWon: gameState.gameWon,
                isEndlessMode: gameState.isEndlessMode,
                difficulty: gameState.difficulty,
                history: gameState.history
            }));
        }
        function initGame(isEndlessMode = false, gridSize = gameState.gridSize) {
            const previousBestScore = gameState.bestScore;
            gameState.grid = createEmptyGrid();
            gameState.gridSize = gridSize;
            gameState.score = 0;
            gameState.gameOver = false;
            gameState.gameWon = false;
            gameState.isEndlessMode = isEndlessMode;
            gameState.history = [];
            elements.scoreDisplay.textContent = gameState.score;
            elements.bestScoreDisplay.textContent = previousBestScore;
            document.querySelector('.game-container').classList.remove('grid-3x3', 'grid-4x4', 'grid-5x5');
            document.querySelector('.game-container').classList.add(`grid-${gridSize}x${gridSize}`);
            initGridContainer();
            elements.tileContainer.innerHTML = '';
            for (let i = 0; i < config.initialTiles; i++) {
                generateRandomTile();
            }
            updateDifficultyButtons();
            updateGridButtonState(gridSize);
            elements.modeDescription.textContent = isEndlessMode 
                ? "å½“å‰æ¨¡å¼ï¼šæ— å°½æ¨¡å¼ - å°½å¯èƒ½è·å¾—é«˜åˆ†" 
                : "å½“å‰æ¨¡å¼ï¼šæ ‡å‡†æ¨¡å¼ - è¾¾åˆ°2048è·èƒœ";
            elements.difficultyDescription.textContent = `å½“å‰éš¾åº¦ï¼š${getDifficultyName()} - ${gameState.gridSize}Ã—${gameState.gridSize}ç½‘æ ¼`;
            hideGameMessage();
            updateDocumentTitle();
            updateUndoButtonState();
            saveGameState();
        }
        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('2048-theme', isDark ? 'dark' : 'light');
            elements.themeToggle.querySelector('i').className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        }
        function resetAllSettings() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®å—ï¼Ÿè¿™å°†æ¸…é™¤æ¸¸æˆè¿›åº¦å’Œåå¥½è®¾ç½®ã€‚')) {
                localStorage.removeItem('2048-game-state');
                localStorage.removeItem('2048-theme');
                localStorage.removeItem('2048-gpu-acceleration');
                document.documentElement.classList.remove('dark');
                location.reload();
            }
        }
        function handleResize() {
            const isCompact = window.innerWidth < 400;
            if (isCompact) {
                elements.gameHeader && elements.gameHeader.classList.add('compact-header');
                elements.gameTitle && elements.gameTitle.classList.add('compact-title');
                elements.statsContainer && elements.statsContainer.classList.add('compact-stats');
                elements.gameButtons && elements.gameButtons.classList.add('compact-buttons');
                elements.difficultyButtons && elements.difficultyButtons.classList.add('compact-difficulty');
                elements.gameDescription && elements.gameDescription.classList.add('compact-description');
                elements.gameMessage && elements.gameMessage.classList.add('compact-message');
            } else {
                elements.gameHeader && elements.gameHeader.classList.remove('compact-header');
                elements.gameTitle && elements.gameTitle.classList.remove('compact-title');
                elements.statsContainer && elements.statsContainer.classList.remove('compact-stats');
                elements.gameButtons && elements.gameButtons.classList.remove('compact-buttons');
                elements.difficultyButtons && elements.difficultyButtons.classList.remove('compact-difficulty');
                elements.gameDescription && elements.gameDescription.classList.remove('compact-description');
                elements.gameMessage && elements.gameMessage.classList.remove('compact-message');
            }
        }
        function initEventListeners() {
            document.addEventListener('keydown', (e) => {
                if (gameState.isPaused || gameState.gameOver || (gameState.gameWon && !gameState.isEndlessMode) || !elements.helpModal.classList.contains('hidden')) return;
                if ([37, 38, 39, 40, 80, 27].includes(e.keyCode)) {
                    e.preventDefault();
                }
                switch(e.keyCode) {
                    case 38:
                        move('up');
                        break;
                    case 40:
                        move('down');
                        break;
                    case 37:
                        move('left');
                        break;
                    case 39:
                        move('right');
                        break;
                    case 80:
                    case 27:
                        togglePause();
                        break;
                    case 90:
                        if (e.ctrlKey || e.metaKey) {
                            undoMove();
                        }
                        break;
                }
            }, { passive: false });
            elements.gameContainer.addEventListener('touchstart', (e) => {
                if (gameState.isPaused || gameState.gameOver || (gameState.gameWon && !gameState.isEndlessMode) || !elements.helpModal.classList.contains('hidden')) return;
                gameState.touchStartX = e.touches[0].clientX;
                gameState.touchStartY = e.touches[0].clientY;
            }, { passive: false });
            elements.gameContainer.addEventListener('touchmove', (e) => {
                e.preventDefault();
            }, { passive: false });
            elements.gameContainer.addEventListener('touchend', (e) => {
                if (gameState.isPaused || gameState.gameOver || (gameState.gameWon && !gameState.isEndlessMode) || !elements.helpModal.classList.contains('hidden')) return;
                gameState.touchEndX = e.changedTouches[0].clientX;
                gameState.touchEndY = e.changedTouches[0].clientY;
                const dx = gameState.touchEndX - gameState.touchStartX;
                const dy = gameState.touchEndY - gameState.touchStartY;
                if (Math.abs(dx) > Math.abs(dy)) {
                    if (Math.abs(dx) > config.touchThreshold) {
                        move(dx > 0 ? 'right' : 'left');
                    }
                } else {
                    if (Math.abs(dy) > config.touchThreshold) {
                        move(dy > 0 ? 'down' : 'up');
                    }
                }
            }, { passive: true });
            elements.newGameButton.addEventListener('click', () => {
                initGame(false, gameState.gridSize);
            });
            elements.endlessModeButton.addEventListener('click', () => {
                initGame(true, gameState.gridSize);
            });
            elements.gameMessageButton.addEventListener('click', () => {
                hideGameMessage();
                initGame(gameState.isEndlessMode, gameState.gridSize);
            });
            elements.pauseButton.addEventListener('click', togglePause);
            elements.resumeButton.addEventListener('click', togglePause);
            elements.restartButton.addEventListener('click', () => {
                gameState.isPaused = false;
                elements.pauseMenu.classList.add('hidden');
                initGame(gameState.isEndlessMode, gameState.gridSize);
            });
            elements.undoButton.addEventListener('click', undoMove);
            elements.themeToggle.addEventListener('change', function() {
                const theme = this.value;
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
            function updateThemeFromSystem() {
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                elements.themeToggle.value = isDark ? 'dark' : 'light';
                if (isDark) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }
            updateThemeFromSystem();
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateThemeFromSystem);
            elements.easyModeButton.addEventListener('click', () => {
                gameState.difficulty = 'easy';
                updateDifficultyButtons();
                elements.difficultyDescription.textContent = `å½“å‰éš¾åº¦ï¼š${getDifficultyName()} - ${gameState.gridSize}Ã—${gameState.gridSize}ç½‘æ ¼`;
                saveGameState();
            });
            elements.mediumModeButton.addEventListener('click', () => {
                gameState.difficulty = 'medium';
                updateDifficultyButtons();
                elements.difficultyDescription.textContent = `å½“å‰éš¾åº¦ï¼š${getDifficultyName()} - ${gameState.gridSize}Ã—${gameState.gridSize}ç½‘æ ¼`;
                saveGameState();
            });
            elements.hardModeButton.addEventListener('click', () => {
                gameState.difficulty = 'hard';
                updateDifficultyButtons();
                elements.difficultyDescription.textContent = `å½“å‰éš¾åº¦ï¼š${getDifficultyName()} - ${gameState.gridSize}Ã—${gameState.gridSize}ç½‘æ ¼`;
                saveGameState();
            });
            elements.grid3x3Button.addEventListener('click', () => {
                gameState.gridSize = 3;
                updateGridButtonState(3);
                elements.difficultyDescription.textContent = `å½“å‰éš¾åº¦ï¼š${getDifficultyName()} - ${gameState.gridSize}Ã—${gameState.gridSize}ç½‘æ ¼`;
                initGame(gameState.isEndlessMode, 3);
            });
            elements.grid4x4Button.addEventListener('click', () => {
                gameState.gridSize = 4;
                updateGridButtonState(4);
                elements.difficultyDescription.textContent = `å½“å‰éš¾åº¦ï¼š${getDifficultyName()} - ${gameState.gridSize}Ã—${gameState.gridSize}ç½‘æ ¼`;
                initGame(gameState.isEndlessMode, 4);
            });
            elements.grid5x5Button.addEventListener('click', () => {
                gameState.gridSize = 5;
                updateGridButtonState(5);
                elements.difficultyDescription.textContent = `å½“å‰éš¾åº¦ï¼š${getDifficultyName()} - ${gameState.gridSize}Ã—${gameState.gridSize}ç½‘æ ¼`;
                initGame(gameState.isEndlessMode, 5);
            });
            elements.dataTransferButton.addEventListener('click', () => { showModal('data-transfer-modal'); });
            elements.settingsButton.addEventListener('click', () => {
                showModal('settings-modal');
            });
            elements.closeSettingsButton.addEventListener('click', () => {
                hideModal('settings-modal');
            });
            elements.gpuAccelerationToggle = document.getElementById('gpu-acceleration');
            elements.gpuAccelerationToggle.checked = gameState.gpuAccelerationEnabled;
            elements.gpuAccelerationToggle.addEventListener('change', (e) => {
                gameState.gpuAccelerationEnabled = e.target.checked;
                localStorage.setItem('2048-gpu-acceleration', gameState.gpuAccelerationEnabled);
                renderAllTiles();
            });
            elements.dataTransferButton.addEventListener('click', () => {
                showModal('data-transfer-modal');
            });
            elements.helpButton.addEventListener('click', () => {
                elements.helpModal.classList.remove('hidden');
                setupDataTransfer();
                setTimeout(() => {
                    elements.helpModal.classList.add('modal-enter-active');
                }, 10);
            });
            elements.closeHelp.addEventListener('click', () => {
                elements.helpModal.classList.add('modal-exit');
                setTimeout(() => {
                    elements.helpModal.classList.add('hidden');
                    elements.helpModal.classList.remove('modal-enter-active', 'modal-exit');
                }, 200);
            });
            elements.helpModal.addEventListener('click', (e) => {
                if (e.target === elements.helpModal) {
                    elements.helpModal.classList.add('modal-exit');
                    setTimeout(() => {
                        elements.helpModal.classList.add('hidden');
                        elements.helpModal.classList.remove('modal-enter-active', 'modal-exit');
                    }, 200);
                }
            });
            elements.resetSettingsButton.addEventListener('click', resetAllSettings);
            window.addEventListener('resize', handleResize);
        }
        function loadGameState() {
            const savedState = localStorage.getItem('2048-game-state');
            const savedTheme = localStorage.getItem('2048-theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                elements.themeToggle.querySelector('i').className = 'fa-solid fa-sun';
            }
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    gameState.grid = state.grid || createEmptyGrid();
                    gameState.gridSize = state.gridSize || 4;
                    gameState.score = state.score || 0;
                    gameState.bestScore = state.bestScore || 0;
                    gameState.gameOver = state.gameOver || false;
                    gameState.gameWon = state.gameWon || false;
                    gameState.isEndlessMode = state.isEndlessMode || false;
                    gameState.difficulty = state.difficulty || 'medium';
                    gameState.history = state.history || [];
                    elements.scoreDisplay.textContent = gameState.score;
                    elements.bestScoreDisplay.textContent = gameState.bestScore;
                    document.querySelector('.game-container').classList.remove('grid-3x3', 'grid-4x4', 'grid-5x5');
                    document.querySelector('.game-container').classList.add(`grid-${gameState.gridSize}x${gameState.gridSize}`);
                    initGridContainer();
                    renderAllTiles();
                    updateDifficultyButtons();
                    updateGridButtonState(gameState.gridSize);
                    elements.modeDescription.textContent = gameState.isEndlessMode 
                        ? "å½“å‰æ¨¡å¼ï¼šæ— å°½æ¨¡å¼ - å°½å¯èƒ½è·å¾—é«˜åˆ†" 
                        : "å½“å‰æ¨¡å¼ï¼šæ ‡å‡†æ¨¡å¼ - è¾¾åˆ°2048è·èƒœ";
                    elements.difficultyDescription.textContent = `å½“å‰éš¾åº¦ï¼š${getDifficultyName()} - ${gameState.gridSize}Ã—${gameState.gridSize}ç½‘æ ¼`;
                    if (gameState.gameOver) {
                        showGameMessage("æ¸¸æˆç»“æŸï¼", "æ— æ³•è¿›è¡Œä»»ä½•ç§»åŠ¨ã€‚");
                    } else if (gameState.gameWon && !gameState.isEndlessMode) {
                        showGameMessage("æ­å–œä½ è·èƒœï¼", "ä½ è¾¾åˆ°äº†2048åˆ†ï¼Œå¯ä»¥ç»§ç»­æ¸¸æˆæŒ‘æˆ˜æ›´é«˜åˆ†æ•°ï¼Œæˆ–è€…é‡æ–°å¼€å§‹ã€‚");
                    }
                } catch (e) {
                    console.error("Failed to load saved game state:", e);
                    initGame();
                }
            } else {
                initGame();
            }
            updateDocumentTitle();
            updateUndoButtonState();
        }
        function startGame() {
            loadGameState();
            initEventListeners();
            handleResize();
        }
        startGame();
    </script>
</body>
</html>