<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/TheFurina/2048-game@main/icon.png">
    <title>2048 Game</title>
    <meta name="description" content="玩2048游戏，一款流行的在线益智数字游戏。通过滑动合并相同数字，挑战达到2048方块。支持多种难度和网格大小。">
    <meta name="keywords" content="2048游戏,2048,数字游戏,益智游戏,在线游戏,免费游戏,脑力游戏,滑动游戏,合并游戏,挑战游戏">
    <meta name="author" content="2048 Game">
    <meta name="language" content="zh-CN">
    <link rel="canonical" href="https://thefurina.github.io/2048-game">
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    <meta property="og:title" content="2048 Game">
    <meta property="og:description" content="玩2048游戏，一款流行的在线益智数字游戏。通过滑动合并相同数字，挑战达到2048方块。支持多种难度和网格大小。">
    <meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheFurina/2048-game@main/icon.png">
    <meta property="og:image:width" content="512">
    <meta property="og:image:height" content="512">
    <meta property="og:url" content="https://thefurina.github.io/2048-game">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="2048 Game">
    <meta property="og:locale" content="zh_CN">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="2048 Game">
    <meta name="twitter:description" content="玩2048游戏，一款流行的在线益智数字游戏。通过滑动合并相同数字，挑战达到2048方块。支持多种难度和网格大小。">
    <meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/TheFurina/2048-game@main/icon.png">
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Game",
        "name": "2048游戏",
        "alternateName": "2048",
        "description": "一款流行的在线益智数字游戏。通过滑动合并相同数字，挑战达到2048方块。",
        "url": "https://thefurina.github.io/2048-game">",
        "image": "https://cdn.jsdelivr.net/gh/TheFurina/2048-game@main/icon.png",
        "inLanguage": "zh-CN",
        "isFamilyFriendly": "true",
        "genre": ["益智游戏", "数字游戏", "脑力游戏"],
        "gamePlatform": "Web浏览器",
        "applicationCategory": "Game",
        "operatingSystem": "任何",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "CNY",
            "availability": "https://schema.org/InStock"
        },
        "author": {
            "@type": "Person",
            "name": "TheFurina",
            "url": "https://github.com/TheFurina"
        },
        "publisher": {
            "@type": "Person",
            "name": "TheFurina",
            "url": "https://github.com/TheFurina"
        }
    }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet" crossorigin="anonymous">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#faa31b',
                        secondary: '#8f7a66',
                        bg: '#faf8ef',
                        grid: '#bbada0',
                        cellEmpty: '#cdc1b4',
                        easy: '#4CAF50',
                        medium: '#FFC107',
                        hard: '#F44336',
                        dark: {
                            bg: '#121212',
                            surface: '#1e1e1e',
                            primary: '#ffb74d',
                            secondary: '#a1887f',
                            grid: '#37474f',
                            cellEmpty: '#546e7a',
                            text: '#e0e0e0',
                            muted: '#9e9e9e',
                        }
                    },
                    fontFamily: {
                        game: ['"Clear Sans"', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <script>
        const themeToggle = document.getElementById('theme-toggle');
        if (themeToggle) {
            const isDarkMode = document.documentElement.classList.contains('dark');
            themeToggle.value = isDarkMode ? 'dark' : 'light';
        }
    </script>
    <style type="text/tailwindcss">
        .hidden { 
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        } 
        .modal-enter { 
            opacity: 0;
            transform: scale(0.95);
        } 
        .modal-enter-active { 
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.3s ease, transform 0.3s ease;
        } 
        .modal-exit { 
            opacity: 1;
            transform: scale(1);
        } 
        .modal-exit-active { 
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.3s ease, transform 0.3s ease;
        } 
        :host, html { 
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            button, a, input, select, textarea, [tabindex]:not([tabindex="-1"]) {
                transition: all 0.2s ease-in-out;
                will-change: transform, box-shadow;
            }
            button:focus,
            a:focus,
            input:focus,
            select:focus,
            textarea:focus,
            [tabindex]:not([tabindex="-1"]):focus {
                outline: none;
            }
            button:focus-visible,
            a:focus-visible,
            input:focus-visible,
            select:focus-visible,
            textarea:focus-visible,
            [tabindex]:not([tabindex="-1"]):focus-visible {
                box-shadow: 0 0 0 3px rgba(250, 163, 27, 0.5);
            }
            .dark button:focus-visible,
            .dark a:focus-visible,
            .dark input:focus-visible,
            .dark select:focus-visible,
            .dark textarea:focus-visible,
            .dark [tabindex]:not([tabindex="-1"]):focus-visible {
                box-shadow: 0 0 0 3px rgba(255, 183, 77, 0.5);
            }
            .bg-primary:focus-visible { box-shadow: 0 0 0 3px rgba(250, 163, 27, 0.5) !important; }
            .bg-secondary:focus-visible { box-shadow: 0 0 0 3px rgba(143, 122, 102, 0.5) !important; }
            .bg-easy:focus-visible { box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.5) !important; }
            .bg-medium:focus-visible { box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.5) !important; }
            .bg-hard:focus-visible { box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.5) !important; }
            .dark .bg-primary:focus-visible { box-shadow: 0 0 0 3px rgba(255, 183, 77, 0.5) !important; }
            .dark .bg-secondary:focus-visible { box-shadow: 0 0 0 3px rgba(161, 136, 127, 0.5) !important; }
            .dark .bg-easy:focus-visible { box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.5) !important; }
            .dark .bg-medium:focus-visible { box-shadow: 0 0 0 3px rgba(255, 143, 0, 0.5) !important; }
            .dark .bg-hard:focus-visible { box-shadow: 0 0 0 3px rgba(198, 40, 40, 0.5) !important; }
            [disabled] {
                cursor: not-allowed;
                opacity: 0.6;
            }
            [disabled]:focus {
                box-shadow: none !important;
            }
            .tile-2 { background-color: #eee4da; color: #776e65; }
            .tile-4 { background-color: #ede0c8; color: #776e65; }
            .tile-8 { background-color: #f2b179; color: #f9f6f2; }
            .tile-16 { background-color: #f59563; color: #f9f6f2; }
            .tile-32 { background-color: #f67c5f; color: #f9f6f2; }
            .tile-64 { background-color: #f65e3b; color: #f9f6f2; }
            .tile-128 { background-color: #edcf72; color: #f9f6f2; }
            .tile-256 { background-color: #edcc61; color: #f9f6f2; }
            .tile-512 { background-color: #edc850; color: #f9f6f2; }
            .tile-1024 { background-color: #edc53f; color: #f9f6f2; }
            .tile-2048 { background-color: #edc22e; color: #f9f6f2; }
            .tile-4096 { background-color: #e65100; color: #ffffff; }
            .tile-8192 { background-color: #bf360c; color: #ffffff; }
            .tile-16384 { background-color: #880e4f; color: #ffffff; }
            .tile-32768 { background-color: #4a148c; color: #ffffff; }
            .tile-super { background-color: #311b92; color: #ffffff; }
            .tile.gpu-accelerated { transform: translateZ(0); will-change: transform; }
            .dark .tile-2 { background-color: #424242; color: #e0e0e0; }
            .dark .tile-4 { background-color: #546e7a; color: #e0e0e0; }
            .dark .tile-8 { background-color: #ff8a65; color: #212121; }
            .dark .tile-16 { background-color: #ff7043; color: #212121; }
            .dark .tile-32 { background-color: #ff5722; color: #212121; }
            .dark .tile-64 { background-color: #f4511e; color: #212121; }
            .dark .tile-128 { background-color: #ffca28; color: #212121; }
            .dark .tile-256 { background-color: #ffc107; color: #212121; }
            .dark .tile-512 { background-color: #ffb300; color: #212121; }
            .dark .tile-1024 { background-color: #ffa000; color: #212121; }
            .dark .tile-2048 { background-color: #ff8f00; color: #212121; }
            .dark .tile-4096 { background-color: #e65100; color: #ffffff; }
            .dark .tile-8192 { background-color: #c62828; color: #ffffff; }
            .dark .tile-16384 { background-color: #ad1457; color: #ffffff; }
            .dark .tile-32768 { background-color: #6a1b9a; color: #ffffff; }
            .dark .tile-super { background-color: #4527a0; color: #ffffff; }
            .tile-appear {
                animation: appear 200ms ease-in-out;
            }
            .tile-merge {
                animation: merge 250ms cubic-bezier(0.34, 1.56, 0.64, 1);
            }
            @keyframes appear {
                0% { transform: scale(0.8); opacity: 0.8; }
                50% { transform: scale(1.02); opacity: 0.9; }
                75% { transform: scale(0.98); opacity: 0.95; }
                100% { transform: scale(1); opacity: 1; }
            }
            @keyframes merge {
                0% { transform: scale(1); }
                60% { transform: scale(1.13); }
                100% { transform: scale(1); }
            }
            .game-container {
                position: relative;
                padding: clamp(8px, 3vw, 16px);
                cursor: default;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                background: #bbada0;
                border-radius: 12px;
                width: 90vw;
                height: 90vw;
                max-width: 500px;
                max-height: 500px;
                -webkit-box-sizing: border-box;
                -moz-box-sizing: border-box;
                box-sizing: border-box;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
                margin: 0 auto;
                transition: background-color 0.3s ease;
            }
            .dark .game-container {
                background: #37474f;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            }
            .grid-container {
                position: absolute;
                z-index: 1;
                width: calc(100% - (2 * clamp(8px, 3vw, 16px)));
                height: calc(100% - (2 * clamp(8px, 3vw, 16px)));
            }
            .grid-row {
                display: flex;
                margin-bottom: clamp(8px, 3vw, 16px);
            }
            .grid-row:last-child {
                margin-bottom: 0;
            }
            .grid-cell {
                margin-right: clamp(8px, 3vw, 16px);
                border-radius: 6px;
                background: rgba(238, 228, 218, 0.35);
                transition: background-color 0.3s ease;
            }
            .dark .grid-cell {
                background: rgba(84, 110, 122, 0.35);
            }
            .grid-cell:last-child {
                margin-right: 0;
            }
            .tile-container {
                position: absolute;
                z-index: 2;
                width: calc(100% - (2 * clamp(8px, 3vw, 16px)));
                height: calc(100% - (2 * clamp(8px, 3vw, 16px)));
            }
            .tile {
                position: absolute;
                border-radius: 6px;
                font-weight: bold;
                text-align: center;
                transition: 100ms ease-in-out;
                transition-property: transform, left, top;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                display: flex;
                align-items: center;
                justify-content: center;
                will-change: transform, left, top;
                transition: all 0.3s ease;
                font-size: clamp(1rem, 5vw, 2.5rem);
            }
            #theme-toggle, #theme-toggle option {
                font-family: 'Font Awesome 6 Free', sans-serif !important;
                font-weight: 900 !important;
                background-color: theme('colors.bg');
                color: theme('colors.secondary');
                border: 2px solid theme('colors.grid');
                padding: 0.5rem 2.5rem 0.5rem 1rem;
                border-radius: 8px;
                appearance: none;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' class='h-5 w-5' viewBox='0 0 20 20' fill='%238f7a66'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 0.7rem center;
                background-size: 1.2em;
                transition: all 0.2s ease;
            }
            #theme-toggle:hover {
                border-color: theme('colors.primary');
                box-shadow: 0 0 0 2px rgba(250, 163, 27, 0.2);
            }
            #theme-toggle:focus {
                outline: none;
                --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
                --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) rgba(250, 163, 27, 0.5);
                box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
            }
            .dark #theme-toggle, .dark #theme-toggle option {
                background-color: theme('colors.dark.surface');
                color: theme('colors.dark.text');
                border-color: theme('colors.dark.grid');
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' class='h-5 w-5' viewBox='0 0 20 20' fill='%23e0e0e0'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            }
            .dark #theme-toggle:hover {
                border-color: theme('colors.dark.primary');
            }
            .grid-3x3 .grid-row {
                height: calc((100% - clamp(16px, 6vw, 32px)) / 3);
            }
            .grid-3x3 .grid-cell {
                width: calc((100% - clamp(16px, 6vw, 32px)) / 3);
            }
            .grid-3x3 .tile {
                width: calc((100% - clamp(16px, 6vw, 32px)) / 3);
                height: calc((100% - clamp(16px, 6vw, 32px)) / 3);
            }
            .grid-4x4 .grid-row {
                height: calc((100% - clamp(24px, 9vw, 48px)) / 4);
            }
            .grid-4x4 .grid-cell {
                width: calc((100% - clamp(24px, 9vw, 48px)) / 4);
            }
            .grid-4x4 .tile {
                width: calc((100% - clamp(24px, 9vw, 48px)) / 4);
                height: calc((100% - clamp(24px, 9vw, 48px)) / 4);
            }
            .grid-5x5 .grid-row {
                height: calc((100% - clamp(32px, 12vw, 64px)) / 5);
            }
            .grid-5x5 .grid-cell {
                width: calc((100% - clamp(32px, 12vw, 64px)) / 5);
            }
            .grid-5x5 .tile {
                width: calc((100% - clamp(32px, 12vw, 64px)) / 5);
                height: calc((100% - clamp(32px, 12vw, 64px)) / 5);
                font-size: clamp(0.8rem, 3vw, 2rem);
            }
            .grid-5x5 .tile-5digit {
                font-size: clamp(0.8rem, 2.2vw, 1.6rem);
            }
            .grid-4x4 .tile-5digit {
                font-size: clamp(1rem, 3vw, 2rem);
            }
            .grid-3x3 .tile[data-pos="0-0"] { left: 0%; top: 0%; }
            .grid-3x3 .tile[data-pos="1-0"] { left: calc(33.333% + 5.333px); top: 0%; }
            .grid-3x3 .tile[data-pos="2-0"] { left: calc(66.666% + 10.666px); top: 0%; }
            .grid-3x3 .tile[data-pos="0-1"] { left: 0%; top: calc(33.333% + 5.333px); }
            .grid-3x3 .tile[data-pos="1-1"] { left: calc(33.333% + 5.333px); top: calc(33.333% + 5.333px); }
            .grid-3x3 .tile[data-pos="2-1"] { left: calc(66.666% + 10.666px); top: calc(33.333% + 5.333px); }
            .grid-3x3 .tile[data-pos="0-2"] { left: 0%; top: calc(66.666% + 10.666px); }
            .grid-3x3 .tile[data-pos="1-2"] { left: calc(33.333% + 5.333px); top: calc(66.666% + 10.666px); }
            .grid-3x3 .tile[data-pos="2-2"] { left: calc(66.666% + 10.666px); top: calc(66.666% + 10.666px); }
            .grid-4x4 .tile[data-pos="0-0"] { left: 0%; top: 0%; }
            .grid-4x4 .tile[data-pos="1-0"] { left: calc(25% + 4px); top: 0%; }
            .grid-4x4 .tile[data-pos="2-0"] { left: calc(50% + 8px); top: 0%; }
            .grid-4x4 .tile[data-pos="3-0"] { left: calc(75% + 12px); top: 0%; }
            .grid-4x4 .tile[data-pos="0-1"] { left: 0%; top: calc(25% + 4px); }
            .grid-4x4 .tile[data-pos="1-1"] { left: calc(25% + 4px); top: calc(25% + 4px); }
            .grid-4x4 .tile[data-pos="2-1"] { left: calc(50% + 8px); top: calc(25% + 4px); }
            .grid-4x4 .tile[data-pos="3-1"] { left: calc(75% + 12px); top: calc(25% + 4px); }
            .grid-4x4 .tile[data-pos="0-2"] { left: 0%; top: calc(50% + 8px); }
            .grid-4x4 .tile[data-pos="1-2"] { left: calc(25% + 4px); top: calc(50% + 8px); }
            .grid-4x4 .tile[data-pos="2-2"] { left: calc(50% + 8px); top: calc(50% + 8px); }
            .grid-4x4 .tile[data-pos="3-2"] { left: calc(75% + 12px); top: calc(50% + 8px); }
            .grid-4x4 .tile[data-pos="0-3"] { left: 0%; top: calc(75% + 12px); }
            .grid-4x4 .tile[data-pos="1-3"] { left: calc(25% + 4px); top: calc(75% + 12px); }
            .grid-4x4 .tile[data-pos="2-3"] { left: calc(50% + 8px); top: calc(75% + 12px); }
            .grid-4x4 .tile[data-pos="3-3"] { left: calc(75% + 12px); top: calc(75% + 12px); }
            .grid-5x5 .tile[data-pos="0-0"] { left: 0%; top: 0%; }
            .grid-5x5 .tile[data-pos="1-0"] { left: calc(20% + 3.2px); top: 0%; }
            .grid-5x5 .tile[data-pos="2-0"] { left: calc(40% + 6.4px); top: 0%; }
            .grid-5x5 .tile[data-pos="3-0"] { left: calc(60% + 9.6px); top: 0%; }
            .grid-5x5 .tile[data-pos="4-0"] { left: calc(80% + 12.8px); top: 0%; }
            .grid-5x5 .tile[data-pos="0-1"] { left: 0%; top: calc(20% + 3.2px); }
            .grid-5x5 .tile[data-pos="1-1"] { left: calc(20% + 3.2px); top: calc(20% + 3.2px); }
            .grid-5x5 .tile[data-pos="2-1"] { left: calc(40% + 6.4px); top: calc(20% + 3.2px); }
            .grid-5x5 .tile[data-pos="3-1"] { left: calc(60% + 9.6px); top: calc(20% + 3.2px); }
            .grid-5x5 .tile[data-pos="4-1"] { left: calc(80% + 12.8px); top: calc(20% + 3.2px); }
            .grid-5x5 .tile[data-pos="0-2"] { left: 0%; top: calc(40% + 6.4px); }
            .grid-5x5 .tile[data-pos="1-2"] { left: calc(20% + 3.2px); top: calc(40% + 6.4px); }
            .grid-5x5 .tile[data-pos="2-2"] { left: calc(40% + 6.4px); top: calc(40% + 6.4px); }
            .grid-5x5 .tile[data-pos="3-2"] { left: calc(60% + 9.6px); top: calc(40% + 6.4px); }
            .grid-5x5 .tile[data-pos="4-2"] { left: calc(80% + 12.8px); top: calc(40% + 6.4px); }
            .grid-5x5 .tile[data-pos="0-3"] { left: 0%; top: calc(60% + 9.6px); }
            .grid-5x5 .tile[data-pos="1-3"] { left: calc(20% + 3.2px); top: calc(60% + 9.6px); }
            .grid-5x5 .tile[data-pos="2-3"] { left: calc(40% + 6.4px); top: calc(60% + 9.6px); }
            .grid-5x5 .tile[data-pos="3-3"] { left: calc(60% + 9.6px); top: calc(60% + 9.6px); }
            .grid-5x5 .tile[data-pos="4-3"] { left: calc(80% + 12.8px); top: calc(60% + 9.6px); }
            .grid-5x5 .tile[data-pos="0-4"] { left: 0%; top: calc(80% + 12.8px); }
            .grid-5x5 .tile[data-pos="1-4"] { left: calc(20% + 3.2px); top: calc(80% + 12.8px); }
            .grid-5x5 .tile[data-pos="2-4"] { left: calc(40% + 6.4px); top: calc(80% + 12.8px); }
            .grid-5x5 .tile[data-pos="3-4"] { left: calc(60% + 9.6px); top: calc(80% + 12.8px); }
            .grid-5x5 .tile[data-pos="4-4"] { left: calc(80% + 12.8px); top: calc(80% + 12.8px); }
            .btn-hover {
                transition: all 0.2s ease-in-out;
                will-change: transform, box-shadow;
            }
            .btn-hover:active, .btn-hover:focus:active {
                transform: translateY(0);
            }
            .modal-enter {
                opacity: 0;
                transform: scale(0.95);
            }
            .modal-enter-active {
                opacity: 1;
                transform: scale(1);
                transition: opacity 200ms, transform 200ms;
            }
            .modal-exit {
                opacity: 1;
            }
            .modal-exit-active {
                opacity: 0;
                transition: opacity 200ms;
            }
            .dark .bg-bg {
                background-color: theme('colors.dark.bg');
            }
            .dark .text-secondary {
                color: theme('colors.dark.text');
            }
            .dark .text-secondary\/80 {
                color: theme('colors.dark.muted');
            }
            .dark .bg-grid {
                background-color: theme('colors.dark.grid');
            }
            .dark .bg-primary {
                background-color: #ff8f00;
            }
            .dark #resume-button { background-color: #ff8f00; }
            .dark #resume-button:hover { background-color: #e65100; }
            .dark .bg-secondary {
                background-color: #4527a0;
            }
            .dark #new-game { background-color: #ff8f00; }
            .dark #endless-mode { background-color: #4527a0; }
            .dark #new-game:hover { background-color: #e65100; }
            .dark #endless-mode:hover { background-color: #311b92; }
            .dark .bg-easy {
                background-color: theme('colors.easy');
            }
            .dark .bg-medium {
                background-color: theme('colors.medium');
            }
            .dark .bg-hard {
                background-color: theme('colors.hard');
            }
            .dark #grid-3x3 { background-color: #2e7d32; }
            .dark #grid-4x4 { background-color: #1565c0; }
            .dark #grid-5x5 { background-color: #6a1b9a; }
            .dark #grid-3x3:hover { background-color: #1b5e20; }
            .dark #grid-4x4:hover { background-color: #0d47a1; }
            .dark #grid-5x5:hover { background-color: #4a148c; }
            .dark .bg-easy { background-color: #2e7d32; }
            .dark .bg-medium { background-color: #ff8f00; }
            .dark .bg-hard { background-color: #c62828; }
            .dark .bg-easy:hover { background-color: #1b5e20; }
            .dark .bg-medium:hover { background-color: #e65100; }
            .dark .bg-hard:hover { background-color: #b71c1c; }
            .dark .ring-easy {
                --tw-ring-color: theme('colors.easy');
            }
            .dark .ring-medium {
                --tw-ring-color: theme('colors.medium');
            }
            .dark .ring-hard {
                --tw-ring-color: theme('colors.hard');
            }
            .dark .bg-white {
                background-color: theme('colors.dark.surface');
            }
            .dark .text-white {
                color: theme('colors.dark.text');
            }
            .dark .text-white\/70 {
                color: theme('colors.dark.muted');
            }
            .dark .focus:ring-primary\/50 {
                --tw-ring-color: theme('colors.dark.primary');
            }
            .dark .focus:ring-easy\/50 {
                --tw-ring-color: theme('colors.easy');
            }
            .dark .focus:ring-medium\/50 {
                --tw-ring-color: theme('colors.medium');
            }
            .dark .focus:ring-hard\/50 {
                --tw-ring-color: theme('colors.hard');
            }
            .dark .btn-hover {
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            }
            .dark .game-message {
                background-color: rgba(0, 0, 0, 0.7);
            }
            .compact-header {
                flex-direction: column !important;
                align-items: flex-start !important;
            }
            .compact-title, .compact-description, .compact-buttons {
                text-align: left !important;
                justify-content: flex-start !important;
            }
            .compact-title {
                font-size: clamp(2rem, 8vw, 3rem) !important;
            }
            .compact-stats {
                flex-direction: column !important;
                gap: 0.5rem !important;
                margin-top: 1rem !important;
                width: 100% !important;
            }
            .compact-stats .bg-grid {
                padding: 0.5rem !important;
            }
            .compact-stats .text-xs {
                font-size: 0.65rem !important;
            }
            .compact-stats .text-xl {
                font-size: 1.25rem !important;
            }
            .compact-buttons {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            .compact-buttons button {
                padding: 0.75rem !important;
                font-size: 0.9rem !important;
            }
            .compact-difficulty {
                gap: 0.5rem !important;
            }
            .compact-difficulty button {
                padding: 0.5rem !important;
                font-size: 0.85rem !important;
            }
            .compact-description {
                font-size: 0.8rem !important;
            }
            .compact-message .bg-white {
                padding: 1.5rem !important;
                max-width: 85% !important;
            }
            .compact-message h2 {
                font-size: 1.5rem !important;
            }
            .compact-message button {
                padding: 0.75rem !important;
                font-size: 0.9rem !important;
            }
            .markdown-content h1 {
                font-size: 1.75rem;
                font-weight: bold;
                margin-bottom: 1rem;
                color: theme('colors.primary');
            }
            .markdown-content h2 {
                font-size: 1.5rem;
                font-weight: bold;
                margin-top: 1.5rem;
                margin-bottom: 0.75rem;
                color: theme('colors.secondary');
            }
            .markdown-content h3 {
                font-size: 1.25rem;
                font-weight: bold;
                margin-top: 1rem;
                margin-bottom: 0.5rem;
            }
            .markdown-content p {
                margin-bottom: 1rem;
                line-height: 1.5;
            }
            .markdown-content ul {
                list-style-type: disc;
                padding-left: 1.5rem;
                margin-bottom: 1rem;
            }
            .markdown-content ol {
                list-style-type: decimal;
                padding-left: 1.5rem;
                margin-bottom: 1rem;
            }
            .markdown-content li {
                margin-bottom: 0.5rem;
            }
            .markdown-content a {
                color: theme('colors.primary');
                text-decoration: underline;
            }
            .markdown-content a:hover {
                text-decoration: none;
            }
            .markdown-content strong {
                font-weight: bold;
            }
            .markdown-content em {
                font-style: italic;
            }
            .markdown-content code {
                background-color: rgba(0, 0, 0, 0.05);
                padding: 0.2rem 0.4rem;
                border-radius: 4px;
                font-family: monospace;
            }
            .dark .markdown-content code {
                background-color: rgba(255, 255, 255, 0.1);
            }
            .markdown-content blockquote {
                border-left: 4px solid theme('colors.primary');
                padding-left: 1rem;
                margin-left: 0;
                margin-bottom: 1rem;
                color: theme('colors.secondary/80');
            }
            .dark .markdown-content blockquote {
                color: theme('colors.dark.text');
            }
            .dark .markdown-content {
                color: theme('colors.dark.text');
            }
            .markdown-content hr {
                border: 0;
                border-top: 1px solid theme('colors.secondary/20');
                margin: 1.5rem 0;
            }
            .dark .markdown-content hr {
                border-top: 1px solid theme('colors.dark.muted/20');
            }
            .markdown-content .emoji {
                font-family: 'Apple Color Emoji', 'Segoe UI Emoji', 'NotoColorEmoji', 'Segoe UI Symbol', 'Android Emoji', 'EmojiSymbols';
            }
            .options-container {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                margin-bottom: 1rem;
            }
            .options-row {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                align-items: center;
            }
            .option-label {
                font-size: 0.85rem;
                color: theme('colors.secondary/80');
                white-space: nowrap;
                flex-shrink: 0;
            }
            .dark .option-label {
                color: theme('colors.dark.muted');
            }
            .option-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                flex: 1;
            }
            @media (max-width: 400px) {
                .options-row {
                    flex-direction: column;
                    align-items: flex-start;
                }
                .option-label {
                    margin-bottom: 0.25rem;
                }
                .option-buttons {
                    width: 100%;
                }
            }
            @media (max-width: 770px) {
                #game-header {
                    @apply compact-header;
                }
                #game-title {
                    @apply compact-title;
                }
                #game-header p {
                    @apply compact-description;
                }
            }
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #bbb;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #999;
        }
        .dark ::-webkit-scrollbar-track {
            background: #333;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #666;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        .dark .setting-label {
            color: #e0e0e0;
        }
        #mode-description, #difficulty-description {
            font-size: 0.8rem;
        }
        @media (max-height: 400px) {
            body {
                padding: 4px;
            }
            #game-header {
                margin-bottom: 4px;
            }
            #game-title {
                font-size: 1.75rem !important;
                margin-bottom: 0;
            }
            .compact-title {
                font-size: 1.75rem !important;
            }
            #game-header p {
                font-size: 0.7rem !important;
                margin-bottom: 4px;
            }
            #game-buttons {
                margin-bottom: 4px;
            }
            #new-game, #endless-mode {
                padding: 12px 16px !important;
                font-size: 1rem !important;
                min-height: 44px;
                min-width: 100px;
            }
            #undo-button, #pause-button {
                padding: 10px !important;
                font-size: 0.9rem !important;
                min-height: 40px;
                min-width: 40px;
            }
            .options-container {
                margin-bottom: 4px;
            }
            .options-row {
                margin-bottom: 2px;
            }
            .option-label {
                font-size: 0.6rem;
            }
            #grid-3x3, #grid-4x4, #grid-5x5, #easy-mode, #medium-mode, #hard-mode {
                padding: 8px 12px !important;
                font-size: 0.8rem !important;
                min-height: 36px;
            }
            .stats-container {
                margin-bottom: 4px;
            }
            .bg-grid {
                padding: 4px !important;
            }
            #score, #best-score {
                font-size: 1.2rem !important;
            }
            .text-xs {
                font-size: 0.7rem !important;
            }
            #mode-description, #difficulty-description {
                font-size: 0.7rem !important;
                margin-bottom: 2px;
            }
            #ai-analysis-button {
                width: 32px !important;
                height: 32px !important;
                font-size: 1rem !important;
                min-height: 32px;
                min-width: 32px;
            }
            .game-container {
                padding: 4px;
                border-radius: 4px;
                width: 90vw;
                height: 90vw;
                max-height: 360px;
                box-sizing: border-box;
                position: relative;
            }
            .grid-container, .tile-container {
                position: absolute;
                z-index: 1;
                width: calc(100% - 8px) !important;
                height: calc(100% - 8px) !important;
                top: 4px !important;
                left: 4px !important;
                padding: 0 !important;
                box-sizing: border-box !important;
                margin: 0 !important;
            }
            .grid-row {
                display: flex;
                margin-bottom: 0.5px;
                width: 100%;
            }
            .grid-row:last-child {
                margin-bottom: 0;
            }
            .grid-3x3 .grid-row {
                height: calc((100% - 1px) / 3);
            }
            .grid-4x4 .grid-row {
                height: calc((100% - 1.5px) / 4);
            }
            .grid-5x5 .grid-row {
                height: calc((100% - 2px) / 5);
            }
            .grid-cell {
                margin-right: 0.5px;
                border-radius: 1px;
                background: rgba(238, 228, 218, 0.35);
                height: 100%;
                flex: none;
                box-sizing: border-box !important;
            }
            .grid-cell:last-child {
                margin-right: 0;
            }
            .dark .grid-cell {
                background: rgba(84, 110, 122, 0.35);
            }
            .grid-3x3 .grid-cell {
                width: calc((100% - 1px) / 3);
            }
            .grid-4x4 .grid-cell {
                width: calc((100% - 1.5px) / 4);
            }
            .grid-5x5 .grid-cell {
                width: calc((100% - 2px) / 5);
            }
            .tile {
                position: absolute !important;
                border-radius: 1px;
                box-sizing: border-box !important;
                margin: 0 !important;
                padding: 0 !important;
                border: 1px solid transparent;
            }
            .grid-3x3 .tile {
                width: calc((100% - 1px) / 3);
                height: calc((100% - 1px) / 3);
                font-size: 1.2rem;
            }
            .grid-4x4 .tile {
                width: calc((100% - 1.5px) / 4);
                height: calc((100% - 1.5px) / 4);
                font-size: 1rem;
            }
            .grid-5x5 .tile {
                width: calc((100% - 2px) / 5);
                height: calc((100% - 2px) / 5);
                font-size: 0.9rem;
            }
            .grid-3x3 .tile[data-pos="0-0"] { left: 0 !important; top: 0 !important; }
            .grid-3x3 .tile[data-pos="1-0"] { left: calc(33.333% + 0.5px) !important; top: 0 !important; }
            .grid-3x3 .tile[data-pos="2-0"] { left: calc(66.666% + 1px) !important; top: 0 !important; }
            .grid-3x3 .tile[data-pos="0-1"] { left: 0 !important; top: calc(33.333% + 0.5px) !important; }
            .grid-3x3 .tile[data-pos="1-1"] { left: calc(33.333% + 0.5px) !important; top: calc(33.333% + 0.5px) !important; }
            .grid-3x3 .tile[data-pos="2-1"] { left: calc(66.666% + 1px) !important; top: calc(33.333% + 0.5px) !important; }
            .grid-3x3 .tile[data-pos="0-2"] { left: 0 !important; top: calc(66.666% + 1px) !important; }
            .grid-3x3 .tile[data-pos="1-2"] { left: calc(33.333% + 0.5px) !important; top: calc(66.666% + 1px) !important; }
            .grid-3x3 .tile[data-pos="2-2"] { left: calc(66.666% + 1px) !important; top: calc(66.666% + 1px) !important; }
            .grid-4x4 .tile[data-pos="0-0"] { left: 0 !important; top: 0 !important; }
            .grid-4x4 .tile[data-pos="1-0"] { left: calc(25% + 0.5px) !important; top: 0 !important; }
            .grid-4x4 .tile[data-pos="2-0"] { left: calc(50% + 1px) !important; top: 0 !important; }
            .grid-4x4 .tile[data-pos="3-0"] { left: calc(75% + 1.5px) !important; top: 0 !important; }
            .grid-4x4 .tile[data-pos="0-1"] { left: 0 !important; top: calc(25% + 0.5px) !important; }
            .grid-4x4 .tile[data-pos="1-1"] { left: calc(25% + 0.5px) !important; top: calc(25% + 0.5px) !important; }
            .grid-4x4 .tile[data-pos="2-1"] { left: calc(50% + 1px) !important; top: calc(25% + 0.5px) !important; }
            .grid-4x4 .tile[data-pos="3-1"] { left: calc(75% + 1.5px) !important; top: calc(25% + 0.5px) !important; }
            .grid-4x4 .tile[data-pos="0-2"] { left: 0 !important; top: calc(50% + 1px) !important; }
            .grid-4x4 .tile[data-pos="1-2"] { left: calc(25% + 0.5px) !important; top: calc(50% + 1px) !important; }
            .grid-4x4 .tile[data-pos="2-2"] { left: calc(50% + 1px) !important; top: calc(50% + 1px) !important; }
            .grid-4x4 .tile[data-pos="3-2"] { left: calc(75% + 1.5px) !important; top: calc(50% + 1px) !important; }
            .grid-4x4 .tile[data-pos="0-3"] { left: 0 !important; top: calc(75% + 1.5px) !important; }
            .grid-4x4 .tile[data-pos="1-3"] { left: calc(25% + 0.5px) !important; top: calc(75% + 1.5px) !important; }
            .grid-4x4 .tile[data-pos="2-3"] { left: calc(50% + 1px) !important; top: calc(75% + 1.5px) !important; }
            .grid-4x4 .tile[data-pos="3-3"] { left: calc(75% + 1.5px) !important; top: calc(75% + 1.5px) !important; }
            .grid-5x5 .tile[data-pos="0-0"] { left: 0 !important; top: 0 !important; }
            .grid-5x5 .tile[data-pos="1-0"] { left: calc(20% + 0.5px) !important; top: 0 !important; }
            .grid-5x5 .tile[data-pos="2-0"] { left: calc(40% + 1px) !important; top: 0 !important; }
            .grid-5x5 .tile[data-pos="3-0"] { left: calc(60% + 1.5px) !important; top: 0 !important; }
            .grid-5x5 .tile[data-pos="4-0"] { left: calc(80% + 2px) !important; top: 0 !important; }
            .grid-5x5 .tile[data-pos="0-1"] { left: 0 !important; top: calc(20% + 0.5px) !important; }
            .grid-5x5 .tile[data-pos="1-1"] { left: calc(20% + 0.5px) !important; top: calc(20% + 0.5px) !important; }
            .grid-5x5 .tile[data-pos="2-1"] { left: calc(40% + 1px) !important; top: calc(20% + 0.5px) !important; }
            .grid-5x5 .tile[data-pos="3-1"] { left: calc(60% + 1.5px) !important; top: calc(20% + 0.5px) !important; }
            .grid-5x5 .tile[data-pos="4-1"] { left: calc(80% + 2px) !important; top: calc(20% + 0.5px) !important; }
            .grid-5x5 .tile[data-pos="0-2"] { left: 0 !important; top: calc(40% + 1px) !important; }
            .grid-5x5 .tile[data-pos="1-2"] { left: calc(20% + 0.5px) !important; top: calc(40% + 1px) !important; }
            .grid-5x5 .tile[data-pos="2-2"] { left: calc(40% + 1px) !important; top: calc(40% + 1px) !important; }
            .grid-5x5 .tile[data-pos="3-2"] { left: calc(60% + 1.5px) !important; top: calc(40% + 1px) !important; }
            .grid-5x5 .tile[data-pos="4-2"] { left: calc(80% + 2px) !important; top: calc(40% + 1px) !important; }
            .grid-5x5 .tile[data-pos="0-3"] { left: 0 !important; top: calc(60% + 1.5px) !important; }
            .grid-5x5 .tile[data-pos="1-3"] { left: calc(20% + 0.5px) !important; top: calc(60% + 1.5px) !important; }
            .grid-5x5 .tile[data-pos="2-3"] { left: calc(40% + 1px) !important; top: calc(60% + 1.5px) !important; }
            .grid-5x5 .tile[data-pos="3-3"] { left: calc(60% + 1.5px) !important; top: calc(60% + 1.5px) !important; }
            .grid-5x5 .tile[data-pos="4-3"] { left: calc(80% + 2px) !important; top: calc(60% + 1.5px) !important; }
            .grid-5x5 .tile[data-pos="0-4"] { left: 0 !important; top: calc(80% + 2px) !important; }
            .grid-5x5 .tile[data-pos="1-4"] { left: calc(20% + 0.5px) !important; top: calc(80% + 2px) !important; }
            .grid-5x5 .tile[data-pos="2-4"] { left: calc(40% + 1px) !important; top: calc(80% + 2px) !important; }
            .grid-5x5 .tile[data-pos="3-4"] { left: calc(60% + 1.5px) !important; top: calc(80% + 2px) !important; }
            .grid-5x5 .tile[data-pos="4-4"] { left: calc(80% + 2px) !important; top: calc(80% + 2px) !important; }
            #game-touch-area {
                height: 4px;
            }
            footer {
                margin-top: 4px;
                padding: 2px;
                font-size: 0.6rem;
            }
            .button-text {
                display: inline !important;
            }
        }
        @media (max-width: 400px) and (max-height: 400px) {
            .grid-3x3 .tile {
                font-size: 1.2rem !important;
            }
            .grid-4x4 .tile {
                font-size: 1rem !important;
            }
            .grid-5x5 .tile {
                font-size: 0.9rem !important;
            }
            body {
                padding: 4px;
            }
            #game-header {
                margin-bottom: 4px;
            }
            #game-title {
                font-size: 1.5rem !important;
                margin-bottom: 0;
            }
            .compact-title {
                font-size: 1.5rem !important;
            }
            #game-header p {
                font-size: 0.7rem !important;
                margin-bottom: 4px;
            }
            #game-buttons {
                margin-bottom: 4px;
            }
            #new-game, #endless-mode {
                padding: 12px 16px !important;
                font-size: 1rem !important;
                min-height: 44px;
                min-width: 100px;
            }
            #undo-button, #pause-button {
                padding: 10px !important;
                font-size: 0.9rem !important;
                min-height: 40px;
                min-width: 40px;
            }
            .options-container {
                margin-bottom: 4px;
            }
            .options-row {
                margin-bottom: 2px;
            }
            .option-label {
                font-size: 0.7rem;
            }
            #grid-3x3, #grid-4x4, #grid-5x5, #easy-mode, #medium-mode, #hard-mode {
                padding: 8px 12px !important;
                font-size: 0.8rem !important;
                min-height: 36px;
            }
            .stats-container {
                margin-bottom: 4px;
            }
            .bg-grid {
                padding: 4px !important;
            }
            #score, #best-score {
                font-size: 1.2rem !important;
            }
            .text-xs {
                font-size: 0.7rem !important;
            }
            #mode-description, #difficulty-description {
                font-size: 0.7rem !important;
                margin-bottom: 2px;
            }
            #ai-analysis-button {
                width: 32px !important;
                height: 32px !important;
                font-size: 1rem !important;
                min-height: 32px;
                min-width: 32px;
            }
            .game-container {
                padding: clamp(2px, 1.5vw, 4px);
                border-radius: 2px;
            }
            .grid-cell {
                margin-right: clamp(2px, 1.5vw, 4px);
                border-radius: 1px;
            }
            .grid-row {
                margin-bottom: clamp(2px, 1.5vw, 4px);
            }
            .tile {
                border-radius: 1px;
                font-size: 0.5rem;
                box-shadow: none;
            }
            #game-touch-area {
                height: 4px;
            }
            footer {
                margin-top: 4px;
                padding: 2px;
                font-size: 0.6rem;
            }
            .button-text, .prefix-text, .mode-text {
                display: inline !important;
            }
            .icon-margin {
                margin-right: 0.25rem !important;
            }
            #new-game .mr-2, #endless-mode .mr-2, #undo-button .mr-1, #pause-button .mr-1 {
                margin-right: 0.5rem !important;
            }
        }
        .ai-analysis-modal {
            position: fixed;top: 0;left: 0;right: 0;bottom: 0;background: rgba(0,0,0,0.5);display: flex;align-items: center;justify-content: center;z-index: 1000; opacity: 0; transform: scale(0.9); visibility: hidden; transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease; 
        }
        .dark .ai-analysis-modal {
            background: rgba(0,0,0,0.7);
        }
        .ai-analysis-modal:not(.hidden) {
            opacity: 1; transform: scale(1); visibility: visible; 
        }
        .ai-analysis-content {
            background: white;padding: 20px;border-radius: 8px;max-width: 500px;width: 90%;max-height: 80vh;overflow-y: auto;position: relative;
        }
        .dark .ai-analysis-content {
            background: #2d3748;color: white;
        }
        .ai-analysis-title {
            font-size: 18px;font-weight: bold;margin-bottom: 15px;padding-bottom: 10px;border-bottom: 1px solid #eee;position: relative;
        }
        .dark .ai-analysis-title {
            border-bottom: 1px solid #4a5568;
        }
        .analysis-item {
            margin-bottom: 15px;
        }
        .analysis-label {
            font-weight: bold;margin-bottom: 5px;color: #666;
        }
        .dark .analysis-label {
            color: #a0aec0;
        }
        .analysis-value {
            padding: 8px 12px;background: #f5f5f5;border-radius: 4px;
        }
        .dark .analysis-value {
            background: #4a5568;
        }
        .best-move {
            background: #e8f5e9;color: #2e7d32;font-weight: bold;
        }
        .dark .best-move {
            background: #48bb78;color: #f0fff4;
        }
        .blur-sm {
            filter: blur(5px);
            transition: filter 0.3s ease;
        }
        .best-move-text {
            transition: filter 0.3s ease;
        }
        #toggle-best-move {
            width: 24px;
            text-align: center;
            padding: 0;
        }
        .custom-select .select-selected i, .custom-select .select-item i {
            width: 20px;
            display: inline-block;
            text-align: center;
        }
        #game-state-assessment {
            font-weight: bold;
        }
        #game-state-assessment.good {
            background: #e8f5e9;color: #2e7d32;
        }
        .dark #game-state-assessment.good {
            background: #48bb78;color: #f0fff4;
        }
        #game-state-assessment.average {
            background: #fff8e1;color: #ff8f00;
        }
        .dark #game-state-assessment.average {
            background: #ffb74d;color: #ffffff;
        }
        #game-state-assessment.danger {
            background: #ffebee;color: #c62828;
        }
        .dark #game-state-assessment.danger {
            background: #e57373;color: #ffebee;
        }
        #merge-opportunities {
            font-weight: bold;
        }
        #merge-opportunities.high {
            background: #e8f5e9;color: #2e7d32;
        }
        .dark #merge-opportunities.high {
            background: #48bb78;color: #f0fff4;
        }
        #merge-opportunities.medium {
            background: #fff8e1;color: #ff8f00;
        }
        .dark #merge-opportunities.medium {
            background: #ffb74d;color: #ffffff;
        }
        #merge-opportunities.low {
            background: #ffebee;color: #c62828;
        }
        .dark #merge-opportunities.low {
            background: #e57373;color: #ffebee;
        }
        #score-potential {
            font-weight: bold;
        }
        #score-potential.high {
            background: #e8f5e9;color: #2e7d32;
        }
        .dark #score-potential.high {
            background: #48bb78;color: #f0fff4;
        }
        #score-potential.medium {
            background: #fff8e1;color: #ff8f00;
        }
        .dark #score-potential.medium {
            background: #ffb74d;color: #ffffff;
        }
        #score-potential.low {
            background: #ffebee;color: #c62828;
        }
        .dark #score-potential.low {
            background: #e57373;color: #ffebee;
        }
    </style>
</head>
<body class="bg-bg font-game min-h-screen flex flex-col items-center justify-center p-4 transition-colors duration-300">
    <main class="max-w-md w-full mx-auto">
        <header id="game-header" class="flex flex-col md:flex-row justify-between items-center mb-6">
            <div>
                <h1 id="game-title" class="text-[clamp(2.5rem,5vw,3.5rem)] font-bold text-secondary dark:text-dark-text mb-1 tracking-tight">2048</h1>
                <p class="text-[clamp(1rem,2vw,1.2rem)] text-secondary/80 dark:text-dark-muted">滑动合并方块，创建<span class="font-bold">2048</span>！</p>
            </div>
        <style>
            .custom-select {
                position: relative;
            }
            .select-selected {
                user-select: none;
            }
            .select-selected i {
                transition: transform 0.3s ease;
            }
            .select-selected.active i {
                transform: rotate(180deg);
            }
            .select-items {
                user-select: none;
                overflow-y: auto;
                max-height: 200px;
            }
            .select-item {
                display: flex;
                align-items: center;
                font-family: 'Font Awesome 6 Free', sans-serif;
                font-weight: 900;
            }
            .select-item.selected { 
                background-color: #d1d5db;
            }
            .dark .select-item.selected { 
                background-color: #4b5563;
            }
            .select-selected span {
                font-family: 'Font Awesome 6 Free', sans-serif;
                font-weight: 900;
            }
        </style>
            <div class="flex gap-2 mt-4 md:mt-0">
                <button id="undo-button" class="bg-grid hover:bg-grid/80 text-white p-2 rounded-md shadow-md transition-all duration-200 focus:outline-none dark:bg-dark-grid w-[72px]" title="撤销上一步">
                    <i class="fa-solid fa-undo mr-1"></i><span>撤销</span>
                </button>
                <button id="pause-button" class="bg-grid hover:bg-grid/80 text-white p-2 rounded-md shadow-md transition-all duration-200 focus:outline-none dark:bg-dark-grid w-[72px]" title="暂停游戏">
                    <i class="fa-solid fa-pause mr-1"></i><span>暂停</span>
                </button>
            </div>
        </header>
        <div id="game-buttons" class="flex flex-wrap gap-2 mb-4">
            <button id="new-game" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-6 rounded-md shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-primary/50 flex-1 btn-hover dark:bg-dark-primary">
                <i class="fa-solid fa-gamepad mr-2"></i><span>标准模式</span>
            </button>
            <button id="endless-mode" class="bg-secondary hover:bg-secondary/90 text-white font-bold py-3 px-6 rounded-md shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-secondary/50 flex-1 btn-hover dark:bg-dark-secondary">
                <i class="fa-solid fa-infinity mr-2"></i><span>无尽模式</span>
            </button>
        </div>
        <div class="options-container mb-4">
            <div class="options-row">
                <span class="option-label">网格大小:</span>
                <div class="option-buttons">
                    <button id="grid-3x3" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-green-300 btn-hover w-16">
                        <i class="fa-solid fa-square-three"></i>3×3
                    </button>
                    <button id="grid-4x4" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-300 btn-hover active w-16">
                        <i class="fa-solid fa-square-four"></i>4×4
                    </button>
                    <button id="grid-5x5" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-purple-300 btn-hover w-16">
                        <i class="fa-solid fa-square-five"></i>5×5
                    </button>
                    <button id="custom-grid" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-300 btn-hover w-20" title="自定义网格大小">
                        自定义
                    </button>
                </div>
            </div>
            <div class="options-row">
                <span class="option-label">难度选择:</span>
                <div class="option-buttons">
                    <button id="easy-mode" class="bg-easy hover:bg-easy/90 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-easy/50 flex-1 btn-hover">
                        <i class="fa-solid fa-shield-check"></i>简单
                    </button>
                    <button id="medium-mode" class="bg-medium hover:bg-medium/90 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-medium/50 flex-1 btn-hover active">
                        <i class="fa-solid fa-shield-half"></i>中等
                    </button>
                    <button id="hard-mode" class="bg-hard hover:bg-hard/90 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-hard/50 flex-1 btn-hover">
                        <i class="fa-solid fa-shield-exclamation"></i>困难
                    </button>
                </div>
            </div>
        </div>
        <div class="stats-container flex justify-between mb-4">
            <div class="bg-grid dark:bg-dark-grid text-center rounded-md p-3 flex-1 mr-2">
                <div class="text-xs uppercase text-white/70 dark:text-dark-muted">分数</div>
                <div id="score" class="text-xl font-bold text-white dark:text-dark-text">0</div>
            </div>
            <div class="bg-grid dark:bg-dark-grid text-center rounded-md p-3 flex-1">
                <div class="text-xs uppercase text-white/70 dark:text-dark-muted">最高分</div>
                <div id="best-score" class="text-xl font-bold text-white dark:text-dark-text">0</div>
            </div>
        </div>
        <div class="flex justify-between items-center mb-4">
            <div>
                <div class="text-secondary/80 dark:text-dark-muted mb-2" id="mode-description">
                    当前模式：标准模式 - 达到2048获胜
                </div>
                <div id="difficulty-description" class="text-secondary/80 dark:text-dark-muted">
                    当前难度：中等 - 4x4网格
                </div>
            </div>
            <button id="ai-analysis-button" class="bg-primary dark:bg-dark-primary hover:bg-primary/90 text-white w-12 h-12 rounded-full shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-primary/50 flex items-center justify-center">
                <i class="fa-solid fa-robot dark:text-[#282828]"></i>
            </button>
        </div>
        <div class="game-container grid-4x4" id="game-container" role="application" tabindex="0" aria-label="2048游戏棋盘 - 使用方向键或WASD键移动方块" aria-live="polite" aria-describedby="game-instructions">
            <div class="grid-container" id="grid-container"></div>
            <div class="tile-container" id="tile-container"></div>
        </div>
        <div id="game-touch-area" class="mt-4 h-5 bg-transparent"></div>
        <div id="game-message" class="fixed inset-0 flex items-center justify-center bg-black/50 z-50 hidden" role="dialog" aria-labelledby="game-message-title" aria-modal="true">
            <div class="bg-white rounded-lg p-6 max-w-md w-full max-h-[90vh] overflow-y-auto text-center shadow-xl transform transition-all duration-300 ease-in-out scale-95 opacity-0">
                <h2 id="game-message-title" class="text-2xl font-bold text-secondary mb-4">恭喜你获胜！</h2>
                <p id="game-message-text" class="text-secondary/80 mb-6">你达到了2048分，可以继续游戏挑战更高分数，或者重新开始。</p>
                <button id="game-message-button" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-6 rounded-md shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-primary/50">
                    <i class="fa-solid fa-refresh mr-2"></i>再玩一次
                </button>
            </div>
        </div>
        <div id="pause-menu" class="fixed inset-0 flex items-center justify-center bg-black/50 z-50 hidden" role="dialog" aria-labelledby="pause-menu-title" aria-modal="true">
            <div class="bg-white rounded-lg p-6 max-w-md w-full max-h-[90vh] overflow-y-auto text-center shadow-xl transform transition-all duration-300 ease-in-out scale-95 opacity-0">
                <h2 id="pause-menu-title" class="text-2xl font-bold text-secondary mb-4">游戏暂停</h2>
                <div class="flex flex-col gap-4">
                    <button id="resume-button" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-6 rounded-md shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-primary/50">
                        <i class="fa-solid fa-play mr-2"></i><span>继续游戏</span>
                    </button>
                    <button id="restart-button" class="bg-secondary hover:bg-secondary/90 text-white font-bold py-3 px-6 rounded-md shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-secondary/50">
                        <i class="fa-solid fa-refresh mr-2"></i><span>重新开始</span>
                    </button>
                    <div class="flex justify-center gap-4 mt-2">
                        <button id="settings-button" class="text-primary hover:text-primary/80 focus:outline-none text-sm">
                            <i class="fa-solid fa-cog mr-1"></i><span>设置</span>
                        </button>
                     </div>
                </div>
            </div>
        </div>
        <div id="settings-modal" class="fixed inset-0 flex items-center justify-center bg-black/50 z-50 hidden" role="dialog" aria-labelledby="settings-modal-title" aria-modal="true">
            <div class="bg-gray-50 dark:bg-dark-surface rounded-lg p-6 max-w-md w-full max-h-[90vh] overflow-y-auto text-center shadow-xl transform transition-all duration-300 scale-95 opacity-0">
                <h2 id="settings-modal-title" class="text-2xl font-bold text-secondary mb-4">设置</h2>
                <div class="flex flex-col gap-3">
                    <div class="setting-category">
                        <h3 class="text-base font-semibold text-secondary mb-2 text-left category-title flex items-center">
                            <i class="fa-solid fa-gauge-high mr-2"></i>游戏性能
                        </h3>
                        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600 py-3 px-2 shadow-sm">
                            <div class="flex items-center justify-between mb-2 px-2">
                                <span class="text-gray-700 dark:text-dark-muted">GPU加速</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="gpu-acceleration" class="sr-only peer" checked title="GPU加速">
                                    <div class="w-11 h-6 bg-gray-300 dark:bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary peer-checked:hover:bg-primary/90 peer-checked:dark:hover:bg-primary/90 transition-all duration-300 hover:shadow-md dark:hover:bg-gray-500 dark:hover:shadow-lg"></div>
                                </label>
                            </div>
                            <div class="border-b border-gray-200 dark:border-gray-700 my-3 mx-2"></div>
                            <div class="flex items-center justify-between px-2">
                                <span class="text-gray-700 dark:text-dark-muted">滑块动画</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="tile-animation" class="sr-only peer" checked title="滑块动画">
                                    <div class="w-11 h-6 bg-gray-300 dark:bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary peer-checked:hover:bg-primary/90 peer-checked:dark:hover:bg-primary/90 transition-all duration-300 hover:shadow-md dark:hover:bg-gray-500 dark:hover:shadow-lg"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="setting-category">
                        <h3 class="text-base font-semibold text-secondary mb-2 text-left category-title flex items-center">
                            <i class="fa-solid fa-paint-roller mr-2"></i>外观设置
                        </h3>
                        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600 p-3 shadow-sm">
                            <div class="flex items-center justify-between mt-2 mb-2 px-2">
                                <label for="theme-toggle" class="text-gray-700 dark:text-dark-muted">主题</label>
                                <div class="custom-select relative w-full max-w-[180px]">
                                    <div class="select-selected flex items-center justify-between px-3 py-2 bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-white rounded-md border border-gray-300 dark:border-gray-600 cursor-pointer transition-all duration-200 hover:border-primary/50">
                                        <span><i class="fa-solid fa-desktop mr-1"></i>跟随浏览器</span>
                                        <i class="fa fa-chevron-down text-xs ml-2 text-gray-500 dark:text-gray-400"></i>
                                    </div>
                                    <div class="select-items absolute mt-1 w-full bg-gray-100 dark:bg-gray-800 rounded-md shadow-lg border border-gray-300 dark:border-gray-600 z-20 max-h-0 opacity-0 overflow-y-auto transition-all duration-300 ease-in-out">
                                        <div class="select-item px-3 py-2 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-800 dark:text-white cursor-pointer transition-colors" data-value="auto"><i class="fa-solid fa-desktop mr-1"></i>跟随浏览器</div>
                                        <div class="select-item px-3 py-2 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-800 dark:text-white cursor-pointer transition-colors" data-value="light"><i class="fa-solid fa-sun mr-1"></i>浅色</div>
                                        <div class="select-item px-3 py-2 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-800 dark:text-white cursor-pointer transition-colors" data-value="dark"><i class="fa-solid fa-moon mr-1"></i>深色</div>
                                        <div class="select-item px-3 py-2 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-800 dark:text-white cursor-pointer transition-colors" data-value="custom"><i class="fa-solid fa-palette mr-1"></i>自定义</div>
                                    </div>
                                </div>
                                <select id="theme-toggle" style="display: none;" class="bg-grid text-gray-800 dark:text-white p-2 rounded-md shadow-md transition-all duration-200 focus:outline-none dark:bg-dark-grid" title="选择主题">
                                    <option value="auto">&#xf108; 跟随浏览器</option>
                                    <option value="light">&#xf185; 浅色</option>
                                    <option value="dark">&#xf186; 深色</option>
                                    <option value="custom">&#xf53f; 自定义</option>
                                </select>
                            </div>
                            <div id="custom-theme-button-container" class="flex justify-end px-2 mt-1">
                                <button id="custom-theme-button" style="display: none;" class="px-3 py-1 bg-primary hover:bg-primary/90 text-white rounded-md text-sm transition-all duration-200">
                                    <i class="fa-solid fa-palette mr-1"></i>自定义主题设置
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="setting-category">
                        <h3 class="text-base font-semibold text-secondary mb-2 text-left category-title flex items-center">
                            <i class="fa-solid fa-database mr-2"></i>数据与管理
                        </h3>
                        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600 p-2 shadow-sm">
                            <button id="data-transfer-button" class="flex items-center justify-between w-full px-4 py-3 text-gray-700 dark:text-dark-muted hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none transition-all duration-200 rounded-lg">
                                数据管理
                                <i class="fa-solid fa-chevron-right text-xs"></i>
                            </button>
                        </div>
                    </div>
                    <div class="text-sm text-secondary/70 mt-4">2048 v1.22.0 | by TheFurina</div>
                    <button id="reset-settings-button" class="text-gray-500 hover:text-gray-700 focus:outline-none text-sm inline-block mx-auto">
                        <i class="fa-solid fa-rotate-right mr-1"></i><span>重置所有设置</span>
                    </button>
                    <button id="close-settings-button" class="text-secondary/60 hover:text-secondary focus:outline-none absolute top-5 right-8 text-xl" title="关闭设置">
                        <i class="fa-solid fa-times"></i>
                    </button>
                    <div class="flex justify-end">
                        <a href="https://github.com/TheFurina/2048-game" class="text-primary hover:underline flex items-center gap-1 text-xs" target="_blank"><i class="fa-brands fa-github"></i> 项目主页</a>
                    </div>
                </div>
            </div>
        </div>
        <div id="custom-theme-modal" class="fixed inset-0 flex items-center justify-center bg-black/50 z-50 hidden" role="dialog" aria-labelledby="custom-theme-modal-title" aria-modal="true">
            <div class="bg-gray-50 dark:bg-dark-surface rounded-lg max-w-2xl w-full max-h-[90vh] shadow-xl transform transition-all duration-300 scale-95 opacity-0 flex flex-col">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h2 id="custom-theme-modal-title" class="text-2xl font-bold text-secondary">自定义主题</h2>
                    <button id="close-custom-theme-modal" class="text-secondary/60 hover:text-secondary focus:outline-none text-xl" title="关闭">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            <div class="flex-1 p-6 overflow-y-auto">
                <div class="flex flex-col gap-4">
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600 p-4">
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-dark-text mb-3">基础颜色</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="flex flex-col">
                            <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">主背景色</label>
                            <div class="flex items-center gap-2">
                                <input type="color" id="custom-bg-color" value="#faf8ef" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                <input type="text" id="custom-bg-color-text" value="#faf8ef" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">主色调</label>
                            <div class="flex items-center gap-2">
                                <input type="color" id="custom-primary-color" value="#faa31b" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                <input type="text" id="custom-primary-color-text" value="#faa31b" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">次色调</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-secondary-color" value="#8f7a66" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-secondary-color-text" value="#8f7a66" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">网格颜色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-grid-color" value="#bbada0" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-grid-color-text" value="#bbada0" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600 p-4">
                        <h3 class="text-lg font-semibold text-gray-700 dark:text-dark-text mb-3">模态框颜色</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">模态框背景色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-modal-bg" value="#ffffff" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-modal-bg-text" value="#ffffff" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">模态框文字颜色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-modal-text" value="#333333" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-modal-text-text" value="#333333" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600 p-4">
                        <h3 class="text-lg font-semibold text-gray-700 dark:text-dark-text mb-3">滑块颜色</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 2 背景色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-2-bg" value="#eee4da" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-2-bg-text" value="#eee4da" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 2 文字颜色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-2-text" value="#776e65" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-2-text-text" value="#776e65" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 4 背景色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-4-bg" value="#ede0c8" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-4-bg-text" value="#ede0c8" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 4 文字颜色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-4-text" value="#776e65" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-4-text-text" value="#776e65" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 8 背景色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-8-bg" value="#f2b179" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-8-bg-text" value="#f2b179" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 8 文字颜色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-8-text" value="#f9f6f2" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-8-text-text" value="#f9f6f2" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 16 背景色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-16-bg" value="#f59563" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-16-bg-text" value="#f59563" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 16 文字颜色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-16-text" value="#f9f6f2" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-16-text-text" value="#f9f6f2" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 32 背景色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-32-bg" value="#f67c5f" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-32-bg-text" value="#f67c5f" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 32 文字颜色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-32-text" value="#f9f6f2" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-32-text-text" value="#f9f6f2" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 64 背景色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-64-bg" value="#f65e3b" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-64-bg-text" value="#f65e3b" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 64 文字颜色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-64-text" value="#f9f6f2" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-64-text-text" value="#f9f6f2" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 128 背景色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-128-bg" value="#edcf72" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-128-bg-text" value="#edcf72" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 128 文字颜色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-128-text" value="#f9f6f2" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-128-text-text" value="#f9f6f2" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 256 背景色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-256-bg" value="#edcc61" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-256-bg-text" value="#edcc61" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 256 文字颜色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-256-text" value="#f9f6f2" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-256-text-text" value="#f9f6f2" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 512 背景色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-512-bg" value="#edc850" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-512-bg-text" value="#edc850" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 512 文字颜色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-512-text" value="#f9f6f2" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-512-text-text" value="#f9f6f2" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 1024 背景色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-1024-bg" value="#edc53f" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-1024-bg-text" value="#edc53f" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 1024 文字颜色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-1024-text" value="#f9f6f2" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-1024-text-text" value="#f9f6f2" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 2048 背景色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-2048-bg" value="#edc22e" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-2048-bg-text" value="#edc22e" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 2048 文字颜色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-2048-text" value="#f9f6f2" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-2048-text-text" value="#f9f6f2" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 4096 背景色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-4096-bg" value="#e65100" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-4096-bg-text" value="#e65100" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 4096 文字颜色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-4096-text" value="#ffffff" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-4096-text-text" value="#ffffff" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 8192 背景色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-8192-bg" value="#bf360c" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-8192-bg-text" value="#bf360c" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 8192 文字颜色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-8192-text" value="#ffffff" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-8192-text-text" value="#ffffff" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 16384 背景色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-16384-bg" value="#880e4f" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-16384-bg-text" value="#880e4f" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 16384 文字颜色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-16384-text" value="#ffffff" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-16384-text-text" value="#ffffff" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 32768 背景色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-32768-bg" value="#4a148c" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-32768-bg-text" value="#4a148c" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">数字 32768 文字颜色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-32768-text" value="#ffffff" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-32768-text-text" value="#ffffff" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">更大数字 背景色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-super-bg" value="#311b92" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-super-bg-text" value="#311b92" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm text-gray-700 dark:text-dark-muted mb-1">更大数字 文字颜色</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="custom-tile-super-text" value="#ffffff" class="w-10 h-10 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                                    <input type="text" id="custom-tile-super-text-text" value="#ffffff" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-dark-surface rounded-b-lg">
                <div class="flex flex-wrap gap-3 justify-center">
                    <button id="save-custom-theme" class="px-4 py-2 bg-primary hover:bg-primary/90 text-white rounded-md transition-all duration-200 flex-1 sm:flex-none sm:min-w-[120px]">
                        <i class="fa-solid fa-save mr-1"></i>保存
                    </button>
                    <button id="reset-custom-theme" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 text-gray-800 dark:text-white rounded-md transition-all duration-200 flex-1 sm:flex-none sm:min-w-[120px]">
                        <i class="fa-solid fa-rotate-right mr-1"></i>重置
                    </button>
                </div>
            </div>
        </div>
    </div>
        <div id="data-transfer-modal" class="fixed inset-0 flex items-center justify-center bg-black/50 z-50 hidden" role="dialog" aria-labelledby="data-transfer-modal-title" aria-modal="true">
            <div class="bg-white rounded-lg p-6 max-w-md w-full max-h-[90vh] overflow-y-auto text-center shadow-xl transform transition-all duration-300 ease-in-out scale-95 opacity-0">
                <h2 id="data-transfer-modal-title" class="text-2xl font-bold text-secondary mb-4">数据管理</h2>
                <div class="flex flex-col gap-3 mb-4">
                    <button id="export-data-button" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-6 rounded-md shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-primary/50">
                        <i class="fa-solid fa-upload mr-2"></i>导出数据
                    </button>
                    <button id="import-data-button" class="bg-secondary hover:bg-secondary/90 text-white font-bold py-3 px-6 rounded-md shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-secondary/50">
                        <i class="fa-solid fa-download mr-2"></i>导入数据
                    </button>
                </div>
                <div class="relative w-full mb-4">
                    <textarea id="data-textarea" class="w-full p-3 border border-gray-300 rounded-md h-32 text-sm dark:bg-dark-surface dark:border-dark-muted dark:text-dark-text" placeholder="在此复制导出的数据或输入要导入的数据..."></textarea>
                    <button id="copy-data-button" class="absolute top-2 right-2 p-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-md opacity-0 invisible transition-all duration-200 focus:outline-none" title="复制数据">
                        <i class="fa-solid fa-copy text-gray-600 dark:text-gray-300"></i>
                    </button>
                </div>
                <div class="mb-2">
                    <button id="clear-data-exit-button" class="text-red-500 hover:text-red-700 font-normal py-0 px-1 transition-all duration-200 focus:outline-none" onclick="if(confirm('确定要清除所有数据并退出吗？')) { localStorage.clear(); window.close(); }">
                        <i class="fa-solid fa-trash-alt mr-1"></i>清除数据并退出
                    </button>
                </div>
                <button id="close-data-modal" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-gray/50">
                    <i class="fa-solid fa-times mr-2"></i>关闭
                </button>
            </div>
        </div>
        <div id="custom-grid-modal" class="fixed inset-0 flex items-center justify-center bg-black/50 z-50 hidden" role="dialog" aria-labelledby="custom-grid-modal-title" aria-modal="true">
            <div class="bg-white dark:bg-dark-surface rounded-lg p-6 max-w-md w-full max-h-[90vh] overflow-y-auto text-center shadow-xl transform transition-all duration-300 ease-in-out scale-95 opacity-0">
                <h2 id="custom-grid-modal-title" class="text-2xl font-bold text-secondary dark:text-dark-text mb-4">自定义网格大小</h2>
                <div class="mb-4">
                    <label for="grid-size-input" class="block text-sm font-medium text-gray-700 dark:text-dark-muted mb-2">请输入网格大小 (3-10):</label>
                    <div class="flex items-center justify-center gap-2">
                        <input type="number" id="grid-size-input" min="3" max="10" value="4" class="w-20 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-center dark:bg-dark-surface dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <span class="text-gray-600 dark:text-dark-muted">×</span>
                        <input type="number" id="grid-size-input-2" min="3" max="10" value="4" class="w-20 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-center dark:bg-dark-surface dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="mt-2">
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="square-grid" checked class="rounded border-gray-300 dark:border-gray-600 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            <span class="ml-2 text-sm text-gray-700 dark:text-dark-muted">正方形网格 (锁定宽高比)</span>
                        </label>
                    </div>
                </div>
                <div class="flex flex-wrap gap-3 justify-center">
                    <button id="apply-custom-grid" class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-md transition-all duration-200 flex-1 sm:flex-none sm:min-w-[120px]">
                        <i class="fa-solid fa-check mr-1"></i>应用
                    </button>
                    <button id="cancel-custom-grid" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 text-gray-800 dark:text-white rounded-md transition-all duration-200 flex-1 sm:flex-none sm:min-w-[120px]">
                        <i class="fa-solid fa-times mr-1"></i>取消
                    </button>
                </div>
            </div>
        </div>
        <footer class="mt-6 py-3 text-center text-secondary/50 dark:text-dark-muted/50 text-base">
            <p><i class="fa-solid fa-cube mr-2"></i>滑动之间 数字新生</p>
        </footer>
    </div>
    <script>
        const config = { // 游戏配置
            initialTiles: 2, // 初始生成的方块数量
            winningValue: 2048, // 获胜目标值
            touchThreshold: 10, // 触摸滑动的最小距离
            maxUndoSteps: 10, // 最大撤销步数
            animationDuration: 150, // 滑块移动动画持续时间（毫秒）
            difficultySettings: { // 难度设置
                easy: { // 简单
                    fourProbability: 0.4, // 4出现的概率为40%
                    scoreMultiplier: 1 // 得分乘数
                },
                medium: { // 中等
                    fourProbability: 0.1, // 4出现的概率为10%
                    scoreMultiplier: 1 // 得分乘数
                },
                hard: { // 困难
                    fourProbability: 0.05, // 4出现的概率为5%
                    scoreMultiplier: 1.5 // 得分乘数
                }
            }
        };
        const gameState = {
            gpuAccelerationEnabled: localStorage.getItem('2048-gpu-acceleration') !== 'false',
            tileAnimationEnabled: localStorage.getItem('2048-tile-animation') !== 'false',
            grid: [],
            gridSize: 4,
            gridRows: 4,
            gridCols: 4,
            score: 0,
            bestScore: 0,
            gameOver: false,
            gameWon: false,
            isEndlessMode: false,
            isPaused: false,
            difficulty: 'medium',
            history: [],
            touchStartX: 0,
            touchStartY: 0,
            touchEndX: 0,
            touchEndY: 0
        };
        let lastFocusedElement = null;
        const focusableElements = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
        function handleModalKeyDown(e) {
            const modalId = e.currentTarget.id;
            if (e.key === 'Escape') {
                hideModal(modalId);
            } else if (e.key === 'Tab') {
                const focusable = Array.from(e.currentTarget.querySelectorAll(focusableElements));
                const currentIndex = focusable.indexOf(document.activeElement);
                if (focusable.length > 0) {
                    if (e.shiftKey) {
                        const prevIndex = (currentIndex - 1 + focusable.length) % focusable.length;
                        focusable[prevIndex].focus();
                    } else {
                        const nextIndex = (currentIndex + 1) % focusable.length;
                        focusable[nextIndex].focus();
                    }
                    e.preventDefault();
                }
            } else if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                const focusable = Array.from(e.currentTarget.querySelectorAll(focusableElements));
                const currentIndex = focusable.indexOf(document.activeElement);
                if (focusable.length > 0) {
                    let nextIndex = currentIndex;
                    if (e.key === 'ArrowDown' || e.key === 'ArrowRight') {
                        nextIndex = (currentIndex + 1) % focusable.length;
                    } else if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
                        nextIndex = (currentIndex - 1 + focusable.length) % focusable.length;
                    }
                    focusable[nextIndex].focus();
                    e.preventDefault();
                }
            }
        }
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                lastFocusedElement = document.activeElement;
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.querySelector('div').classList.remove('scale-95', 'opacity-0');
                    modal.querySelector('div').classList.add('scale-100', 'opacity-100');
                    const focusable = modal.querySelectorAll(focusableElements);
                    if (focusable.length > 0) {
                        focusable[0].focus();
                    }
                    modal.addEventListener('keydown', handleModalKeyDown);
                }, 10);
            }
        }
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.querySelector('div').classList.remove('scale-100', 'opacity-100');
                modal.querySelector('div').classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    if (lastFocusedElement && document.contains(lastFocusedElement)) {
                        lastFocusedElement.focus();
                    }
                    modal.removeEventListener('keydown', handleModalKeyDown);
                }, 300);
            }
        }
        function exportGameData() { const data = { grid: gameState.grid, score: gameState.score, bestScore: gameState.bestScore, gridSize: gameState.gridSize, gridRows: gameState.gridRows, gridCols: gameState.gridCols, difficulty: gameState.difficulty, isEndlessMode: gameState.isEndlessMode, timestamp: new Date().toISOString() }; const dataStr = btoa(JSON.stringify(data)); document.getElementById('data-textarea').value = dataStr; }
        function copyDataToClipboard() { const textarea = document.getElementById('data-textarea'); textarea.select(); document.execCommand('copy'); const copyButton = document.getElementById('copy-data-button'); const originalIcon = copyButton.innerHTML; copyButton.innerHTML = '<i class="fa-solid fa-check text-green-600 dark:text-green-400"></i>'; setTimeout(() => { copyButton.innerHTML = originalIcon; }, 2000); }
        document.addEventListener('DOMContentLoaded', () => { 
            console.log('%c   ____     ___    _  _      ___                                        \n  |___ \\   / _ \\  | || |    ( _ )      __ _    __ _   _ __ ___     ___ \n    __) | | | | | | || |_   / _ \\     / _` |  / _` | | \'_ ` _ \\   / _ \\ \n   / __/  | |_| | |__   _| | (_) |   | (_| | | (_| | | | | | | | |  __/ \n  |_____|  \\___/     |_|    \\___/     \\__, |  \\__,_| |_| |_| |_|  \\___| \n                                      |___/                            ', 'color: #faa31b; font-size: 14px;');
            console.log('2048 v1.22.0');
            const textareaContainer = document.querySelector('.relative.w-full.mb-4'); 
            const copyButton = document.getElementById('copy-data-button'); 
            if (textareaContainer && copyButton) { 
                textareaContainer.addEventListener('mouseenter', () => { 
                    copyButton.classList.remove('opacity-0', 'invisible'); 
                    copyButton.classList.add('opacity-70', 'visible'); 
                }); 
                textareaContainer.addEventListener('mouseleave', () => { 
                    copyButton.classList.add('opacity-0', 'invisible'); 
                    copyButton.classList.remove('opacity-70', 'visible'); 
                }); 
                copyButton.addEventListener('click', copyDataToClipboard); 
            } 
        });
        function importGameData(dataStr) { 
            try { 
                if (!dataStr) throw new Error('数据不能为空');
                let decodedData;
                try { 
                    decodedData = atob(dataStr);
                } catch (e) { 
                    throw new Error('无效的Base64格式');
                } 
                let data;
                try { 
                    data = JSON.parse(decodedData);
                } catch (e) { 
                    throw new Error('JSON解析失败：' + e.message);
                } 
                if (!data || typeof data !== 'object') throw new Error('数据必须是有效的JSON对象');
                const requiredFields = ['grid', 'score', 'bestScore', 'gridSize', 'difficulty', 'isEndlessMode'];
                const missingFields = requiredFields.filter(field => !(field in data));
                if (missingFields.length > 0) throw new Error('缺少必要字段：' + missingFields.join(', '));
                if (!Array.isArray(data.grid) || data.grid.length === 0) throw new Error('无效的游戏网格数据');
                const gridRows = data.gridRows || data.gridSize;
                const gridCols = data.gridCols || data.gridSize;
                if (data.grid.length !== gridRows || data.grid.some(row => row.length !== gridCols)) {
                    throw new Error(`导入的滑块数字指示的网格大小(${data.grid.length}x${data.grid[0]?.length || 0})与导入数据指示的网格大小(${gridRows}x${gridCols})不一致`);
                }
        const invalidTiles = data.grid.flatMap(row => row.filter(tile => tile && (tile.value <= 0 || (tile.value & (tile.value - 1)) !== 0)));
        if (invalidTiles.length > 0) {
            throw new Error('导入的滑块数字必须是2的次幂');
        }
                gameState.grid = data.grid;
                gameState.score = data.score;
                gameState.bestScore = data.bestScore;
                gameState.gridSize = data.gridSize;
                gameState.gridRows = gridRows;
                gameState.gridCols = gridCols;
                gameState.difficulty = data.difficulty;
                gameState.isEndlessMode = data.isEndlessMode;
                document.querySelector('.game-container').classList.remove('grid-3x3', 'grid-4x4', 'grid-5x5');
                document.querySelector('.game-container').classList.add(`grid-${gridRows}x${gridCols}`);
                generateGridStyles(null, gridRows, gridCols);
                initGridContainer();
                updateDocumentTitle();
                renderAllTiles();
                elements.scoreDisplay.textContent = gameState.score;
                elements.bestScoreDisplay.textContent = gameState.bestScore;
                elements.modeDescription.textContent = gameState.isEndlessMode ? "当前模式：无尽模式 - 尽可能获得高分" : "当前模式：标准模式 - 达到2048获胜";
                elements.difficultyDescription.textContent = `当前难度：${getDifficultyName()} - ${gridRows}×${gridCols}网格`; 
                saveGameState();
                gameState.history = [];
                updateUndoButtonState();
                alert('数据导入成功！');
            } catch (e) { 
                alert('导入失败：' + e.message);
            } 
        }
        const elements = {
            gridContainer: document.getElementById('grid-container'),
            tileContainer: document.getElementById('tile-container'),
            scoreDisplay: document.getElementById('score'),
            bestScoreDisplay: document.getElementById('best-score'),
            newGameButton: document.getElementById('new-game'),
            endlessModeButton: document.getElementById('endless-mode'),
            retryGameButton: document.getElementById('retry-game'),
            pauseButton: document.getElementById('pause-button'),
            resumeButton: document.getElementById('resume-button'),
            restartButton: document.getElementById('restart-button'),
            undoButton: document.getElementById('undo-button'),
            themeToggle: document.getElementById('theme-toggle'),
            gameMessage: document.getElementById('game-message'),
            gameMessageTitle: document.getElementById('game-message-title'),
            gameMessageText: document.getElementById('game-message-text'),
            gameMessageButton: document.getElementById('game-message-button'),
            pauseMenu: document.getElementById('pause-menu'),
            settingsModal: document.getElementById('settings-modal'),
            settingsButton: document.getElementById('settings-button'),
            closeSettingsButton: document.getElementById('close-settings-button'),
            easyModeButton: document.getElementById('easy-mode'),
            mediumModeButton: document.getElementById('medium-mode'),
            hardModeButton: document.getElementById('hard-mode'),
            grid3x3Button: document.getElementById('grid-3x3'),
            grid4x4Button: document.getElementById('grid-4x4'),
            grid5x5Button: document.getElementById('grid-5x5'),
            customGridButton: document.getElementById('custom-grid'),
            customGridModal: document.getElementById('custom-grid-modal'),
            gridSizeInput: document.getElementById('grid-size-input'),
            gridSizeInput2: document.getElementById('grid-size-input-2'),
            squareGridCheckbox: document.getElementById('square-grid'),
            applyCustomGridButton: document.getElementById('apply-custom-grid'),
            cancelCustomGridButton: document.getElementById('cancel-custom-grid'),
            modeDescription: document.getElementById('mode-description'),
            difficultyDescription: document.getElementById('difficulty-description'),
            resetSettingsButton: document.getElementById('reset-settings-button'),
            gameHeader: document.getElementById('game-header'),
            gameTitle: document.getElementById('game-title'),
            statsContainer: document.getElementById('stats-container'),
            gameButtons: document.getElementById('game-buttons'),
            difficultyButtons: document.getElementById('difficulty-buttons'),
            gameDescription: document.querySelector('.text-secondary\\/80.dark\\:text-dark-muted.mb-2'),
            gameTouchArea: document.getElementById('game-touch-area'),
            gameContainer: document.querySelector('.game-container'),
            tileAnimation: document.getElementById('tile-animation')
        };
        function updateDocumentTitle() {
            const mode = gameState.isEndlessMode ? '无尽模式' : '标准模式';
            const difficulty = getDifficultyName();
            document.title = `2048 | ${mode} | ${difficulty} | ${gameState.gridRows}×${gameState.gridCols} | 分数: ${gameState.score}`;
        }
        function createEmptyGrid() {
            const grid = [];
            for (let y = 0; y < gameState.gridRows; y++) {
                grid[y] = [];
                for (let x = 0; x < gameState.gridCols; x++) {
                    grid[y][x] = null;
                }
            }
            return grid;
        }
        function generateGridStyles(gridSize, gridRows, gridCols) {
            for (let i = 3; i <= 10; i++) {
                for (let j = 3; j <= 10; j++) {
                    const customStyleId = `grid-${i}x${j}-styles`;
                    const existingCustomStyle = document.getElementById(customStyleId);
                    if (existingCustomStyle) {
                        existingCustomStyle.remove();
                    }
                }
            }
            if (gridRows === gridCols && (gridRows === 3 || gridRows === 4 || gridRows === 5)) {
                return;
            }
            const styleId = `grid-${gridRows}x${gridCols}-styles`;
            const existingStyle = document.getElementById(styleId);
            if (existingStyle) {
                existingStyle.remove();
            }
            const style = document.createElement('style');
            style.id = styleId;
            const isSmallScreen = window.matchMedia('(max-width: 400px) and (max-height: 400px)').matches;
            const gapSize = isSmallScreen ? 'clamp(2px, 1.5vw, 4px)' : 'clamp(8px, 3vw, 16px)';
            const totalHorizontalGap = `(${gridCols} - 1) * ${gapSize}`;
            const totalVerticalGap = `(${gridRows} - 1) * ${gapSize}`;
            const mediaQuery = isSmallScreen ? 
                `@media (max-width: 400px) and (max-height: 400px)` : 
                `@media (min-width: 401px), (min-height: 401px)`;
            style.textContent = `
                ${mediaQuery} {
                    .grid-${gridRows}x${gridCols} .grid-row {
                        height: calc((100% - ${totalVerticalGap}) / ${gridRows});
                        margin-bottom: ${gapSize} !important;
                    }
                    .grid-${gridRows}x${gridCols} .grid-row:last-child {
                        margin-bottom: 0 !important;
                    }
                    .grid-${gridRows}x${gridCols} .grid-cell {
                        width: calc((100% - ${totalHorizontalGap}) / ${gridCols});
                        margin-right: ${gapSize} !important;
                    }
                    .grid-${gridRows}x${gridCols} .grid-cell:last-child {
                        margin-right: 0 !important;
                    }
                    .grid-${gridRows}x${gridCols} .tile {
                        width: calc((100% - ${totalHorizontalGap}) / ${gridCols});
                        height: calc((100% - ${totalVerticalGap}) / ${gridRows});
                        font-size: ${Math.max(0.6, 2.5 - Math.max(gridRows, gridCols) * 0.2)}rem;
                    }
                    ${generateTilePositions(gridRows, gridCols, isSmallScreen)}
                }
            `;
            document.head.appendChild(style);
        }
        function generateTilePositions(gridRows, gridCols, isSmallScreen = false) {
            let styles = '';
            const gapSize = isSmallScreen ? 'clamp(2px, 1.5vw, 4px)' : 'clamp(8px, 3vw, 16px)';
            const totalHorizontalGap = `(${gridCols} - 1) * ${gapSize}`;
            const totalVerticalGap = `(${gridRows} - 1) * ${gapSize}`;
            const tileSize = `calc((100% - ${totalHorizontalGap}) / ${gridCols})`;
            const tileHeight = `calc((100% - ${totalVerticalGap}) / ${gridRows})`;
            for (let y = 0; y < gridRows; y++) {
                for (let x = 0; x < gridCols; x++) {
                    const leftPos = `calc(${x} * (${tileSize} + ${gapSize}))`;
                    const topPos = `calc(${y} * (${tileHeight} + ${gapSize}))`;
                    styles += `.grid-${gridRows}x${gridCols} .tile[data-pos="${x}-${y}"] { left: ${leftPos}; top: ${topPos}; }\n`;
                }
            }
            return styles;
        }
        function initGridContainer() {
            elements.gridContainer.innerHTML = '';
            for (let y = 0; y < gameState.gridRows; y++) {
                const gridRow = document.createElement('div');
                gridRow.className = 'grid-row';
                for (let x = 0; x < gameState.gridCols; x++) {
                    const gridCell = document.createElement('div');
                    gridCell.className = 'grid-cell';
                    gridRow.appendChild(gridCell);
                }
                elements.gridContainer.appendChild(gridRow);
            }
        }
        function generateRandomTile() {
            const availableCells = [];
            for (let y = 0; y < gameState.gridRows; y++) {
                for (let x = 0; x < gameState.gridCols; x++) {
                    if (gameState.grid[y][x] === null) {
                        availableCells.push({ x, y });
                    }
                }
            }
            if (availableCells.length > 0) {
                const cell = availableCells[Math.floor(Math.random() * availableCells.length)];
                const difficulty = config.difficultySettings[gameState.difficulty] || { fourProbability: 0.1 };
                const value = Math.random() < difficulty.fourProbability ? 4 : 2;
                gameState.grid[cell.y][cell.x] = {
                    value,
                    merged: false,
                    new: true
                };
                renderTile(cell.x, cell.y);
                return true;
            }
            return false;
        }
        function renderTile(x, y, animate = true) {
            const tile = gameState.grid[y][x];
            if (!tile) return;
            const isSmallScreen = window.matchMedia('(max-width: 400px) and (max-height: 400px)').matches;
            const gapSize = isSmallScreen ? 'clamp(2px, 1.5vw, 4px)' : 'clamp(8px, 3vw, 16px)';
            const totalHorizontalGap = `(${gameState.gridCols} - 1) * ${gapSize}`;
            const totalVerticalGap = `(${gameState.gridRows} - 1) * ${gapSize}`;
            const tileSize = `calc((100% - ${totalHorizontalGap}) / ${gameState.gridCols})`;
            const tileHeight = `calc((100% - ${totalVerticalGap}) / ${gameState.gridRows})`;
            const leftPos = `calc(${x} * (${tileSize} + ${gapSize}))`;
            const topPos = `calc(${y} * (${tileHeight} + ${gapSize}))`;
            let tileElement = elements.tileContainer.querySelector(`.tile[data-pos="${x}-${y}"]`);
            if (!tileElement) {
                tileElement = document.createElement('div');
                tileElement.dataset.pos = `${x}-${y}`;
                elements.tileContainer.appendChild(tileElement);
                tileElement.style.transition = 'none';
                tileElement.style.left = leftPos;
                tileElement.style.top = topPos;
                void tileElement.offsetWidth;
            }
            const animationClass = gameState.tileAnimationEnabled && animate ? 'transition-all duration-150' : '';
            tileElement.className = `tile tile-${tile.value} ${gameState.tileAnimationEnabled && tile.new ? 'tile-appear' : ''} ${tile.value > 32768 ? 'tile-super' : ''} ${tile.value >= 10000 ? 'tile-5digit' : ''} ${gameState.gpuAccelerationEnabled ? 'gpu-accelerated' : ''} ${animationClass}`;
            tileElement.textContent = tile.value;
            if (gameState.tileAnimationEnabled && animate) {
                tileElement.style.transition = 'left 200ms cubic-bezier(0.34, 1.56, 0.64, 1), top 200ms cubic-bezier(0.34, 1.56, 0.64, 1), transform 200ms cubic-bezier(0.34, 1.56, 0.64, 1)'
            }
            tileElement.style.left = leftPos;
            tileElement.style.top = topPos;
            if (tile.new) {
                setTimeout(() => {
                    tile.new = false;
                }, 200);
            }
        }
        function renderAllTiles(animate = true) {
            const currentTiles = {};
            const tileElements = elements.tileContainer.querySelectorAll('.tile');
            tileElements.forEach(tile => {
                const pos = tile.dataset.pos;
                currentTiles[pos] = tile;
            });
            const preservedPositions = new Set();
            for (let y = 0; y < gameState.gridRows; y++) {
                for (let x = 0; x < gameState.gridCols; x++) {
                    if (gameState.grid[y][x]) {
                        const posKey = `${x}-${y}`;
                        preservedPositions.add(posKey);
                        renderTile(x, y, animate);
                    }
                }
            }
            Object.keys(currentTiles).forEach(pos => {
                if (!preservedPositions.has(pos)) {
                    const tile = currentTiles[pos];
                    if (gameState.tileAnimationEnabled && animate) {
                        tile.style.transition = 'opacity 200ms cubic-bezier(0.34, 1.56, 0.64, 1)'
                        tile.style.opacity = '0';
                        setTimeout(() => {
                            if (tile.parentNode === elements.tileContainer) {
                                elements.tileContainer.removeChild(tile);
                            }
                        }, 150);
                    } else {
                        if (tile.parentNode === elements.tileContainer) {
                            elements.tileContainer.removeChild(tile);
                        }
                    }
                }
            });
        }
        function move(direction) {
            const modal = document.getElementById('ai-analysis-modal');
            if (gameState.isPaused || gameState.gameOver || !elements.gameMessage.classList.contains('hidden') || !modal.classList.contains('hidden')) return false;
            saveHistory();
            let moved = false;
            const moveLog = [];
            for (let y = 0; y < gameState.gridRows; y++) {
                for (let x = 0; x < gameState.gridCols; x++) {
                    if (gameState.grid[y][x]) {
                        gameState.grid[y][x].merged = false;
                        moveLog.push({
                            originalX: x,
                            originalY: y,
                            value: gameState.grid[y][x].value,
                            tile: { ...gameState.grid[y][x] }
                        });
                    }
                }
            }
            switch(direction) {
                case 'up':
                    for (let x = 0; x < gameState.gridCols; x++) {
                        for (let y = 1; y < gameState.gridRows; y++) {
                            if (gameState.grid[y][x]) {
                                let newY = y;
                                while (newY > 0 && gameState.grid[newY - 1][x] === null) {
                                    newY--;
                                }
                                if (newY > 0 && gameState.grid[newY - 1][x] && 
                                    gameState.grid[newY - 1][x].value === gameState.grid[y][x].value &&
                                    !gameState.grid[newY - 1][x].merged) {
                                    gameState.grid[newY - 1][x].value *= 2;
                                    gameState.grid[newY - 1][x].merged = true;
                                    const mergedTile = gameState.grid[newY - 1][x];
                                    mergedTile.mergedAnimation = true;
                                    gameState.grid[y][x] = null;
                                    const difficulty = config.difficultySettings[gameState.difficulty] || { scoreMultiplier: 1 };
                                    gameState.score += gameState.grid[newY - 1][x].value * difficulty.scoreMultiplier;
                                    if (gameState.score > gameState.bestScore) {
                                        gameState.bestScore = gameState.score;
                                        elements.bestScoreDisplay.textContent = gameState.bestScore;
                                    }
                                    elements.scoreDisplay.textContent = gameState.score;
                                    updateDocumentTitle();
                                    moved = true;
                                } else if (newY !== y) {
                                    gameState.grid[newY][x] = gameState.grid[y][x];
                                    gameState.grid[y][x] = null;
                                    moved = true;
                                }
                            }
                        }
                    }
                    break;
                case 'down':
                    for (let x = 0; x < gameState.gridCols; x++) {
                        for (let y = gameState.gridRows - 2; y >= 0; y--) {
                            if (gameState.grid[y][x]) {
                                let newY = y;
                                while (newY < gameState.gridRows - 1 && gameState.grid[newY + 1][x] === null) {
                                    newY++;
                                }
                                if (newY < gameState.gridRows - 1 && gameState.grid[newY + 1][x] && 
                                    gameState.grid[newY + 1][x].value === gameState.grid[y][x].value &&
                                    !gameState.grid[newY + 1][x].merged) {
                                    gameState.grid[newY + 1][x].value *= 2;
                                    gameState.grid[newY + 1][x].merged = true;
                                    const mergedTile = gameState.grid[newY + 1][x];
                                    mergedTile.mergedAnimation = true;
                                    gameState.grid[y][x] = null;
                                    const difficulty = config.difficultySettings[gameState.difficulty] || { scoreMultiplier: 1 };
                                    gameState.score += gameState.grid[newY + 1][x].value * difficulty.scoreMultiplier;
                                    if (gameState.score > gameState.bestScore) {
                                        gameState.bestScore = gameState.score;
                                        elements.bestScoreDisplay.textContent = gameState.bestScore;
                                    }
                                    elements.scoreDisplay.textContent = gameState.score;
                                    updateDocumentTitle();
                                    moved = true;
                                } else if (newY !== y) {
                                    gameState.grid[newY][x] = gameState.grid[y][x];
                                    gameState.grid[y][x] = null;
                                    moved = true;
                                }
                            }
                        }
                    }
                    break;
                case 'left':
                    for (let y = 0; y < gameState.gridRows; y++) {
                        for (let x = 1; x < gameState.gridCols; x++) {
                            if (gameState.grid[y][x]) {
                                let newX = x;
                                while (newX > 0 && gameState.grid[y][newX - 1] === null) {
                                    newX--;
                                }
                                if (newX > 0 && gameState.grid[y][newX - 1] && 
                                    gameState.grid[y][newX - 1].value === gameState.grid[y][x].value &&
                                    !gameState.grid[y][newX - 1].merged) {
                                    gameState.grid[y][newX - 1].value *= 2;
                                    gameState.grid[y][newX - 1].merged = true;
                                    const mergedTile = gameState.grid[y][newX - 1];
                                    mergedTile.mergedAnimation = true;
                                    gameState.grid[y][x] = null;
                                    const difficulty = config.difficultySettings[gameState.difficulty] || { scoreMultiplier: 1 };
                                    gameState.score += gameState.grid[y][newX - 1].value * difficulty.scoreMultiplier;
                                    if (gameState.score > gameState.bestScore) {
                                        gameState.bestScore = gameState.score;
                                        elements.bestScoreDisplay.textContent = gameState.bestScore;
                                    }
                                    elements.scoreDisplay.textContent = gameState.score;
                                    updateDocumentTitle();
                                    moved = true;
                                } else if (newX !== x) {
                                    gameState.grid[y][newX] = gameState.grid[y][x];
                                    gameState.grid[y][x] = null;
                                    moved = true;
                                }
                            }
                        }
                    }
                    break;
                case 'right':
                    for (let y = 0; y < gameState.gridRows; y++) {
                        for (let x = gameState.gridCols - 2; x >= 0; x--) {
                            if (gameState.grid[y][x]) {
                                let newX = x;
                                while (newX < gameState.gridCols - 1 && gameState.grid[y][newX + 1] === null) {
                                    newX++;
                                }
                                if (newX < gameState.gridCols - 1 && gameState.grid[y][newX + 1] && 
                                    gameState.grid[y][newX + 1].value === gameState.grid[y][x].value &&
                                    !gameState.grid[y][newX + 1].merged) {
                                    gameState.grid[y][newX + 1].value *= 2;
                                    gameState.grid[y][newX + 1].merged = true;
                                    const mergedTile = gameState.grid[y][newX + 1];
                                    mergedTile.mergedAnimation = true;
                                    gameState.grid[y][x] = null;
                                    const difficulty = config.difficultySettings[gameState.difficulty] || { scoreMultiplier: 1 };
                                    gameState.score += gameState.grid[y][newX + 1].value * difficulty.scoreMultiplier;
                                    if (gameState.score > gameState.bestScore) {
                                        gameState.bestScore = gameState.score;
                                        elements.bestScoreDisplay.textContent = gameState.bestScore;
                                    }
                                    elements.scoreDisplay.textContent = gameState.score;
                                    updateDocumentTitle();
                                    moved = true;
                                } else if (newX !== x) {
                                    gameState.grid[y][newX] = gameState.grid[y][x];
                                    gameState.grid[y][x] = null;
                                    moved = true;
                                }
                            }
                        }
                    }
                    break;
            }
            if (moved) {
                if (gameState.tileAnimationEnabled) {
                    renderAllTiles(true);
                    setTimeout(() => {
                        if (gameState.tileAnimationEnabled) {
                            for (let y = 0; y < gameState.gridRows; y++) {
                                for (let x = 0; x < gameState.gridCols; x++) {
                                    if (gameState.grid[y][x] && gameState.grid[y][x].mergedAnimation) {
                                        const tileElement = elements.tileContainer.querySelector(`.tile[data-pos="${x}-${y}"]`);
                                        if (tileElement) {
                                            tileElement.classList.add('tile-merge');
                                            setTimeout(() => {
                                                if (gameState.grid[y][x]) {
                                                    gameState.grid[y][x].mergedAnimation = false;
                                                }
                                            }, config.animationDuration);
                                        }
                                    }
                                }
                            }
                        } else {
                            for (let y = 0; y < gameState.gridRows; y++) {
                                for (let x = 0; x < gameState.gridCols; x++) {
                                    if (gameState.grid[y][x]) {
                                        gameState.grid[y][x].mergedAnimation = false;
                                    }
                                }
                            }
                        }
                    }, 10);
                    setTimeout(() => {
                        generateRandomTile();
                        if (!gameState.gameWon) {
                            checkWin();
                        }
                        checkGameOver();
                        saveGameState();
                    }, config.animationDuration);
                } else {
                    renderAllTiles(false);
                    setTimeout(() => {
                        generateRandomTile();
                        if (!gameState.gameWon) {
                            checkWin();
                        }
                        checkGameOver();
                        saveGameState();
                    }, 10);
                }
            }
            updateUndoButtonState();
            return moved;
        }
        function checkWin() {
            for (let y = 0; y < gameState.gridRows; y++) {
                for (let x = 0; x < gameState.gridCols; x++) {
                    if (gameState.grid[y][x] && gameState.grid[y][x].value >= config.winningValue) {
                        gameState.gameWon = true;
                        if (!gameState.isEndlessMode) {
                            showGameMessage("恭喜你获胜！", "你达到了2048分，可以继续游戏挑战更高分数，或者重新开始。");
                        }
                        return true;
                    }
                }
            }
            return false;
        }
        function checkGameOver() {
            for (let y = 0; y < gameState.gridRows; y++) {
                for (let x = 0; x < gameState.gridCols; x++) {
                    if (gameState.grid[y][x] === null) {
                        return false;
                    }
                }
            }
            for (let y = 0; y < gameState.gridRows; y++) {
                for (let x = 0; x < gameState.gridCols; x++) {
                    const value = gameState.grid[y][x].value;
                    if (x < gameState.gridCols - 1 && gameState.grid[y][x + 1] && gameState.grid[y][x + 1].value === value) {
                        return false;
                    }
                    if (y < gameState.gridRows - 1 && gameState.grid[y + 1][x] && gameState.grid[y + 1][x].value === value) {
                        return false;
                    }
                }
            }
            gameState.gameOver = true;
            showGameMessage("游戏结束！", "无法进行任何移动。");
            return true;
        }
        function showGameMessage(title, text) {
            elements.gameMessageTitle.textContent = title;
            elements.gameMessageText.textContent = text;
            elements.gameMessage.classList.remove('hidden');
            setTimeout(() => {
                const messageBox = elements.gameMessage.querySelector('.bg-white');
                messageBox.classList.add('scale-100');
                messageBox.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }
        function hideGameMessage() {
            const messageBox = elements.gameMessage.querySelector('.bg-white');
            messageBox.classList.remove('scale-100');
            messageBox.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                elements.gameMessage.classList.add('hidden');
            }, 200);
        }
        function togglePause() {
            gameState.isPaused = !gameState.isPaused;
            if (gameState.isPaused) {
                elements.pauseMenu.classList.remove('hidden');
                setTimeout(() => {
                    const pauseBox = elements.pauseMenu.querySelector('.bg-white');
                    pauseBox.classList.add('scale-100');
                    pauseBox.classList.remove('scale-95', 'opacity-0');
                    const focusable = elements.pauseMenu.querySelectorAll(focusableElements);
                    if (focusable.length > 0) {
                        focusable[0].focus();
                    }
                    elements.pauseMenu.addEventListener('keydown', handleModalKeyDown);
                }, 10);
            } else {
                const pauseBox = elements.pauseMenu.querySelector('.bg-white');
                pauseBox.classList.remove('scale-100');
                pauseBox.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    elements.pauseMenu.classList.add('hidden');
                    elements.pauseMenu.removeEventListener('keydown', handleModalKeyDown);
                }, 200);
            }
        }
        function saveHistory() {
            const gridCopy = JSON.parse(JSON.stringify(gameState.grid));
            gameState.history.push({
                grid: gridCopy,
                score: gameState.score
            });
            if (gameState.history.length > config.maxUndoSteps) {
                gameState.history.shift();
            }
            updateUndoButtonState();
        }
        function undoMove() {
            if (gameState.history.length === 0) return;
            const lastState = gameState.history.pop();
            gameState.grid = lastState.grid;
            gameState.score = lastState.score;
            elements.scoreDisplay.textContent = gameState.score;
            renderAllTiles();
            gameState.gameOver = false;
            gameState.gameWon = false;
            hideGameMessage();
            updateDocumentTitle();
            saveGameState();
            updateUndoButtonState();
        }
        function updateUndoButtonState() {
            if (gameState.history.length === 0) {
                elements.undoButton.disabled = true;
                elements.undoButton.classList.add('opacity-50', 'cursor-not-allowed');
                elements.undoButton.title = '无法撤销（没有历史记录）';
            } else {
                elements.undoButton.disabled = false;
                elements.undoButton.classList.remove('opacity-50', 'cursor-not-allowed');
                elements.undoButton.title = `撤销上一步（可撤销 ${gameState.history.length} 步）`;
            }
        }
        function updateDifficultyButtons() {
            elements.easyModeButton.classList.remove('ring-2', 'ring-easy/50');
            elements.mediumModeButton.classList.remove('ring-2', 'ring-medium/50');
            elements.hardModeButton.classList.remove('ring-2', 'ring-hard/50');
            switch(gameState.difficulty) {
                case 'easy':
                    elements.easyModeButton.classList.add('ring-2', 'ring-easy/50');
                    break;
                case 'medium':
                    elements.mediumModeButton.classList.add('ring-2', 'ring-medium/50');
                    break;
                case 'hard':
                    elements.hardModeButton.classList.add('ring-2', 'ring-hard/50');
                    break;
            }
        }
        function updateGridButtonState(gridSize) {
            elements.grid3x3Button.classList.remove('ring-2', 'ring-green-300');
            elements.grid4x4Button.classList.remove('ring-2', 'ring-blue-300');
            elements.grid5x5Button.classList.remove('ring-2', 'ring-purple-300');
            switch(gridSize) {
                case 3:
                    elements.grid3x3Button.classList.add('ring-2', 'ring-green-300');
                    break;
                case 4:
                    elements.grid4x4Button.classList.add('ring-2', 'ring-blue-300');
                    break;
                case 5:
                    elements.grid5x5Button.classList.add('ring-2', 'ring-purple-300');
                    break;
            }
        }
        function getDifficultyName() {
            switch(gameState.difficulty) {
                case 'easy': return '简单';
                case 'medium': return '中等';
                case 'hard': return '困难';
                default: return '中等';
            }
        }
        elements.dataTransferButton = document.getElementById('data-transfer-button');
        elements.dataTransferModal = document.getElementById('data-transfer-modal');
        elements.exportDataButton = document.getElementById('export-data-button');
        elements.importDataButton = document.getElementById('import-data-button');
        elements.dataTextarea = document.getElementById('data-textarea');
        elements.closeDataModal = document.getElementById('close-data-modal');
        function setupDataTransfer() {
            function handleImportClick() {
                const data = elements.dataTextarea.value.trim();
                if (data && confirm('确定要导入数据吗？这将覆盖当前游戏状态。')) {
                    importGameData(data);
                }
            }
            elements.dataTransferButton.addEventListener('click', () => {
                const modal = document.getElementById('data-transfer-modal');
                modal.classList.remove('hidden');
                modal.classList.add('modal-enter');
                setTimeout(() => {
                    modal.classList.add('modal-enter-active');
                }, 10);
            });
            elements.exportDataButton.addEventListener('click', () => {
                exportGameData();
            });
            elements.importDataButton.removeEventListener('click', handleImportClick);
            elements.importDataButton.addEventListener('click', handleImportClick);
            elements.closeDataModal.addEventListener('click', () => {
                const modal = document.getElementById('data-transfer-modal');
                modal.classList.add('modal-exit-active');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.classList.remove('modal-exit-active', 'modal-enter', 'modal-enter-active');
                }, 300);
            });
        }
        window.addEventListener('load', setupDataTransfer);
        function saveGameState() {
            localStorage.setItem('2048-game-state', JSON.stringify({
                grid: gameState.grid,
                gridSize: gameState.gridSize,
                gridRows: gameState.gridRows,
                gridCols: gameState.gridCols,
                score: gameState.score,
                bestScore: gameState.bestScore,
                gameOver: gameState.gameOver,
                gameWon: gameState.gameWon,
                isEndlessMode: gameState.isEndlessMode,
                difficulty: gameState.difficulty,
                history: gameState.history
            }));
        }
        function initGame(isEndlessMode = false, gridRows = gameState.gridRows, gridCols = gameState.gridCols) {
            generateGridStyles(null, gridRows, gridCols);
            const previousBestScore = gameState.bestScore;
            gameState.gridRows = gridRows;
            gameState.gridCols = gridCols;
            gameState.gridSize = Math.max(gridRows, gridCols);
            gameState.grid = createEmptyGrid();
            gameState.score = 0;
            gameState.gameOver = false;
            gameState.gameWon = false;
            gameState.isEndlessMode = isEndlessMode;
            gameState.history = [];
            elements.scoreDisplay.textContent = gameState.score;
            elements.bestScoreDisplay.textContent = previousBestScore;
            document.querySelector('.game-container').classList.remove('grid-3x3', 'grid-4x4', 'grid-5x5');
            document.querySelector('.game-container').classList.add(`grid-${gridRows}x${gridCols}`);
            initGridContainer();
            elements.tileContainer.innerHTML = '';
            for (let i = 0; i < config.initialTiles; i++) {
                generateRandomTile();
            }
            updateDifficultyButtons();
            updateGridButtonState(Math.max(gridRows, gridCols));
            elements.modeDescription.textContent = isEndlessMode 
                ? "当前模式：无尽模式 - 尽可能获得高分" 
                : "当前模式：标准模式 - 达到2048获胜";
            elements.difficultyDescription.textContent = `当前难度：${getDifficultyName()} - ${gridRows}×${gridCols}网格`;
            hideGameMessage();
            updateDocumentTitle();
            updateUndoButtonState();
            saveGameState();
        }
        function toggleTheme() {
            const currentTheme = localStorage.getItem('2048-theme') || 'light';
            const styleElement = document.getElementById('custom-theme-styles');
            if (styleElement) {
                styleElement.remove();
            }
            document.body.removeAttribute('data-theme');
            let newTheme;
            if (currentTheme === 'light') {
                document.documentElement.classList.add('dark');
                newTheme = 'dark';
                elements.themeToggle.querySelector('i').className = 'fa-solid fa-sun';
            } else if (currentTheme === 'dark' || currentTheme === 'auto') {
                const hasCustomTheme = localStorage.getItem('customTheme') !== null;
                if (hasCustomTheme) {
                    loadCustomTheme();
                    newTheme = 'custom';
                    elements.themeToggle.querySelector('i').className = 'fa-solid fa-palette';
                } else {
                    document.documentElement.classList.remove('dark');
                    newTheme = 'light';
                    elements.themeToggle.querySelector('i').className = 'fa-solid fa-moon';
                }
            } else if (currentTheme === 'custom') {
                document.documentElement.classList.remove('dark');
                newTheme = 'light';
                elements.themeToggle.querySelector('i').className = 'fa-solid fa-moon';
            }
            localStorage.setItem('2048-theme', newTheme);
        }
        function resetAllSettings() {
            if (confirm('确定要重置所有设置吗？')) {
                localStorage.removeItem('2048-theme');
                localStorage.removeItem('customTheme');
                document.getElementById('custom-theme-button').style.display = 'none';
                document.getElementById('custom-theme-button-container').classList.remove('mb-2');
                localStorage.removeItem('2048-gpu-acceleration');
                localStorage.removeItem('2048-tile-animation');
                gameState.gpuAccelerationEnabled = true;
                gameState.tileAnimationEnabled = true;
                gameState.difficulty = 'medium';
                document.documentElement.classList.remove('dark');
                const styleElement = document.getElementById('custom-theme-styles');
                if (styleElement) {
                    styleElement.remove();
                }
                document.body.removeAttribute('data-theme');
                resetCustomTheme();
                if (window.themeMediaQueryListener) {
                    window.themeMediaQueryListener.mediaQuery.removeEventListener('change', window.themeMediaQueryListener.handler);
                    window.themeMediaQueryListener = null;
                }
                localStorage.setItem('2048-theme', 'auto');
                elements.themeToggle.value = 'auto';
                const selectedValue = document.querySelector('.select-selected span');
                const selectOptions = document.querySelectorAll('.select-item');
                if (selectedValue && selectOptions.length > 0) {
                    const nativeSelect = elements.themeToggle;
                    for (let i = 0; i < nativeSelect.options.length; i++) {
                        if (nativeSelect.options[i].value === 'auto') {
                            selectedValue.textContent = nativeSelect.options[i].text;
                            break;
                        }
                    }
                    selectOptions.forEach(option => {
                        if (option.getAttribute('data-value') === 'auto') {
                            option.classList.add('selected');
                        } else {
                            option.classList.remove('selected');
                        }
                    });
                }
                elements.gpuAccelerationToggle.checked = true;
                elements.tileAnimation.checked = true;
                updateDifficultyButtons();
                elements.difficultyDescription.textContent = `当前难度：${getDifficultyName()} - ${gameState.gridRows}×${gameState.gridCols}网格`;
                renderAllTiles();
                saveGameState();
            }
        }
        function handleResize() {
            const isCompact = window.innerWidth < 400;
            if (isCompact) {
                elements.gameHeader && elements.gameHeader.classList.add('compact-header');
                elements.gameTitle && elements.gameTitle.classList.add('compact-title');
                elements.statsContainer && elements.statsContainer.classList.add('compact-stats');
                elements.gameButtons && elements.gameButtons.classList.add('compact-buttons');
                elements.difficultyButtons && elements.difficultyButtons.classList.add('compact-difficulty');
                elements.gameDescription && elements.gameDescription.classList.add('compact-description');
                elements.gameMessage && elements.gameMessage.classList.add('compact-message');
            } else {
                elements.gameHeader && elements.gameHeader.classList.remove('compact-header');
                elements.gameTitle && elements.gameTitle.classList.remove('compact-title');
                elements.statsContainer && elements.statsContainer.classList.remove('compact-stats');
                elements.gameButtons && elements.gameButtons.classList.remove('compact-buttons');
                elements.difficultyButtons && elements.difficultyButtons.classList.remove('compact-difficulty');
                elements.gameDescription && elements.gameDescription.classList.remove('compact-description');
                elements.gameMessage && elements.gameMessage.classList.remove('compact-message');
            }
            generateGridStyles(gameState.gridSize, gameState.gridRows, gameState.gridCols);
            renderAllTiles(false);
        }
        function initEventListeners() {
            document.addEventListener('keydown', (e) => {
                if (gameState.isPaused || gameState.gameOver || (gameState.gameWon && !gameState.isEndlessMode)) return;
                if ([37, 38, 39, 40, 87, 65, 83, 68, 80, 27, 90, 72, 76].includes(e.keyCode)) {
                    e.preventDefault();
                }
                let shouldPreventDefault = false;
                if ([82, 78, 69, 71].includes(e.keyCode)) {
                    e.preventDefault();
                }
                switch(e.keyCode) {
                    case 38:
                    case 87:
                        move('up');
                        break;
                    case 40:
                    case 83:
                        move('down');
                        break;
                    case 37:
                    case 65:
                        move('left');
                        break;
                    case 39:
                    case 68:
                        move('right');
                        break;
                    case 80:
                    case 27:
                        togglePause();
                        break;
                    case 90:
                        if (e.ctrlKey || e.metaKey) {
                            undoMove();
                        }
                        break;
                    case 82:
                        if (!e.ctrlKey && !e.metaKey && !e.altKey) {
                            if (gameState.score > 0 && confirm('重新开始将重置当前游戏进度，确定要继续吗？')) {
                                initGame(gameState.isEndlessMode, gameState.gridRows, gameState.gridCols);
                            } else if (gameState.score === 0) {
                                initGame(gameState.isEndlessMode, gameState.gridRows, gameState.gridCols);
                            }
                        }
                        break;
                    case 78:
                        if (!e.ctrlKey && !e.metaKey && !e.altKey) {
                            if (gameState.score > 0 && confirm('切换到标准模式将重置当前游戏进度，确定要继续吗？')) {
                                initGame(false, gameState.gridRows, gameState.gridCols);
                            } else if (gameState.score === 0) {
                                initGame(false, gameState.gridRows, gameState.gridCols);
                            }
                        }
                        break;
                    case 69:
                        if (!e.ctrlKey && !e.metaKey && !e.altKey) {
                            if (gameState.score > 0 && confirm('切换到无尽模式将重置当前游戏进度，确定要继续吗？')) {
                                initGame(true, gameState.gridRows, gameState.gridCols);
                            } else if (gameState.score === 0) {
                                initGame(true, gameState.gridRows, gameState.gridCols);
                            }
                        }
                        break;
                    case 71:
                        if (!e.ctrlKey && !e.metaKey && !e.altKey) {
                            if (gameState.score > 0 && confirm('切换棋盘大小将重置当前游戏进度，确定要继续吗？')) {
                                const currentIndex = [3, 4, 5].indexOf(gameState.gridSize);
                                const nextIndex = (currentIndex + 1) % 3;
                                const newGridSize = [3, 4, 5][nextIndex];
                                gameState.gridSize = newGridSize;
                                gameState.gridRows = newGridSize;
                                gameState.gridCols = newGridSize;
                                updateGridButtonState(newGridSize);
                                elements.difficultyDescription.textContent = `当前难度：${getDifficultyName()} - ${gameState.gridRows}×${gameState.gridCols}网格`;
                                initGame(gameState.isEndlessMode, newGridSize, newGridSize);
                            } else if (gameState.score === 0) {
                                const currentIndex = [3, 4, 5].indexOf(gameState.gridSize);
                                const nextIndex = (currentIndex + 1) % 3;
                                const newGridSize = [3, 4, 5][nextIndex];
                                gameState.gridSize = newGridSize;
                                gameState.gridRows = newGridSize;
                                gameState.gridCols = newGridSize;
                                updateGridButtonState(newGridSize);
                                elements.difficultyDescription.textContent = `当前难度：${getDifficultyName()} - ${gameState.gridRows}×${gameState.gridCols}网格`;
                                initGame(gameState.isEndlessMode, newGridSize, newGridSize);
                            }
                        }
                        break;
                    case 76:
                        if (!e.ctrlKey && !e.metaKey && !e.altKey) {
                            analyzeGameState();
                        }
                        break;
                }
            }, { passive: false });
            elements.gameContainer.addEventListener('touchstart', (e) => {
                if (gameState.isPaused || gameState.gameOver || (gameState.gameWon && !gameState.isEndlessMode)) return;
                gameState.touchStartX = e.touches[0].clientX;
                gameState.touchStartY = e.touches[0].clientY;
            }, { passive: false });
            elements.gameContainer.addEventListener('touchmove', (e) => {
                e.preventDefault();
            }, { passive: false });
            elements.gameContainer.addEventListener('touchend', (e) => {
                if (gameState.isPaused || gameState.gameOver || (gameState.gameWon && !gameState.isEndlessMode)) return;
                gameState.touchEndX = e.changedTouches[0].clientX;
                gameState.touchEndY = e.changedTouches[0].clientY;
                const dx = gameState.touchEndX - gameState.touchStartX;
                const dy = gameState.touchEndY - gameState.touchStartY;
                if (Math.abs(dx) > Math.abs(dy)) {
                    if (Math.abs(dx) > config.touchThreshold) {
                        move(dx > 0 ? 'right' : 'left');
                    }
                } else {
                    if (Math.abs(dy) > config.touchThreshold) {
                        move(dy > 0 ? 'down' : 'up');
                    }
                }
            }, { passive: true });
            const modeButtonStates = {
                'new-game': { needsConfirm: false, originalText: elements.newGameButton.textContent },
                'endless-mode': { needsConfirm: false, originalText: elements.endlessModeButton.textContent }
            };
            const modeButtonClasses = {
                'new-game': elements.newGameButton.className,
                'endless-mode': elements.endlessModeButton.className
            };
            const modeButtonIconClasses = {
                'new-game': elements.newGameButton.querySelector('i').className,
                'endless-mode': elements.endlessModeButton.querySelector('i').className
            };
            function resetModeButtonStates() {
                modeButtonStates['new-game'].needsConfirm = false;
                const newGameSpan = elements.newGameButton.querySelector('span');
                if (newGameSpan) {
                    newGameSpan.textContent = '标准模式';
                }
                const newGameIcon = elements.newGameButton.querySelector('i');
                if (newGameIcon) {
                    newGameIcon.className = modeButtonIconClasses['new-game'];
                    newGameIcon.style.display = '';
                }
                elements.newGameButton.className = modeButtonClasses['new-game'];
                modeButtonStates['endless-mode'].needsConfirm = false;
                const endlessModeSpan = elements.endlessModeButton.querySelector('span');
                if (endlessModeSpan) {
                    endlessModeSpan.textContent = '无尽模式';
                }
                const endlessModeIcon = elements.endlessModeButton.querySelector('i');
                if (endlessModeIcon) {
                    endlessModeIcon.className = modeButtonIconClasses['endless-mode'];
                    endlessModeIcon.style.display = '';
                }
                elements.endlessModeButton.className = modeButtonClasses['endless-mode'];
            }
            function handleModeButtonClick(buttonId, isEndlessMode) {
                const button = document.getElementById(buttonId);
                const state = modeButtonStates[buttonId];
                if (state.needsConfirm) {
                    initGame(isEndlessMode, gameState.gridRows, gameState.gridCols);
                    resetModeButtonStates();
                } else {
                    if (gameState.score > 0) {
                        resetModeButtonStates();
                        state.needsConfirm = true;
                        const spanElement = button.querySelector('span');
                        if (spanElement) {
                            spanElement.textContent = '确认';
                        }
                        const iconElement = button.querySelector('i');
                        if (iconElement) {
                            iconElement.className = 'fa-solid fa-exclamation-triangle mr-2';
                            iconElement.style.display = '';
                        }
                        button.classList.add('bg-red-500', 'hover:bg-red-600');
                    } else {
                        initGame(isEndlessMode, gameState.gridRows, gameState.gridCols);
                    }
                }
            }
            elements.newGameButton.addEventListener('click', () => {
                handleModeButtonClick('new-game', false);
            });
            elements.newGameButton.addEventListener('blur', () => {
                if (modeButtonStates['new-game'].needsConfirm) {
                    resetModeButtonStates();
                }
            });
            elements.endlessModeButton.addEventListener('click', () => {
                handleModeButtonClick('endless-mode', true);
            });
            elements.endlessModeButton.addEventListener('blur', () => {
                if (modeButtonStates['endless-mode'].needsConfirm) {
                    resetModeButtonStates();
                }
            });
            elements.gameMessageButton.addEventListener('click', () => {
                hideGameMessage();
                initGame(gameState.isEndlessMode, gameState.gridRows, gameState.gridCols);
            });
            elements.pauseButton.addEventListener('click', togglePause);
            elements.resumeButton.addEventListener('click', togglePause);
            elements.restartButton.addEventListener('click', () => {
                gameState.isPaused = false;
                elements.pauseMenu.classList.add('hidden');
                initGame(gameState.isEndlessMode, gameState.gridRows, gameState.gridCols);
            });
            elements.undoButton.addEventListener('click', undoMove);
            let themeMediaQuery;
            const updateTheme = (e) => {
                const isDark = e ? e.matches : window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.classList.toggle('dark', isDark);
            };
            elements.themeToggle.addEventListener('change', function() {
                const styleElement = document.getElementById('custom-theme-styles');
                if (styleElement) {
                    styleElement.remove();
                }
                document.body.removeAttribute('data-theme');
                if (window.themeMediaQueryListener) {
                    window.themeMediaQueryListener.mediaQuery.removeEventListener('change', window.themeMediaQueryListener.handler);
                    window.themeMediaQueryListener = null;
                }
                const theme = this.value;
                if (theme === 'auto') {
                    const themeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                    const updateTheme = (e) => {
                        const isDark = e ? e.matches : window.matchMedia('(prefers-color-scheme: dark)').matches;
                        document.documentElement.classList.toggle('dark', isDark);
                    };
                    themeMediaQuery.addEventListener('change', updateTheme);
                    updateTheme(themeMediaQuery);
                    window.themeMediaQueryListener = {
                        mediaQuery: themeMediaQuery,
                        handler: updateTheme
                    };
                    localStorage.setItem('2048-theme', 'auto');
                    document.getElementById('custom-theme-button').style.display = 'none';
                    document.getElementById('custom-theme-button-container').classList.remove('mb-2');
                    document.getElementById('custom-theme-button-container').classList.remove('mb-2');
                } else if (theme === 'custom') {
                    localStorage.setItem('2048-theme', 'custom');
                    document.getElementById('custom-theme-button').style.display = 'block';
                    document.getElementById('custom-theme-button-container').classList.add('mb-2');
                    document.documentElement.classList.remove('dark');
                    loadCustomTheme();
                    document.body.setAttribute('data-theme', 'custom');
                } else {
                    document.getElementById('custom-theme-button').style.display = 'none';
                    const isDark = theme === 'dark';
                    document.documentElement.classList.toggle('dark', isDark);
                    localStorage.setItem('2048-theme', theme);
                }
            });
            elements.easyModeButton.addEventListener('click', () => {
                gameState.difficulty = 'easy';
                updateDifficultyButtons();
                elements.difficultyDescription.textContent = `当前难度：${getDifficultyName()} - ${gameState.gridRows}×${gameState.gridCols}网格`;
                saveGameState();
            });
            elements.mediumModeButton.addEventListener('click', () => {
                gameState.difficulty = 'medium';
                updateDifficultyButtons();
                elements.difficultyDescription.textContent = `当前难度：${getDifficultyName()} - ${gameState.gridRows}×${gameState.gridCols}网格`;
                saveGameState();
            });
            elements.hardModeButton.addEventListener('click', () => {
                gameState.difficulty = 'hard';
                updateDifficultyButtons();
                elements.difficultyDescription.textContent = `当前难度：${getDifficultyName()} - ${gameState.gridRows}×${gameState.gridCols}网格`;
                saveGameState();
            });
            const buttonStates = {
                'grid-3x3': { needsConfirm: false, originalText: elements.grid3x3Button.textContent },
                'grid-4x4': { needsConfirm: false, originalText: elements.grid4x4Button.textContent },
                'grid-5x5': { needsConfirm: false, originalText: elements.grid5x5Button.textContent },
                'custom-grid': { needsConfirm: false, originalHTML: elements.applyCustomGridButton.innerHTML }
            };
            const buttonClasses = {
                'grid-3x3': elements.grid3x3Button.className,
                'grid-4x4': elements.grid4x4Button.className,
                'grid-5x5': elements.grid5x5Button.className,
                'custom-grid': elements.applyCustomGridButton.className
            };
            function resetButtonStates() {
                buttonStates['grid-3x3'].needsConfirm = false;
                elements.grid3x3Button.textContent = buttonStates['grid-3x3'].originalText;
                elements.grid3x3Button.className = buttonClasses['grid-3x3'];
                buttonStates['grid-4x4'].needsConfirm = false;
                elements.grid4x4Button.textContent = buttonStates['grid-4x4'].originalText;
                elements.grid4x4Button.className = buttonClasses['grid-4x4'];
                buttonStates['grid-5x5'].needsConfirm = false;
                elements.grid5x5Button.textContent = buttonStates['grid-5x5'].originalText;
                elements.grid5x5Button.className = buttonClasses['grid-5x5'];
                buttonStates['custom-grid'].needsConfirm = false;
                elements.applyCustomGridButton.innerHTML = buttonStates['custom-grid'].originalHTML;
                elements.applyCustomGridButton.className = buttonClasses['custom-grid'];
            }
            function handleGridButtonClick(buttonId, gridSize) {
                const button = document.getElementById(buttonId);
                const state = buttonStates[buttonId];
                if (state.needsConfirm) {
                    const rows = gridSize;
                    const cols = gridSize;
                    gameState.gridSize = gridSize;
                    gameState.gridRows = rows;
                    gameState.gridCols = cols;
                    updateGridButtonState(gridSize);
                    elements.difficultyDescription.textContent = `当前难度：${getDifficultyName()} - ${rows}×${cols}网格`;
                    initGame(gameState.isEndlessMode, rows, cols);
                    resetButtonStates();
                } else {
                    if (gameState.score > 0) {
                        resetButtonStates();
                        state.needsConfirm = true;
                        button.innerHTML = '<i class="fa-solid fa-exclamation-triangle mr-1"></i>确认';
                        button.classList.add('bg-red-500', 'hover:bg-red-600');
                    } else {
                        gameState.gridSize = gridSize;
                        gameState.gridRows = gridSize;
                        gameState.gridCols = gridSize;
                        updateGridButtonState(gridSize);
                        elements.difficultyDescription.textContent = `当前难度：${getDifficultyName()} - ${gameState.gridRows}×${gameState.gridCols}网格`;
                        initGame(gameState.isEndlessMode, gridSize, gridSize);
                    }
                }
            }
            elements.grid3x3Button.addEventListener('click', () => {
                handleGridButtonClick('grid-3x3', 3);
            });
            elements.grid3x3Button.addEventListener('blur', () => {
                if (buttonStates['grid-3x3'].needsConfirm) {
                    resetButtonStates();
                }
            });
            elements.grid4x4Button.addEventListener('click', () => {
                handleGridButtonClick('grid-4x4', 4);
            });
            elements.grid4x4Button.addEventListener('blur', () => {
                if (buttonStates['grid-4x4'].needsConfirm) {
                    resetButtonStates();
                }
            });
            elements.grid5x5Button.addEventListener('click', () => {
                handleGridButtonClick('grid-5x5', 5);
            });
            elements.grid5x5Button.addEventListener('blur', () => {
                if (buttonStates['grid-5x5'].needsConfirm) {
                    resetButtonStates();
                }
            });
            elements.customGridButton.addEventListener('click', () => {
                elements.gridSizeInput.value = gameState.gridRows;
                elements.gridSizeInput2.value = gameState.gridCols;
                const savedSquareGridState = localStorage.getItem('2048-square-grid-locked');
                const isSquareGrid = savedSquareGridState !== null 
                    ? savedSquareGridState === 'true' 
                    : gameState.gridRows === gameState.gridCols;
                elements.squareGridCheckbox.checked = isSquareGrid;
                elements.gridSizeInput2.disabled = isSquareGrid;
                resetButtonStates();
                showModal('custom-grid-modal');
            });
            elements.squareGridCheckbox.addEventListener('change', () => {
                localStorage.setItem('2048-square-grid-locked', elements.squareGridCheckbox.checked);
                elements.gridSizeInput2.disabled = elements.squareGridCheckbox.checked;
                if (elements.squareGridCheckbox.checked) {
                    elements.gridSizeInput2.value = elements.gridSizeInput.value;
                }
            });
            elements.gridSizeInput.addEventListener('input', () => {
                if (elements.squareGridCheckbox.checked) {
                    elements.gridSizeInput2.value = elements.gridSizeInput.value;
                }
            });
            elements.applyCustomGridButton.addEventListener('click', () => {
                const buttonId = 'custom-grid';
                const button = elements.applyCustomGridButton;
                const state = buttonStates[buttonId];
                
                if (state.needsConfirm) {
                    const rows = parseInt(elements.gridSizeInput.value);
                    const cols = elements.squareGridCheckbox.checked ? rows : parseInt(elements.gridSizeInput2.value);
                    if (isNaN(rows) || isNaN(cols) || rows < 3 || rows > 10 || cols < 3 || cols > 10) {
                        alert('请输入3到10之间的有效数字');
                        return;
                    }
                    updateGridButtonState(Math.max(rows, cols));
                    elements.difficultyDescription.textContent = `当前难度：${getDifficultyName()} - ${rows}×${cols}网格`;
                    initGame(gameState.isEndlessMode, rows, cols);
                    hideModal('custom-grid-modal');
                    resetButtonStates();
                } else {
                    const rows = parseInt(elements.gridSizeInput.value);
                    const cols = elements.squareGridCheckbox.checked ? rows : parseInt(elements.gridSizeInput2.value);
                    if (isNaN(rows) || isNaN(cols) || rows < 3 || rows > 10 || cols < 3 || cols > 10) {
                        alert('请输入3到10之间的有效数字');
                        return;
                    }
                    if (gameState.score > 0) {
                        state.needsConfirm = true;
                        button.innerHTML = '<i class="fa-solid fa-exclamation-triangle mr-1"></i>确认';
                        button.classList.add('bg-red-500', 'hover:bg-red-600');
                    } else {
                        updateGridButtonState(Math.max(rows, cols));
                        elements.difficultyDescription.textContent = `当前难度：${getDifficultyName()} - ${rows}×${cols}网格`;
                        initGame(gameState.isEndlessMode, rows, cols);
                        hideModal('custom-grid-modal');
                    }
                }
            });
            elements.cancelCustomGridButton.addEventListener('click', () => {
                hideModal('custom-grid-modal');
                resetButtonStates();
            });
            elements.applyCustomGridButton.addEventListener('blur', () => {
                if (buttonStates['custom-grid'].needsConfirm) {
                    resetButtonStates();
                }
            });
            const originalInitGame = initGame;
            initGame = function(...args) {
                resetButtonStates();
                resetModeButtonStates()
                return originalInitGame.apply(this, args);
            };
            elements.dataTransferButton.addEventListener('click', () => { showModal('data-transfer-modal'); });
            elements.settingsButton.addEventListener('click', () => {
                showModal('settings-modal');
            });
            elements.closeSettingsButton.addEventListener('click', () => {
                hideModal('settings-modal');
            });
            elements.gpuAccelerationToggle = document.getElementById('gpu-acceleration');
            elements.gpuAccelerationToggle.checked = gameState.gpuAccelerationEnabled;
            elements.gpuAccelerationToggle.addEventListener('change', (e) => {
                gameState.gpuAccelerationEnabled = e.target.checked;
                localStorage.setItem('2048-gpu-acceleration', gameState.gpuAccelerationEnabled);
                renderAllTiles();
            });
            elements.tileAnimation.checked = gameState.tileAnimationEnabled;
            elements.tileAnimation.addEventListener('change', (e) => {
                gameState.tileAnimationEnabled = e.target.checked;
                localStorage.setItem('2048-tile-animation', gameState.tileAnimationEnabled);
            });
            elements.dataTransferButton.addEventListener('click', () => {
                showModal('data-transfer-modal');
            });
            elements.resetSettingsButton.addEventListener('click', resetAllSettings);
            window.addEventListener('resize', handleResize);
            const customThemeButton = document.getElementById('custom-theme-button');
            if (customThemeButton) {
                customThemeButton.addEventListener('click', function() {
                    showModal('custom-theme-modal');
                });
            }
            setupThemeCustomizer();
            applySavedTheme();
        } false;
        function setupThemeCustomizer() {
            const customThemeModal = document.getElementById('custom-theme-modal');
            if (!customThemeModal) return;
            const closeButton = document.getElementById('close-custom-theme-modal');
            if (closeButton) {
                closeButton.addEventListener('click', function() {
                    hideModal('custom-theme-modal');
                    removePreviewStyles();
                });
            }
            const colorInputs = document.querySelectorAll('input[type="color"]');
            const textInputs = document.querySelectorAll('input[type="text"]');
            colorInputs.forEach(colorInput => {
                const textInputId = colorInput.id + '-text';
                const textInput = document.getElementById(textInputId);
                if (textInput) {
                    colorInput.addEventListener('input', function() {
                        textInput.value = this.value;
                        previewCustomTheme();
                    });
                    textInput.addEventListener('input', function() {
                        if (/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(this.value)) {
                            colorInput.value = this.value;
                            previewCustomTheme();
                        }
                    });
                }
            });
            const resetButton = document.getElementById('reset-custom-theme');
            if (resetButton) {
                resetButton.addEventListener('click', function() {
                    resetCustomTheme();
                    previewCustomTheme();
                });
            }
            const saveButton = document.getElementById('save-custom-theme');
            if (saveButton) {
                saveButton.addEventListener('click', function() {
                    saveCustomTheme();
                });
            }
        }
        function previewCustomTheme() {
            const bgColor = document.getElementById('custom-bg-color').value;
            const primaryColor = document.getElementById('custom-primary-color').value;
            const secondaryColor = document.getElementById('custom-secondary-color').value;
            const gridColor = document.getElementById('custom-grid-color').value;
            const modalBgColor = document.getElementById('custom-modal-bg').value;
            const modalTextColor = document.getElementById('custom-modal-text').value;
            const tile2Bg = document.getElementById('custom-tile-2-bg').value;
            const tile2Text = document.getElementById('custom-tile-2-text').value;
            const tile4Bg = document.getElementById('custom-tile-4-bg').value;
            const tile4Text = document.getElementById('custom-tile-4-text').value;
            const tile8Bg = document.getElementById('custom-tile-8-bg').value;
            const tile8Text = document.getElementById('custom-tile-8-text').value;
            const tile16Bg = document.getElementById('custom-tile-16-bg').value;
            const tile16Text = document.getElementById('custom-tile-16-text').value;
            const tile32Bg = document.getElementById('custom-tile-32-bg').value;
            const tile32Text = document.getElementById('custom-tile-32-text').value;
            const tile64Bg = document.getElementById('custom-tile-64-bg').value;
            const tile64Text = document.getElementById('custom-tile-64-text').value;
            const tile128Bg = document.getElementById('custom-tile-128-bg').value;
            const tile128Text = document.getElementById('custom-tile-128-text').value;
            const tile256Bg = document.getElementById('custom-tile-256-bg').value;
            const tile256Text = document.getElementById('custom-tile-256-text').value;
            const tile512Bg = document.getElementById('custom-tile-512-bg').value;
            const tile512Text = document.getElementById('custom-tile-512-text').value;
            const tile1024Bg = document.getElementById('custom-tile-1024-bg').value;
            const tile1024Text = document.getElementById('custom-tile-1024-text').value;
            const tile2048Bg = document.getElementById('custom-tile-2048-bg').value;
            const tile2048Text = document.getElementById('custom-tile-2048-text').value;
            const tile4096Bg = document.getElementById('custom-tile-4096-bg').value;
            const tile4096Text = document.getElementById('custom-tile-4096-text').value;
            const tile8192Bg = document.getElementById('custom-tile-8192-bg').value;
            const tile8192Text = document.getElementById('custom-tile-8192-text').value;
            const tile16384Bg = document.getElementById('custom-tile-16384-bg').value;
            const tile16384Text = document.getElementById('custom-tile-16384-text').value;
            const tile32768Bg = document.getElementById('custom-tile-32768-bg').value;
            const tile32768Text = document.getElementById('custom-tile-32768-text').value;
            const tileSuperBg = document.getElementById('custom-tile-super-bg').value;
            const tileSuperText = document.getElementById('custom-tile-super-text').value;
            let previewStyleElement = document.getElementById('preview-theme-styles');
            if (!previewStyleElement) {
                previewStyleElement = document.createElement('style');
                previewStyleElement.id = 'preview-theme-styles';
                document.head.appendChild(previewStyleElement);
            }
            const previewStyles = `
                body[data-preview="true"] {
                    background-color: ${bgColor} !important;
                    color: ${secondaryColor} !important;
                }
                body[data-preview="true"] .game-header,
                body[data-preview="true"] .game-footer {
                    color: ${secondaryColor} !important;
                }
                body[data-preview="true"] .primary {
                    background-color: ${primaryColor} !important;
                }
                body[data-preview="true"] .secondary {
                    color: ${secondaryColor} !important;
                }
                body[data-preview="true"] .game-container {
                    background-color: ${gridColor} !important;
                }
                body[data-preview="true"] .tile-2 {
                    background-color: ${tile2Bg} !important;
                    color: ${tile2Text} !important;
                }
                body[data-preview="true"] .tile-4 {
                    background-color: ${tile4Bg} !important;
                    color: ${tile4Text} !important;
                }
                body[data-preview="true"] .tile-8 {
                    background-color: ${tile8Bg} !important;
                    color: ${tile8Text} !important;
                }
                body[data-preview="true"] .tile-16 {
                    background-color: ${tile16Bg} !important;
                    color: ${tile16Text} !important;
                }
                body[data-preview="true"] .tile-32 {
                    background-color: ${tile32Bg} !important;
                    color: ${tile32Text} !important;
                }
                body[data-preview="true"] .tile-64 {
                    background-color: ${tile64Bg} !important;
                    color: ${tile64Text} !important;
                }
                body[data-preview="true"] .tile-128 {
                    background-color: ${tile128Bg} !important;
                    color: ${tile128Text} !important;
                }
                body[data-preview="true"] .tile-256 {
                    background-color: ${tile256Bg} !important;
                    color: ${tile256Text} !important;
                }
                body[data-preview="true"] .tile-512 {
                    background-color: ${tile512Bg} !important;
                    color: ${tile512Text} !important;
                }
                body[data-preview="true"] .tile-1024 {
                    background-color: ${tile1024Bg} !important;
                    color: ${tile1024Text} !important;
                }
                body[data-preview="true"] .tile-2048 {
                    background-color: ${tile2048Bg} !important;
                    color: ${tile2048Text} !important;
                }
                body[data-preview="true"] .tile-4096 {
                    background-color: ${tile4096Bg} !important;
                    color: ${tile4096Text} !important;
                }
                body[data-preview="true"] .tile-8192 {
                    background-color: ${tile8192Bg} !important;
                    color: ${tile8192Text} !important;
                }
                body[data-preview="true"] .tile-16384 {
                    background-color: ${tile16384Bg} !important;
                    color: ${tile16384Text} !important;
                }
                body[data-preview="true"] .tile-32768 {
                    background-color: ${tile32768Bg} !important;
                    color: ${tile32768Text} !important;
                }
                body[data-preview="true"] .tile-super {
                    background-color: ${tileSuperBg} !important;
                    color: ${tileSuperText} !important;
                }
                body[data-preview="true"] [role="dialog"] > div {
                    background-color: ${modalBgColor} !important;
                    color: ${modalTextColor} !important;
                }
            `;
            previewStyleElement.textContent = previewStyles;
            document.body.setAttribute('data-preview', 'true');
        }
        function removePreviewStyles() {
            const previewStyleElement = document.getElementById('preview-theme-styles');
            if (previewStyleElement) {
                previewStyleElement.remove();
            }
            document.body.removeAttribute('data-preview');
            const currentTheme = localStorage.getItem('2048-theme');
            if (currentTheme === 'custom') {
                loadCustomTheme();
            }
        }
        function applySavedTheme() {
            const savedTheme = localStorage.getItem('2048-theme');
            if (savedTheme === 'custom') {
                loadCustomTheme();
                const customThemeButton = document.getElementById('custom-theme-button');
                const customThemeButtonContainer = document.getElementById('custom-theme-button-container');
                if (customThemeButton && customThemeButtonContainer) {
                    customThemeButton.style.display = 'block';
                    customThemeButtonContainer.classList.add('mb-2');
                }
            } else if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                if (elements && elements.themeToggle && elements.themeToggle.querySelector('i')) {
                    elements.themeToggle.querySelector('i').className = 'fa-solid fa-sun';
                }
            } else if (savedTheme === 'light') {
                document.documentElement.classList.remove('dark');
                if (elements && elements.themeToggle && elements.themeToggle.querySelector('i')) {
                    elements.themeToggle.querySelector('i').className = 'fa-solid fa-moon';
                }
            } else if (savedTheme === 'auto') {
                const themeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                const updateTheme = (e) => {
                    const isDark = e ? e.matches : window.matchMedia('(prefers-color-scheme: dark)').matches;
                    document.documentElement.classList.toggle('dark', isDark);
                    if (elements && elements.themeToggle && elements.themeToggle.querySelector('i')) {
                        elements.themeToggle.querySelector('i').className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
                    }
                };
                if (window.themeMediaQueryListener) {
                    window.themeMediaQueryListener.mediaQuery.removeEventListener('change', window.themeMediaQueryListener.handler);
                }
                themeMediaQuery.addEventListener('change', updateTheme);
                updateTheme(themeMediaQuery);
                window.themeMediaQueryListener = {
                    mediaQuery: themeMediaQuery,
                    handler: updateTheme
                };
            }
        }
        function resetCustomTheme() {
            document.getElementById('custom-bg-color').value = '#faf8ef';
            document.getElementById('custom-bg-color-text').value = '#faf8ef';
            document.getElementById('custom-primary-color').value = '#faa31b';
            document.getElementById('custom-primary-color-text').value = '#faa31b';
            document.getElementById('custom-secondary-color').value = '#8f7a66';
            document.getElementById('custom-secondary-color-text').value = '#8f7a66';
            document.getElementById('custom-grid-color').value = '#bbada0';
            document.getElementById('custom-grid-color-text').value = '#bbada0';
            document.getElementById('custom-modal-bg').value = '#ffffff';
            document.getElementById('custom-modal-bg-text').value = '#ffffff';
            document.getElementById('custom-modal-text').value = '#333333';
            document.getElementById('custom-modal-text-text').value = '#333333';
            document.getElementById('custom-tile-2-bg').value = '#eee4da';
            document.getElementById('custom-tile-2-bg-text').value = '#eee4da';
            document.getElementById('custom-tile-2-text').value = '#776e65';
            document.getElementById('custom-tile-2-text-text').value = '#776e65';
            document.getElementById('custom-tile-4-bg').value = '#ede0c8';
            document.getElementById('custom-tile-4-bg-text').value = '#ede0c8';
            document.getElementById('custom-tile-4-text').value = '#776e65';
            document.getElementById('custom-tile-4-text-text').value = '#776e65';
            document.getElementById('custom-tile-8-bg').value = '#f2b179';
            document.getElementById('custom-tile-8-bg-text').value = '#f2b179';
            document.getElementById('custom-tile-8-text').value = '#f9f6f2';
            document.getElementById('custom-tile-8-text-text').value = '#f9f6f2';
            document.getElementById('custom-tile-16-bg').value = '#f59563';
            document.getElementById('custom-tile-16-bg-text').value = '#f59563';
            document.getElementById('custom-tile-16-text').value = '#f9f6f2';
            document.getElementById('custom-tile-16-text-text').value = '#f9f6f2';
            document.getElementById('custom-tile-32-bg').value = '#f67c5f';
            document.getElementById('custom-tile-32-bg-text').value = '#f67c5f';
            document.getElementById('custom-tile-32-text').value = '#f9f6f2';
            document.getElementById('custom-tile-32-text-text').value = '#f9f6f2';
            document.getElementById('custom-tile-64-bg').value = '#f65e3b';
            document.getElementById('custom-tile-64-bg-text').value = '#f65e3b';
            document.getElementById('custom-tile-64-text').value = '#f9f6f2';
            document.getElementById('custom-tile-64-text-text').value = '#f9f6f2';
            document.getElementById('custom-tile-128-bg').value = '#edcf72';
            document.getElementById('custom-tile-128-bg-text').value = '#edcf72';
            document.getElementById('custom-tile-128-text').value = '#f9f6f2';
            document.getElementById('custom-tile-128-text-text').value = '#f9f6f2';
            document.getElementById('custom-tile-256-bg').value = '#edcc61';
            document.getElementById('custom-tile-256-bg-text').value = '#edcc61';
            document.getElementById('custom-tile-256-text').value = '#f9f6f2';
            document.getElementById('custom-tile-256-text-text').value = '#f9f6f2';
            document.getElementById('custom-tile-512-bg').value = '#edc850';
            document.getElementById('custom-tile-512-bg-text').value = '#edc850';
            document.getElementById('custom-tile-512-text').value = '#f9f6f2';
            document.getElementById('custom-tile-512-text-text').value = '#f9f6f2';
            document.getElementById('custom-tile-1024-bg').value = '#edc53f';
            document.getElementById('custom-tile-1024-bg-text').value = '#edc53f';
            document.getElementById('custom-tile-1024-text').value = '#f9f6f2';
            document.getElementById('custom-tile-1024-text-text').value = '#f9f6f2';
            document.getElementById('custom-tile-2048-bg').value = '#edc22e';
            document.getElementById('custom-tile-2048-bg-text').value = '#edc22e';
            document.getElementById('custom-tile-2048-text').value = '#f9f6f2';
            document.getElementById('custom-tile-2048-text-text').value = '#f9f6f2';
            document.getElementById('custom-tile-4096-bg').value = '#e65100';
            document.getElementById('custom-tile-4096-bg-text').value = '#e65100';
            document.getElementById('custom-tile-4096-text').value = '#ffffff';
            document.getElementById('custom-tile-4096-text-text').value = '#ffffff';
            document.getElementById('custom-tile-8192-bg').value = '#bf360c';
            document.getElementById('custom-tile-8192-bg-text').value = '#bf360c';
            document.getElementById('custom-tile-8192-text').value = '#ffffff';
            document.getElementById('custom-tile-8192-text-text').value = '#ffffff';
            document.getElementById('custom-tile-16384-bg').value = '#880e4f';
            document.getElementById('custom-tile-16384-bg-text').value = '#880e4f';
            document.getElementById('custom-tile-16384-text').value = '#ffffff';
            document.getElementById('custom-tile-16384-text-text').value = '#ffffff';
            document.getElementById('custom-tile-32768-bg').value = '#4a148c';
            document.getElementById('custom-tile-32768-bg-text').value = '#4a148c';
            document.getElementById('custom-tile-32768-text').value = '#ffffff';
            document.getElementById('custom-tile-32768-text-text').value = '#ffffff';
            document.getElementById('custom-tile-super-bg').value = '#311b92';
            document.getElementById('custom-tile-super-bg-text').value = '#311b92';
            document.getElementById('custom-tile-super-text').value = '#ffffff';
            document.getElementById('custom-tile-super-text-text').value = '#ffffff';
        }
        function saveCustomTheme() {
            const themeData = {
                bgColor: document.getElementById('custom-bg-color').value,
                primaryColor: document.getElementById('custom-primary-color').value,
                secondaryColor: document.getElementById('custom-secondary-color').value,
                gridColor: document.getElementById('custom-grid-color').value,
                modalBgColor: document.getElementById('custom-modal-bg').value,
                modalTextColor: document.getElementById('custom-modal-text').value,
                tile2Bg: document.getElementById('custom-tile-2-bg').value,
                tile2Text: document.getElementById('custom-tile-2-text').value,
                tile4Bg: document.getElementById('custom-tile-4-bg').value,
                tile4Text: document.getElementById('custom-tile-4-text').value,
                tile8Bg: document.getElementById('custom-tile-8-bg').value,
                tile8Text: document.getElementById('custom-tile-8-text').value,
                tile16Bg: document.getElementById('custom-tile-16-bg').value,
                tile16Text: document.getElementById('custom-tile-16-text').value,
                tile32Bg: document.getElementById('custom-tile-32-bg').value,
                tile32Text: document.getElementById('custom-tile-32-text').value,
                tile64Bg: document.getElementById('custom-tile-64-bg').value,
                tile64Text: document.getElementById('custom-tile-64-text').value,
                tile128Bg: document.getElementById('custom-tile-128-bg').value,
                tile128Text: document.getElementById('custom-tile-128-text').value,
                tile256Bg: document.getElementById('custom-tile-256-bg').value,
                tile256Text: document.getElementById('custom-tile-256-text').value,
                tile512Bg: document.getElementById('custom-tile-512-bg').value,
                tile512Text: document.getElementById('custom-tile-512-text').value,
                tile1024Bg: document.getElementById('custom-tile-1024-bg').value,
                tile1024Text: document.getElementById('custom-tile-1024-text').value,
                tile2048Bg: document.getElementById('custom-tile-2048-bg').value,
                tile2048Text: document.getElementById('custom-tile-2048-text').value,
                tile4096Bg: document.getElementById('custom-tile-4096-bg').value,
                tile4096Text: document.getElementById('custom-tile-4096-text').value,
                tile8192Bg: document.getElementById('custom-tile-8192-bg').value,
                tile8192Text: document.getElementById('custom-tile-8192-text').value,
                tile16384Bg: document.getElementById('custom-tile-16384-bg').value,
                tile16384Text: document.getElementById('custom-tile-16384-text').value,
                tile32768Bg: document.getElementById('custom-tile-32768-bg').value,
                tile32768Text: document.getElementById('custom-tile-32768-text').value,
                tileSuperBg: document.getElementById('custom-tile-super-bg').value,
                tileSuperText: document.getElementById('custom-tile-super-text').value,
                timestamp: new Date().getTime()
            };
            localStorage.setItem('customTheme', JSON.stringify(themeData));
            localStorage.setItem('2048-theme', 'custom');
            alert('主题保存成功！');
        }
        function loadCustomTheme() {
            try {
                const savedTheme = localStorage.getItem('customTheme');
                if (savedTheme) {
                    const themeData = JSON.parse(savedTheme);
                    applyCustomThemeFromData(themeData);
                    if (document.getElementById('custom-bg-color')) {
                        document.getElementById('custom-bg-color').value = themeData.bgColor;
                        document.getElementById('custom-bg-color-text').value = themeData.bgColor;
                        document.getElementById('custom-primary-color').value = themeData.primaryColor;
                        document.getElementById('custom-primary-color-text').value = themeData.primaryColor;
                        document.getElementById('custom-secondary-color').value = themeData.secondaryColor;
                        document.getElementById('custom-secondary-color-text').value = themeData.secondaryColor;
                        document.getElementById('custom-grid-color').value = themeData.gridColor;
                        document.getElementById('custom-grid-color-text').value = themeData.gridColor;
                        document.getElementById('custom-modal-bg').value = themeData.modalBgColor || '#ffffff';
                        document.getElementById('custom-modal-bg-text').value = themeData.modalBgColor || '#ffffff';
                        document.getElementById('custom-modal-text').value = themeData.modalTextColor || '#333333';
                        document.getElementById('custom-modal-text-text').value = themeData.modalTextColor || '#333333';
                        document.getElementById('custom-tile-2-bg').value = themeData.tile2Bg;
                        document.getElementById('custom-tile-2-bg-text').value = themeData.tile2Bg;
                        document.getElementById('custom-tile-2-text').value = themeData.tile2Text;
                        document.getElementById('custom-tile-2-text-text').value = themeData.tile2Text;
                        document.getElementById('custom-tile-4-bg').value = themeData.tile4Bg;
                        document.getElementById('custom-tile-4-bg-text').value = themeData.tile4Bg;
                        document.getElementById('custom-tile-4-text').value = themeData.tile4Text;
                        document.getElementById('custom-tile-4-text-text').value = themeData.tile4Text;
                        document.getElementById('custom-tile-8-bg').value = themeData.tile8Bg || '#f2b179';
                        document.getElementById('custom-tile-8-bg-text').value = themeData.tile8Bg || '#f2b179';
                        document.getElementById('custom-tile-8-text').value = themeData.tile8Text || '#f9f6f2';
                        document.getElementById('custom-tile-8-text-text').value = themeData.tile8Text || '#f9f6f2';
                        document.getElementById('custom-tile-16-bg').value = themeData.tile16Bg || '#f59563';
                        document.getElementById('custom-tile-16-bg-text').value = themeData.tile16Bg || '#f59563';
                        document.getElementById('custom-tile-16-text').value = themeData.tile16Text || '#f9f6f2';
                        document.getElementById('custom-tile-16-text-text').value = themeData.tile16Text || '#f9f6f2';
                        document.getElementById('custom-tile-32-bg').value = themeData.tile32Bg || '#f67c5f';
                        document.getElementById('custom-tile-32-bg-text').value = themeData.tile32Bg || '#f67c5f';
                        document.getElementById('custom-tile-32-text').value = themeData.tile32Text || '#f9f6f2';
                        document.getElementById('custom-tile-32-text-text').value = themeData.tile32Text || '#f9f6f2';
                        document.getElementById('custom-tile-64-bg').value = themeData.tile64Bg || '#f65e3b';
                        document.getElementById('custom-tile-64-bg-text').value = themeData.tile64Bg || '#f65e3b';
                        document.getElementById('custom-tile-64-text').value = themeData.tile64Text || '#f9f6f2';
                        document.getElementById('custom-tile-64-text-text').value = themeData.tile64Text || '#f9f6f2';
                        document.getElementById('custom-tile-128-bg').value = themeData.tile128Bg || '#edcf72';
                        document.getElementById('custom-tile-128-bg-text').value = themeData.tile128Bg || '#edcf72';
                        document.getElementById('custom-tile-128-text').value = themeData.tile128Text || '#f9f6f2';
                        document.getElementById('custom-tile-128-text-text').value = themeData.tile128Text || '#f9f6f2';
                        document.getElementById('custom-tile-256-bg').value = themeData.tile256Bg || '#edcc61';
                        document.getElementById('custom-tile-256-bg-text').value = themeData.tile256Bg || '#edcc61';
                        document.getElementById('custom-tile-256-text').value = themeData.tile256Text || '#f9f6f2';
                        document.getElementById('custom-tile-256-text-text').value = themeData.tile256Text || '#f9f6f2';
                        document.getElementById('custom-tile-512-bg').value = themeData.tile512Bg || '#edc850';
                        document.getElementById('custom-tile-512-bg-text').value = themeData.tile512Bg || '#edc850';
                        document.getElementById('custom-tile-512-text').value = themeData.tile512Text || '#f9f6f2';
                        document.getElementById('custom-tile-512-text-text').value = themeData.tile512Text || '#f9f6f2';
                        document.getElementById('custom-tile-1024-bg').value = themeData.tile1024Bg || '#edc53f';
                        document.getElementById('custom-tile-1024-bg-text').value = themeData.tile1024Bg || '#edc53f';
                        document.getElementById('custom-tile-1024-text').value = themeData.tile1024Text || '#f9f6f2';
                        document.getElementById('custom-tile-1024-text-text').value = themeData.tile1024Text || '#f9f6f2';
                        document.getElementById('custom-tile-2048-bg').value = themeData.tile2048Bg || '#edc22e';
                        document.getElementById('custom-tile-2048-bg-text').value = themeData.tile2048Bg || '#edc22e';
                        document.getElementById('custom-tile-2048-text').value = themeData.tile2048Text || '#f9f6f2';
                        document.getElementById('custom-tile-2048-text-text').value = themeData.tile2048Text || '#f9f6f2';
                        document.getElementById('custom-tile-4096-bg').value = themeData.tile4096Bg || '#e65100';
                        document.getElementById('custom-tile-4096-bg-text').value = themeData.tile4096Bg || '#e65100';
                        document.getElementById('custom-tile-4096-text').value = themeData.tile4096Text || '#ffffff';
                        document.getElementById('custom-tile-4096-text-text').value = themeData.tile4096Text || '#ffffff';
                        document.getElementById('custom-tile-8192-bg').value = themeData.tile8192Bg || '#bf360c';
                        document.getElementById('custom-tile-8192-bg-text').value = themeData.tile8192Bg || '#bf360c';
                        document.getElementById('custom-tile-8192-text').value = themeData.tile8192Text || '#ffffff';
                        document.getElementById('custom-tile-8192-text-text').value = themeData.tile8192Text || '#ffffff';
                        document.getElementById('custom-tile-16384-bg').value = themeData.tile16384Bg || '#880e4f';
                        document.getElementById('custom-tile-16384-bg-text').value = themeData.tile16384Bg || '#880e4f';
                        document.getElementById('custom-tile-16384-text').value = themeData.tile16384Text || '#ffffff';
                        document.getElementById('custom-tile-16384-text-text').value = themeData.tile16384Text || '#ffffff';
                        document.getElementById('custom-tile-32768-bg').value = themeData.tile32768Bg || '#4a148c';
                        document.getElementById('custom-tile-32768-bg-text').value = themeData.tile32768Bg || '#4a148c';
                        document.getElementById('custom-tile-32768-text').value = themeData.tile32768Text || '#ffffff';
                        document.getElementById('custom-tile-32768-text-text').value = themeData.tile32768Text || '#ffffff';
                        document.getElementById('custom-tile-super-bg').value = themeData.tileSuperBg || '#311b92';
                        document.getElementById('custom-tile-super-bg-text').value = themeData.tileSuperBg || '#311b92';
                        document.getElementById('custom-tile-super-text').value = themeData.tileSuperText || '#ffffff';
                        document.getElementById('custom-tile-super-text-text').value = themeData.tileSuperText || '#ffffff';
                    }
                    return true;
                }
            } catch (e) {
                console.error('加载自定义主题失败:', e);
            }
            return false;
        }
        function applyCustomThemeFromData(themeData) {
            let styleElement = document.getElementById('custom-theme-styles');
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = 'custom-theme-styles';
                document.head.appendChild(styleElement);
            }
            const customStyles = `
                :root {
                    --custom-bg-color: ${themeData.bgColor};
                    --custom-primary-color: ${themeData.primaryColor};
                    --custom-secondary-color: ${themeData.secondaryColor};
                    --custom-grid-color: ${themeData.gridColor};
                    --custom-modal-bg-color: ${themeData.modalBgColor};
                    --custom-modal-text-color: ${themeData.modalTextColor};
                    --custom-tile-2-bg: ${themeData.tile2Bg};
                    --custom-tile-2-text: ${themeData.tile2Text};
                    --custom-tile-4-bg: ${themeData.tile4Bg};
                    --custom-tile-4-text: ${themeData.tile4Text};
                    --custom-tile-8-bg: ${themeData.tile8Bg};
                    --custom-tile-8-text: ${themeData.tile8Text};
                    --custom-tile-16-bg: ${themeData.tile16Bg};
                    --custom-tile-16-text: ${themeData.tile16Text};
                    --custom-tile-32-bg: ${themeData.tile32Bg};
                    --custom-tile-32-text: ${themeData.tile32Text};
                    --custom-tile-64-bg: ${themeData.tile64Bg};
                    --custom-tile-64-text: ${themeData.tile64Text};
                    --custom-tile-128-bg: ${themeData.tile128Bg};
                    --custom-tile-128-text: ${themeData.tile128Text};
                    --custom-tile-256-bg: ${themeData.tile256Bg};
                    --custom-tile-256-text: ${themeData.tile256Text};
                    --custom-tile-512-bg: ${themeData.tile512Bg};
                    --custom-tile-512-text: ${themeData.tile512Text};
                    --custom-tile-1024-bg: ${themeData.tile1024Bg};
                    --custom-tile-1024-text: ${themeData.tile1024Text};
                    --custom-tile-2048-bg: ${themeData.tile2048Bg};
                    --custom-tile-2048-text: ${themeData.tile2048Text};
                    --custom-tile-4096-bg: ${themeData.tile4096Bg};
                    --custom-tile-4096-text: ${themeData.tile4096Text};
                    --custom-tile-8192-bg: ${themeData.tile8192Bg};
                    --custom-tile-8192-text: ${themeData.tile8192Text};
                    --custom-tile-16384-bg: ${themeData.tile16384Bg};
                    --custom-tile-16384-text: ${themeData.tile16384Text};
                    --custom-tile-32768-bg: ${themeData.tile32768Bg};
                    --custom-tile-32768-text: ${themeData.tile32768Text};
                    --custom-tile-super-bg: ${themeData.tileSuperBg};
                    --custom-tile-super-text: ${themeData.tileSuperText};
                }
                body[data-theme="custom"] {
                    background-color: var(--custom-bg-color);
                    color: var(--custom-secondary-color);
                }
                body[data-theme="custom"] .game-header, 
                body[data-theme="custom"] .game-footer {
                    color: var(--custom-secondary-color);
                }
                body[data-theme="custom"] .primary {
                    background-color: var(--custom-primary-color);
                }
                body[data-theme="custom"] .secondary {
                    color: var(--custom-secondary-color);
                }
                body[data-theme="custom"] .game-container {
                    background-color: var(--custom-grid-color);
                }
                body[data-theme="custom"] [role="dialog"] > div {
                    background-color: var(--custom-modal-bg-color) !important;
                    color: var(--custom-modal-text-color) !important;
                }
                body[data-theme="custom"] .tile-2 {
                    background-color: var(--custom-tile-2-bg);
                    color: var(--custom-tile-2-text);
                }
                body[data-theme="custom"] .tile-4 {
                    background-color: var(--custom-tile-4-bg);
                    color: var(--custom-tile-4-text);
                }
                body[data-theme="custom"] .tile-8 {
                    background-color: var(--custom-tile-8-bg);
                    color: var(--custom-tile-8-text);
                }
                body[data-theme="custom"] .tile-16 {
                    background-color: var(--custom-tile-16-bg);
                    color: var(--custom-tile-16-text);
                }
                body[data-theme="custom"] .tile-32 {
                    background-color: var(--custom-tile-32-bg);
                    color: var(--custom-tile-32-text);
                }
                body[data-theme="custom"] .tile-64 {
                    background-color: var(--custom-tile-64-bg);
                    color: var(--custom-tile-64-text);
                }
                body[data-theme="custom"] .tile-128 {
                    background-color: var(--custom-tile-128-bg);
                    color: var(--custom-tile-128-text);
                }
                body[data-theme="custom"] .tile-256 {
                    background-color: var(--custom-tile-256-bg);
                    color: var(--custom-tile-256-text);
                }
                body[data-theme="custom"] .tile-512 {
                    background-color: var(--custom-tile-512-bg);
                    color: var(--custom-tile-512-text);
                }
                body[data-theme="custom"] .tile-1024 {
                    background-color: var(--custom-tile-1024-bg);
                    color: var(--custom-tile-1024-text);
                }
                body[data-theme="custom"] .tile-2048 {
                    background-color: var(--custom-tile-2048-bg);
                    color: var(--custom-tile-2048-text);
                }
                body[data-theme="custom"] .tile-4096 {
                    background-color: var(--custom-tile-4096-bg);
                    color: var(--custom-tile-4096-text);
                }
                body[data-theme="custom"] .tile-8192 {
                    background-color: var(--custom-tile-8192-bg);
                    color: var(--custom-tile-8192-text);
                }
                body[data-theme="custom"] .tile-16384 {
                    background-color: var(--custom-tile-16384-bg);
                    color: var(--custom-tile-16384-text);
                }
                body[data-theme="custom"] .tile-32768 {
                    background-color: var(--custom-tile-32768-bg);
                    color: var(--custom-tile-32768-text);
                }
                body[data-theme="custom"] .tile-super {
                    background-color: var(--custom-tile-super-bg);
                    color: var(--custom-tile-super-text);
                }
            `;
            styleElement.textContent = customStyles;
            document.body.setAttribute('data-theme', 'custom');
            if (elements && elements.themeToggle && elements.themeToggle.querySelector('i')) {
                elements.themeToggle.querySelector('i').className = 'fa-solid fa-palette';
            }
        }
        function loadGameState() {
            const savedState = localStorage.getItem('2048-game-state');
            const savedTheme = localStorage.getItem('2048-theme');
            if (window.themeMediaQueryListener) {
                window.themeMediaQueryListener.mediaQuery.removeEventListener('change', window.themeMediaQueryListener.handler);
                window.themeMediaQueryListener = null;
            }
            if (savedTheme === 'auto') {
                const themeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                const updateTheme = (e) => {
                    document.documentElement.classList.toggle('dark', e.matches);
                };
                themeMediaQuery.addEventListener('change', updateTheme);
                updateTheme(themeMediaQuery);
                window.themeMediaQueryListener = {
                    mediaQuery: themeMediaQuery,
                    handler: updateTheme
                };
                elements.themeToggle.value = 'auto';
                document.getElementById('custom-theme-button').style.display = 'none';
                document.getElementById('custom-theme-button-container').classList.remove('mb-2');
            } else if (savedTheme === 'custom') {
                elements.themeToggle.value = 'custom';
                document.getElementById('custom-theme-button').style.display = 'block';
                document.getElementById('custom-theme-button-container').classList.add('mb-2');
            } else if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                elements.themeToggle.value = 'dark';
                document.getElementById('custom-theme-button').style.display = 'none';
                document.getElementById('custom-theme-button-container').classList.remove('mb-2');
            } else {
                document.getElementById('custom-theme-button').style.display = 'none';
                const themeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                const updateTheme = (e) => {
                    document.documentElement.classList.toggle('dark', e.matches);
                };
                themeMediaQuery.addEventListener('change', updateTheme);
                updateTheme(themeMediaQuery);
                window.themeMediaQueryListener = {
                    mediaQuery: themeMediaQuery,
                    handler: updateTheme
                };
                elements.themeToggle.value = 'auto';
            }
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    gameState.grid = state.grid || createEmptyGrid();
                    gameState.gridSize = state.gridSize || 4;
                    gameState.gridRows = state.gridRows || state.gridSize || 4;
                    gameState.gridCols = state.gridCols || state.gridSize || 4;
                    gameState.score = state.score || 0;
                    gameState.bestScore = state.bestScore || 0;
                    gameState.gameOver = state.gameOver || false;
                    gameState.gameWon = state.gameWon || false;
                    gameState.isEndlessMode = state.isEndlessMode || false;
                    gameState.difficulty = state.difficulty || 'medium';
                    gameState.history = state.history || [];
                    elements.scoreDisplay.textContent = gameState.score;
                    elements.bestScoreDisplay.textContent = gameState.bestScore;
                    document.querySelector('.game-container').classList.remove('grid-3x3', 'grid-4x4', 'grid-5x5');
                    document.querySelector('.game-container').classList.add(`grid-${gameState.gridRows}x${gameState.gridCols}`);
                    generateGridStyles(null, gameState.gridRows, gameState.gridCols);
                    initGridContainer();
                    renderAllTiles();
                    updateDifficultyButtons();
                    updateGridButtonState(Math.max(gameState.gridRows, gameState.gridCols));
                    elements.modeDescription.textContent = gameState.isEndlessMode 
                        ? "当前模式：无尽模式 - 尽可能获得高分" 
                        : "当前模式：标准模式 - 达到2048获胜";
                    elements.difficultyDescription.textContent = `当前难度：${getDifficultyName()} - ${gameState.gridRows}×${gameState.gridCols}网格`;
                    if (gameState.gameOver) {
                        showGameMessage("游戏结束！", "无法进行任何移动。");
                    } else if (gameState.gameWon && !gameState.isEndlessMode) {
                        showGameMessage("恭喜你获胜！", "你达到了2048分，可以继续游戏挑战更高分数，或者重新开始。");
                    }
                } catch (e) {
                    console.error("Failed to load saved game state:", e);
                    initGame(false, 4, 4);
                }
            } else {
                initGame(false, 4, 4);
            }
            updateDocumentTitle();
            updateUndoButtonState();
        }
        function startGame() {
            loadGameState();
            initEventListeners();
            handleResize();
        }
        startGame();
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const customSelect = document.querySelector('.custom-select');
            const selectedValue = document.querySelector('.select-selected span');
            const selectItems = document.querySelector('.select-items');
            const selectOptions = document.querySelectorAll('.select-item');
            const nativeSelect = document.getElementById('theme-toggle');
            selectedValue.textContent = nativeSelect.options[nativeSelect.selectedIndex].text;
            selectOptions.forEach(option => {
                if (option.getAttribute('data-value') === nativeSelect.value) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
            selectItems.classList.add('hidden');
            selectItems.style.maxHeight = null;
            selectItems.style.opacity = '0';
            customSelect.addEventListener('click', function(e) {
                e.stopPropagation();
                const selectSelected = this.querySelector('.select-selected');
                if (selectItems.style.maxHeight) {
                    selectItems.style.maxHeight = null;
                    selectItems.style.opacity = '0';
                    selectSelected.classList.remove('active');
                    setTimeout(() => selectItems.classList.add('hidden'), 300);
                } else {
                    selectItems.classList.remove('hidden');
                    selectSelected.classList.add('active');
                    setTimeout(() => {
                        selectItems.style.maxHeight = "200px";
                        selectItems.style.opacity = '1';
                    }, 10);
                }
            });
            selectOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    const text = this.textContent;
                    selectedValue.textContent = text;
                    nativeSelect.value = value;
                    nativeSelect.dispatchEvent(new Event('change'));
                    selectOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectItems.classList.add('hidden');
                });
            });
            document.addEventListener('click', function() {
                const selectSelected = document.querySelector('.select-selected');
                if (selectItems.style.maxHeight) {
                    selectItems.style.maxHeight = null;
                    selectItems.style.opacity = '0';
                    selectSelected.classList.remove('active');
                    setTimeout(() => selectItems.classList.add('hidden'), 300);
                }
            });
            nativeSelect.addEventListener('change', function() {
                selectedValue.textContent = this.options[this.selectedIndex].text;
            });
        });
    </script>
        <div id="ai-analysis-modal" class="ai-analysis-modal hidden" role="dialog" aria-labelledby="ai-analysis-modal-title" aria-modal="true">
            <div class="ai-analysis-content max-h-[90vh] overflow-y-auto transition-all duration-300 ease-in-out">
                <div id="ai-analysis-modal-title" class="ai-analysis-title">
                    AI游戏分析
                    <button id="close-ai-modal" class="text-secondary/60 hover:text-secondary focus:outline-none absolute top-0 right-4 text-xl dark:text-dark-muted dark:hover:text-white" title="关闭AI分析">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
                <div class="analysis-item">
                    <div class="flex items-center justify-between">
                        <div class="analysis-label flex items-center">
                            当前最佳移动方向
                            <button id="toggle-best-move" class="text-secondary/60 hover:text-secondary focus:outline-none text-sm ml-2 dark:text-dark-muted dark:hover:text-white" title="隐藏/显示最佳移动方向">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div id="best-move-direction" class="analysis-value best-move w-full">
                        <span class="best-move-text">--</span>
                    </div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-label">潜在合并机会</div>
                    <div id="merge-opportunities" class="analysis-value">--</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-label">游戏状态评估</div>
                    <div id="game-state-assessment" class="analysis-value">--</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-label">得分潜力分析</div>
                    <div id="score-potential" class="analysis-value">--</div>
                </div>
                <div id="ai-analysis-overlay" class="hidden absolute inset-x-0 top-16 bottom-0 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm flex items-center justify-center rounded-b-lg">
                    <div class="text-center">
                        <i class="fa-solid fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
                        <p class="text-lg font-semibold text-gray-800 dark:text-gray-200">暂不支持</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">AI分析功能仅支持3×3、4×4、5×5网格</p>
                    </div>
                </div>
            </div>
        </main>
        <script>
        function analyzeGameState() {
            const modal = document.getElementById('ai-analysis-modal');
            const overlay = document.getElementById('ai-analysis-overlay');
            const isStandardGrid = (gameState.gridRows === gameState.gridCols) && 
                                   (gameState.gridRows >= 3 && gameState.gridRows <= 5);
            if (!isStandardGrid) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.add('opacity-100', 'scale-100');
                    modal.classList.remove('opacity-0', 'scale-95');
                }, 10);
                overlay.classList.remove('hidden');
                return;
            }
            overlay.classList.add('hidden');
            const directions = ['up', 'down', 'left', 'right'];
            const directionNames = {
                up: '向上', 
                down: '向下', 
                left: '向左', 
                right: '向右'
            };
            let bestScore = -1;
            let bestDirection = 'up';
            let mergeOpportunities = 0;
            const gridCopy = JSON.parse(JSON.stringify(gameState.grid));
            const originalScore = gameState.score;
            const gridSize = gameState.gridSize;
            let scoreDiffWeight, emptyCellsWeight, mergesWeight, positionWeight, maxValueWeight, continuityWeight, uniformityWeight, blockWeight, multiStepWeight, monotonicityWeight;
            let dangerThreshold, warningThreshold;
            let highPotentialThreshold, mediumPotentialThreshold;
            let directionPriority = {up: 1, down: 1, left: 1, right: 1};
            if (gridSize === 3) {
                scoreDiffWeight = 0.2;
                emptyCellsWeight = 0.18;
                mergesWeight = 0.15;
                positionWeight = 0.1;
                maxValueWeight = 0.1;
                continuityWeight = 0.05;
                uniformityWeight = 0.05;
                blockWeight = 0.05;
                multiStepWeight = 0.1;
                monotonicityWeight = 0.02;
                directionPriority = {up: 1.1, down: 0.9, left: 1, right: 1};
                dangerThreshold = 2;
                warningThreshold = 4;
                highPotentialThreshold = 2;
                mediumPotentialThreshold = 1;
            } else if (gridSize === 4) {
                scoreDiffWeight = 0.25;
                emptyCellsWeight = 0.15;
                mergesWeight = 0.15;
                positionWeight = 0.1;
                maxValueWeight = 0.1;
                continuityWeight = 0.05;
                uniformityWeight = 0.05;
                blockWeight = 0.05;
                multiStepWeight = 0.08;
                monotonicityWeight = 0.02;
                directionPriority = {up: 1.1, down: 0.9, left: 1, right: 1};
                dangerThreshold = 3;
                warningThreshold = 6;
                highPotentialThreshold = 3;
                mediumPotentialThreshold = 1;
            } else {
                scoreDiffWeight = 0.3;
                emptyCellsWeight = 0.12;
                mergesWeight = 0.15;
                positionWeight = 0.1;
                maxValueWeight = 0.1;
                continuityWeight = 0.05;
                uniformityWeight = 0.05;
                blockWeight = 0.03;
                multiStepWeight = 0.07;
                monotonicityWeight = 0.03;
                directionPriority = {up: 1, down: 1, left: 1, right: 1};
                dangerThreshold = 5;
                warningThreshold = 10;
                highPotentialThreshold = 4;
                mediumPotentialThreshold = 2;
            }
            directions.forEach(direction => {
                const simulatedState = {
                    grid: JSON.parse(JSON.stringify(gridCopy)),
                    score: originalScore,
                    gridSize: gridSize
                };
                if (simulateMove(simulatedState, direction)) {
                    const scoreDiff = simulatedState.score - originalScore;
                    const newEmptyCells = countEmptyCells(simulatedState.grid);
                    const newMerges = countMergeOpportunities(simulatedState.grid);
                    const positionScore = calculatePositionScore(simulatedState.grid, gridSize);
                    const maxValueScore = calculateMaxValueScore(simulatedState.grid);
                    const continuityScore = calculateContinuityScore(simulatedState.grid, gridSize);
                    const uniformityScore = calculateUniformityScore(simulatedState.grid, gridSize);
                    const blockScore = calculateBlockScore(simulatedState.grid, gridSize, direction);
                    const monotonicityScore = calculateMonotonicityScore(simulatedState.grid, gridSize);
                    const multiStepScore = calculateMultiStepScore(simulatedState, direction);
                    const compositeScore = (scoreDiff * scoreDiffWeight + newEmptyCells * emptyCellsWeight + newMerges * mergesWeight + positionScore * positionWeight + maxValueScore * maxValueWeight + continuityScore * continuityWeight + uniformityScore * uniformityWeight + blockScore * blockWeight + monotonicityScore * monotonicityWeight + multiStepScore * multiStepWeight) * directionPriority[direction];
                    if (compositeScore > bestScore) {
                        bestScore = compositeScore;
                        bestDirection = direction;
                    }
                }
            });
            mergeOpportunities = countMergeOpportunities(gridCopy);
            const emptyCells = countEmptyCells(gridCopy);
            let gameStateAssessment = '良好';
            if (emptyCells < dangerThreshold) gameStateAssessment = '危险';
            else if (emptyCells < warningThreshold) gameStateAssessment = '一般';
            let scorePotential = '低';
            if (mergeOpportunities >= highPotentialThreshold) scorePotential = '高';
            else if (mergeOpportunities >= mediumPotentialThreshold) scorePotential = '中';
            const bestMoveText = document.querySelector('#best-move-direction .best-move-text');
            if (bestMoveText) {
                bestMoveText.textContent = directionNames[bestDirection];
            } else {
                document.getElementById('best-move-direction').innerHTML = `<span class="best-move-text">${directionNames[bestDirection]}</span>`;
            }
            const mergeOpportunitiesElement = document.getElementById('merge-opportunities');
            mergeOpportunitiesElement.textContent = `${mergeOpportunities}处`;
            mergeOpportunitiesElement.className = 'analysis-value';
            if (mergeOpportunities >= 3) {
                mergeOpportunitiesElement.classList.add('high');
            } else if (mergeOpportunities >= 1) {
                mergeOpportunitiesElement.classList.add('medium');
            } else {
                mergeOpportunitiesElement.classList.add('low');
            }
            const gameStateElement = document.getElementById('game-state-assessment');
            gameStateElement.textContent = gameStateAssessment;
            gameStateElement.className = 'analysis-value';
            if (gameStateAssessment === '良好') {
                gameStateElement.classList.add('good');
            } else if (gameStateAssessment === '一般') {
                gameStateElement.classList.add('average');
            } else {
                gameStateElement.classList.add('danger');
            }
            const scorePotentialElement = document.getElementById('score-potential');
            scorePotentialElement.textContent = `${scorePotential} (${
                scorePotential === '高' ? '预计可合并多个高价值方块' : 
                scorePotential === '中' ? '有一定合并机会' : 
                '合并机会有限'
            })`;
            scorePotentialElement.className = 'analysis-value';
            if (scorePotential === '高') {
                scorePotentialElement.classList.add('high');
            } else if (scorePotential === '中') {
                scorePotentialElement.classList.add('medium');
            } else {
                scorePotentialElement.classList.add('low');
            }
            document.getElementById('ai-analysis-modal').classList.remove('hidden');
        }
        function simulateMove(state, direction) {
            let moved = false;
            state.grid = JSON.parse(JSON.stringify(state.grid));
            for (let y = 0; y < state.gridSize; y++) {
                for (let x = 0; x < state.gridSize; x++) {
                    if (state.grid[y][x]) {
                        state.grid[y][x].merged = false;
                    }
                }
            }
            switch (direction) {
                case 'up':
                    for (let x = 0; x < state.gridSize; x++) {
                        for (let y = 1; y < state.gridSize; y++) {
                            if (state.grid[y][x]) {
                                let newY = y;
                                while (newY > 0 && state.grid[newY - 1][x] === null) {
                                    newY--;
                                }
                                if (newY > 0 && state.grid[newY - 1][x] && 
                                    state.grid[newY - 1][x].value === state.grid[y][x].value && 
                                    !state.grid[newY - 1][x].merged) {
                                    state.grid[newY - 1][x].value *= 2;
                                    state.grid[newY - 1][x].merged = true;
                                    state.grid[y][x] = null;
                                    state.score += state.grid[newY - 1][x].value;
                                    moved = true;
                                } else if (newY !== y) {
                                    state.grid[newY][x] = state.grid[y][x];
                                    state.grid[y][x] = null;
                                    moved = true;
                                }
                            }
                        }
                    }
                    break;
                case 'down':
                    for (let x = 0; x < state.gridSize; x++) {
                        for (let y = state.gridSize - 2; y >= 0; y--) {
                            if (state.grid[y][x]) {
                                let newY = y;
                                while (newY < state.gridSize - 1 && state.grid[newY + 1][x] === null) {
                                    newY++;
                                }
                                if (newY < state.gridSize - 1 && state.grid[newY + 1][x] && 
                                    state.grid[newY + 1][x].value === state.grid[y][x].value && 
                                    !state.grid[newY + 1][x].merged) {
                                    state.grid[newY + 1][x].value *= 2;
                                    state.grid[newY + 1][x].merged = true;
                                    state.grid[y][x] = null;
                                    state.score += state.grid[newY + 1][x].value;
                                    moved = true;
                                } else if (newY !== y) {
                                    state.grid[newY][x] = state.grid[y][x];
                                    state.grid[y][x] = null;
                                    moved = true;
                                }
                            }
                        }
                    }
                    break;
                case 'left':
                    for (let y = 0; y < state.gridSize; y++) {
                        for (let x = 1; x < state.gridSize; x++) {
                            if (state.grid[y][x]) {
                                let newX = x;
                                while (newX > 0 && state.grid[y][newX - 1] === null) {
                                    newX--;
                                }
                                if (newX > 0 && state.grid[y][newX - 1] && 
                                    state.grid[y][newX - 1].value === state.grid[y][x].value && 
                                    !state.grid[y][newX - 1].merged) {
                                    state.grid[y][newX - 1].value *= 2;
                                    state.grid[y][newX - 1].merged = true;
                                    state.grid[y][x] = null;
                                    state.score += state.grid[y][newX - 1].value;
                                    moved = true;
                                } else if (newX !== x) {
                                    state.grid[y][newX] = state.grid[y][x];
                                    state.grid[y][x] = null;
                                    moved = true;
                                }
                            }
                        }
                    }
                    break;
                case 'right':
                    for (let y = 0; y < state.gridSize; y++) {
                        for (let x = state.gridSize - 2; x >= 0; x--) {
                            if (state.grid[y][x]) {
                                let newX = x;
                                while (newX < state.gridSize - 1 && state.grid[y][newX + 1] === null) {
                                    newX++;
                                }
                                if (newX < state.gridSize - 1 && state.grid[y][newX + 1] && 
                                    state.grid[y][newX + 1].value === state.grid[y][x].value && 
                                    !state.grid[y][newX + 1].merged) {
                                    state.grid[y][newX + 1].value *= 2;
                                    state.grid[y][newX + 1].merged = true;
                                    state.grid[y][x] = null;
                                    state.score += state.grid[y][newX + 1].value;
                                    moved = true;
                                } else if (newX !== x) {
                                    state.grid[y][newX] = state.grid[y][x];
                                    state.grid[y][x] = null;
                                    moved = true;
                                }
                            }
                        }
                    }
                    break;
            }
            return moved;
        }
        function calculatePositionScore(grid, gridSize) {
                let score = 0;
                let maxValue = 0;
                let maxValuePos = {x: 0, y: 0};
                for (let y = 0; y < gridSize; y++) {
                    for (let x = 0; x < gridSize; x++) {
                        if (grid[y][x] && grid[y][x].value > maxValue) {
                            maxValue = grid[y][x].value;
                            maxValuePos = {x, y};
                        }
                    }
                }
                if (maxValue > 0) {
                    const cornerDistance = Math.min(maxValuePos.x + maxValuePos.y,(gridSize - 1 - maxValuePos.x) + maxValuePos.y,maxValuePos.x + (gridSize - 1 - maxValuePos.y),(gridSize - 1 - maxValuePos.x) + (gridSize - 1 - maxValuePos.y));
                    score = (gridSize - cornerDistance) / gridSize * 10;
                }
                return score;
            }
            function calculateMaxValueScore(grid) {
                let maxValue = 0;
                let secondMaxValue = 0;
                for (let y = 0; y < grid.length; y++) {
                    for (let x = 0; x < grid[y].length; x++) {
                        if (grid[y][x]) {
                            if (grid[y][x].value > maxValue) {
                                secondMaxValue = maxValue;
                                maxValue = grid[y][x].value;
                            } else if (grid[y][x].value > secondMaxValue) {
                                secondMaxValue = grid[y][x].value;
                            }
                        }
                    }
                }
                if (maxValue === 0) return 0;
                const ratio = secondMaxValue / maxValue;
                return ratio * 5;
            }
            function countMergeOpportunities(grid) {
                let count = 0;
                const size = grid.length;
                for (let y = 0; y < size; y++) {
                    for (let x = 0; x < size - 1; x++) {
                        if (grid[y][x] && grid[y][x+1] && grid[y][x].value === grid[y][x+1].value) {
                            count++;
                            const power = Math.log2(grid[y][x].value);
                            if (power >= 10) count += 0.5;
                            else if (power >= 8) count += 0.3;
                        }
                    }
                }
                for (let x = 0; x < size; x++) {
                    for (let y = 0; y < size - 1; y++) {
                        if (grid[y][x] && grid[y+1][x] && grid[y][x].value === grid[y+1][x].value) {
                            count++;
                            const power = Math.log2(grid[y][x].value);
                            if (power >= 10) count += 0.5;
                            else if (power >= 8) count += 0.3;
                        }
                    }
                }
                return count;
            }
            function calculateContinuityScore(grid, gridSize) {
                let score = 0;
                for (let y = 0; y < gridSize; y++) {
                    for (let x = 0; x < gridSize - 2; x++) {
                        if (grid[y][x] && grid[y][x+1] && grid[y][x+2] && grid[y][x].value === grid[y][x+1].value && grid[y][x+1].value === grid[y][x+2].value) {
                            score += 2;
                            const power = Math.log2(grid[y][x].value);
                            if (power >= 8) score += 1;
                        }
                    }
                }
                for (let x = 0; x < gridSize; x++) {
                    for (let y = 0; y < gridSize - 2; y++) {
                        if (grid[y][x] && grid[y+1][x] && grid[y+2][x] && grid[y][x].value === grid[y+1][x].value && grid[y+1][x].value === grid[y+2][x].value) {
                            score += 2;
                            const power = Math.log2(grid[y][x].value);
                            if (power >= 8) score += 1;
                        }
                    }
                }
                return score;
            }
            function calculateUniformityScore(grid, gridSize) {
                let values = [];
                for (let y = 0; y < gridSize; y++) {
                    for (let x = 0; x < gridSize; x++) {
                        if (grid[y][x]) {
                            values.push(grid[y][x].value);
                        }
                    }
                }
        if (values.length === 0) return 10;
        const avgValue = values.reduce((a, b) => a + b, 0) / values.length;
        const variance = values.reduce((a, b) => a + Math.pow(b - avgValue, 2), 0) / values.length;
        const stdDev = Math.sqrt(variance);
        const uniformity = 10 - Math.min(stdDev / avgValue * 10, 9);
        return uniformity;
    }
    function calculateBlockScore(grid, gridSize, direction) {
        let blockCount = 0;
        for (let y = 0; y < gridSize; y++) {
            for (let x = 0; x < gridSize; x++) {
                if (grid[y][x]) {
                    switch (direction) {
                        case 'up':
                            if (y > 0 && grid[y-1][x] && grid[y-1][x].value > grid[y][x].value) {
                                blockCount++;
                            }
                            break;
                        case 'down':
                            if (y < gridSize-1 && grid[y+1][x] && grid[y+1][x].value > grid[y][x].value) {
                                blockCount++;
                            }
                            break;
                        case 'left':
                            if (x > 0 && grid[y][x-1] && grid[y][x-1].value > grid[y][x].value) {
                                blockCount++;
                            }
                            break;
                        case 'right':
                            if (x < gridSize-1 && grid[y][x+1] && grid[y][x+1].value > grid[y][x].value) {
                                blockCount++;
                            }
                            break;
                    }
                }
            }
        }
        const maxPossibleBlocks = gridSize * (gridSize - 1);
        return 10 - (blockCount / maxPossibleBlocks * 10);
    }
    function calculateMultiStepScore(state, initialDirection) {
        return minimaxSearch(state, 3, -Infinity, Infinity, true);
    }
    function minimaxSearch(state, depth, alpha, beta, isMaximizingPlayer) {
        if (depth === 0) {
            const emptyCells = countEmptyCells(state.grid);
            const merges = countMergeOpportunities(state.grid);
            const positionScore = calculatePositionScore(state.grid, state.gridSize);
            const uniformityScore = calculateUniformityScore(state.grid, state.gridSize);
            return (emptyCells * 2 + merges * 3 + positionScore + uniformityScore) / 10;
        }
        const directions = ['up', 'down', 'left', 'right'];
        if (isMaximizingPlayer) {
            let maxScore = -Infinity;
            directions.forEach(direction => {
                const newState = {
                    grid: JSON.parse(JSON.stringify(state.grid)),
                    score: state.score,
                    gridSize: state.gridSize
                };
                if (simulateMove(newState, direction)) {
                    const score = minimaxSearch(newState, depth - 1, alpha, beta, false);
                    maxScore = Math.max(maxScore, score);
                    alpha = Math.max(alpha, score);
                    if (beta <= alpha) return maxScore;
                }
            });
            return maxScore;
        } else {
            let minScore = Infinity;
            const emptyPositions = [];
            for (let y = 0; y < state.gridSize; y++) {
                for (let x = 0; x < state.gridSize; x++) {
                    if (!state.grid[y][x]) {
                        emptyPositions.push({x, y});
                    }
                }
            }
            if (emptyPositions.length === 0) return 0;
            const randomPos = emptyPositions[Math.floor(Math.random() * emptyPositions.length)];
            const newState = {
                grid: JSON.parse(JSON.stringify(state.grid)),
                score: state.score,
                gridSize: state.gridSize
            };
            newState.grid[randomPos.y][randomPos.x] = {
                value: Math.random() < 0.9 ? 2 : 4,
                merged: false
            };
            const score = minimaxSearch(newState, depth - 1, alpha, beta, true);
            minScore = Math.min(minScore, score);
            beta = Math.min(beta, score);
            if (beta <= alpha) return minScore;
            return minScore;
        }
    }
    function calculateMonotonicityScore(grid, gridSize) {
        let score = 0;
        for (let y = 0; y < gridSize; y++) {
            let rowIncreasing = true;
            let rowDecreasing = true;
            for (let x = 0; x < gridSize - 1; x++) {
                const curr = grid[y][x] ? grid[y][x].value : 0;
                const next = grid[y][x+1] ? grid[y][x+1].value : 0;
                rowIncreasing = rowIncreasing && (curr <= next);
                rowDecreasing = rowDecreasing && (curr >= next);
            }
            score += rowIncreasing || rowDecreasing ? 2 : 0;
        }
        for (let x = 0; x < gridSize; x++) {
            let colIncreasing = true;
            let colDecreasing = true;
            for (let y = 0; y < gridSize - 1; y++) {
                const curr = grid[y][x] ? grid[y][x].value : 0;
                const next = grid[y+1][x] ? grid[y+1][x].value : 0;
                colIncreasing = colIncreasing && (curr <= next);
                colDecreasing = colDecreasing && (curr >= next);
            }
            score += colIncreasing || colDecreasing ? 2 : 0;
        }
        return score / (2 * gridSize) * 10;
    }
    function countEmptyCells(grid) {
        let count = 0;
        for (let y = 0; y < grid.length; y++) {
            for (let x = 0; x < grid[y].length; x++) {
                if (!grid[y][x]) count++;
            }
        }
        return count;
    }
    document.getElementById('ai-analysis-button').addEventListener('click', analyzeGameState);
        document.getElementById('close-ai-modal').addEventListener('click', function() {
            document.getElementById('ai-analysis-modal').classList.add('hidden');
        });
        const bestMoveText = document.querySelector('#best-move-direction .best-move-text');
        const toggleButton = document.getElementById('toggle-best-move');
        const iconElement = toggleButton.querySelector('i');
        const isBestMoveHidden = localStorage.getItem('bestMoveHidden') === 'true';
        if (isBestMoveHidden) {
            bestMoveText.classList.add('blur-sm');
            iconElement.className = 'fa-solid fa-eye-slash';
            toggleButton.setAttribute('title', '显示最佳移动方向');
        } else {
            bestMoveText.classList.remove('blur-sm');
            iconElement.className = 'fa-solid fa-eye';
            toggleButton.setAttribute('title', '隐藏最佳移动方向');
        }
        toggleButton.addEventListener('click', function() {
            if (bestMoveText.classList.contains('blur-sm')) {
                bestMoveText.classList.remove('blur-sm');
                iconElement.className = 'fa-solid fa-eye';
                this.setAttribute('title', '隐藏最佳移动方向');
                localStorage.setItem('bestMoveHidden', 'false');
            } else {
                bestMoveText.classList.add('blur-sm');
                iconElement.className = 'fa-solid fa-eye-slash';
                this.setAttribute('title', '显示最佳移动方向');
                localStorage.setItem('bestMoveHidden', 'true');
            }
        });
        document.getElementById('ai-analysis-modal').addEventListener('click', function(e) {
            if (e.target === this) this.classList.add('hidden');
        });
    </script>
</body>
</html>